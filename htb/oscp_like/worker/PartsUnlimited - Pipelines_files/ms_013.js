"use strict";define("Build/SourceProviders",["require","exports","VSS/Core/Util/String","VSS/Platform/Trace","VSS/Platform/Context"],function(e,t,r,i,n){var o,s,a,c,u,l,m,h,p,g,y,_,f,d;o=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.CommitId="commit {0}",s=t.Common={},Object.defineProperty(t,"__esModule",{value:!0}),(d=t.Common.RepositoryTypes||(t.Common.RepositoryTypes={})).TfsVersionControl="TfsVersionControl".toLowerCase(),d.TfsGit="TfsGit".toLowerCase(),d.ExternalUnknown="ExternalUnknown".toLowerCase(),d.ExternalGit="Git".toLowerCase(),d.GitHub="GitHub".toLowerCase(),d.GitHubEnterprise="GitHubEnterprise".toLowerCase(),d.Bitbucket="Bitbucket".toLowerCase(),d.Svn="Svn".toLowerCase(),function(e){a=t.Base={},Object.defineProperty(t,"__esModule",{value:!0});t.Base.Base=class{constructor(e){this.pageContext=e,this.emptyNullPromise=Promise.resolve(null)}getRepoIconName(){return""}getNormalizedBranch(e,t){return e}getNormalizedCommit(e){return e}getCommitIconName(){return"BranchCommit"}getProjectName(e){return this.emptyNullPromise}fetchBranchLink(e,t){return this.emptyNullPromise}fetchContentLinks(e){return this.emptyNullPromise}fetchContentLink(e){return this.emptyNullPromise}fetchRepositoryLink(e,t){return this.emptyNullPromise}fetchPRCommitLink(e,t){return this.emptyNullPromise}fetchCommitDiffLink(e,t){return this.emptyNullPromise}fetchLinks(e){return this.vcNavigationService.then(t=>{let r=[];return(e||[]).forEach(e=>{r.push({originalId:e.commitId,commitId:this.getCommitText(e.commitId),branchLink:this._getBranchLink({branchName:e.branchName,links:e.links,repositoryName:e.repositoryName,repositoryUrl:e.repositoryUrl},t,e.projectName),commitLink:this._getCommitLink({commitId:e.commitId,displayUri:e.displayUri,repositoryName:e.repositoryName},t,e.projectName),repositoryLink:this._getRepositoryLink({repositoryName:e.repositoryName,repositoryUrl:e.repositoryUrl},t,e.projectName)})}),r})}fetchPullrequestData(e){return this.emptyNullPromise}getBranchText(e){return e}getBranchIconName(e){return"OpenSource"}fetchCommitLink(e,t){return this.emptyNullPromise}getCommitText(e){return e||""}getMaxWorkItems(){}fetchShelvesets(e){return Promise.resolve([])}get vcNavigationService(){return this._vcNavigationService||(this._vcNavigationService=this.getVcCode().then(()=>this.pageContext.getService("IVCNavigationService"))),this._vcNavigationService}getVcCode(){if(!this._vcContributionPromise){const e=this.pageContext.getService("IVssContributionService");this._vcContributionPromise=e.getContributionAsync("ms.vss-code-web.common-content")}return this._vcContributionPromise}_getBuildClient(){return this._buildClient||(this._buildClient=this.pageContext.getRestClient("IBuildRestClient")),this._buildClient}_getBranchLink(e,t,r){return""}_getCommitLink(e,t,r){return""}_getRepositoryLink(e,t,r){return""}}}(),function(e){c=t.BaseGit={},Object.defineProperty(t,"__esModule",{value:!0});t.BaseGit.BaseGit=class extends a.Base{getRepoIconName(){return"ExternalGit"}getBranchText(e){if(r.startsWith(e,"refs/pull/")){const t=this._getPullRequestId(e);if(t)return t.toString()}return this._normalizeBranchName(e)}getBranchIconName(e){return r.startsWith(e,"refs/pull/")?"BranchPullRequest":super.getBranchIconName(e)}getCommitText(e){return e?e.slice(0,7):""}fetchPullrequestData(e){if(e.pullRequestNumber)return this._queryPullRequest(e,e.pullRequestNumber);const t=this._getPullRequestId(e.branchName);return void 0!==t?this._queryPullRequest(e,t.toString()):Promise.resolve(null)}_getPullRequestId(e){if(0===(e=e||"").indexOf("refs/pull/")){const t=e.substring("refs/pull/".length).trim().split("/",2);if(2!==t.length)return;if("merge"!==t[1].trim().toLowerCase())return;const r=parseInt(t[0].trim());if(!isNaN(r))return r}}_normalizeBranchName(e){return r.startsWith(e,"refs/heads/")?e.substring("refs/heads/".length):r.startsWith(e,"refs/tags/")?e.substring("refs/tags/".length):e}_queryPullRequest(e,t){return this._getBuildClient().getPullRequest(e.projectId,this.getKey(),t,e.repositoryName,e.serviceEndpointId).then(e=>({id:parseInt(e.id,10),title:e.title,sourceRepositoryOwner:e.sourceRepositoryOwner,sourceBranch:this.getBranchText(e.sourceBranchRef),targetRepositoryOwner:e.targetRepositoryOwner,targetBranch:this.getBranchText(e.targetBranchRef),rawSourceBranch:e.sourceBranchRef,rawTargetBranch:e.targetBranchRef,url:e._links.web.href}))}}}(),function(e){u=t.ExternalUnknown={},Object.defineProperty(t,"__esModule",{value:!0});t.ExternalUnknown.ExternalUnknown=class extends a.Base{getKey(){return s.RepositoryTypes.ExternalUnknown}fetchBranchLink(e){return Promise.resolve(this._getBranchLink(e))}fetchCommitLink(e){return Promise.resolve(this._getCommitLink(e))}getBranchLink(e){return this._getBranchLink(e)}getCommitLink(e){return this._getCommitLink(e)}_getBranchLink(e,t){if(e.links){const t=e.links.sourceVersionDisplayUri;if(t&&t.href)return t.href}return""}_getCommitLink(e,t){return e.displayUri?e.displayUri:""}}}(),l=t.TraceNames={},Object.defineProperty(t,"__esModule",{value:!0}),t.TraceNames.area="vss-build-web.common.sourceproviders",function(e){m=t.Bitbucket={},Object.defineProperty(t,"__esModule",{value:!0});class r extends c.BaseGit{constructor(e){super(e),this._externalRepo=new u.ExternalUnknown(e)}getKey(){return s.RepositoryTypes.Bitbucket}getRepoIconName(){return"BitbucketLogo32"}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryLinkInternal(e.repositoryName))}fetchBranchLink(e,t){return Promise.resolve(this._getBranchLinkInternal(e))}fetchCommitLink(e,t){return Promise.resolve(this._getCommitLinkInternal(e))}_getRepositoryLink(e,t){return this._getRepositoryLinkInternal(e.repositoryName)}_getBranchLink(e,t){return this._getBranchLinkInternal(e)}_getCommitLink(e,t){return this._externalRepo.getCommitLink(e)}_getRepositoryLinkInternal(e){if(!e)return console.error("Name is required to create a link to the repository"),"";e.indexOf("bitbucket.org")>0&&i.traceWarning(this.pageContext,l.area,"Bitbucket","Data shape issue: repositoryName may be a URL");const t=e.split("/",3);return 2===t.length&&t[0]&&t[1]?`${r.s_BitbucketPrefix}/${e}`:(console.error(`Repository name "${e}" is not in the expected format ("user/repository")`),"")}_getBranchLinkInternal(e){if(e.repositoryName&&e.branchName){const t=this._normalizeBranchName(e.branchName);return`${this._getRepositoryLinkInternal(e.repositoryName)}/branch/${t}`}return this._externalRepo.getBranchLink(e)}_getCommitLinkInternal(e){return e.repositoryName&&e.commitId?`${this._getRepositoryLinkInternal(e.repositoryName)}/commits/${e.commitId}`:this._externalRepo.fetchCommitLink(e)}}r.s_BitbucketPrefix="https://bitbucket.org",t.Bitbucket.Bitbucket=r}(),function(e){h=t.ExternalGit={},Object.defineProperty(t,"__esModule",{value:!0});t.ExternalGit.ExternalGit=class extends c.BaseGit{getKey(){return s.RepositoryTypes.ExternalGit}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryLinkInternal(e.repositoryId))}_getRepositoryLink(e,t){return this._getRepositoryLinkInternal(e.repositoryId)}_getRepositoryLinkInternal(e){return e||""}}}(),function(e){p=t.GitHub={},Object.defineProperty(t,"__esModule",{value:!0});class r extends c.BaseGit{constructor(e){super(e),this._externalRepo=new u.ExternalUnknown(e)}getKey(){return s.RepositoryTypes.GitHub}fetchBranchLink(e,t){return Promise.resolve(this._getBranchLinkInternal(e))}fetchCommitLink(e,t){return Promise.resolve(this._getCommitLinkInternal(e))}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryUrl(e.repositoryName))}fetchPRCommitLink(e,t){if(e.repositoryName&&e.branchName){const t=this._getPullRequestId(e.branchName);if(t)return Promise.resolve(`${this._getPullRequestUrl(t,e.repositoryName)}/commits`)}return this.emptyNullPromise}fetchCommitDiffLink(e,t){let r="";return e.repositoryName&&e.baseCommitId&&e.targetCommitId&&(r=`${this._getRepositoryUrl(e.repositoryName)}/compare/${e.baseCommitId}...${e.targetCommitId}`),Promise.resolve(r)}getRepoIconName(){return"GitHubLogo"}getMaxWorkItems(){return 10}_getBranchLink(e,t){return this._getBranchLinkInternal(e)}_getRepositoryLink(e,t){return this._getRepositoryUrl(e.repositoryName)}_getCommitLink(e,t){return this._getCommitLinkInternal(e)}_getBranchLinkInternal(e){if(e.repositoryName&&e.branchName){const t=this._getPullRequestId(e.branchName);if(t)return this._getPullRequestUrl(t,e.repositoryName);const r=this._normalizeBranchName(e.branchName);return`${this._getRepositoryUrl(e.repositoryName)}/tree/${r}`}return this._externalRepo.getBranchLink(e)}_getPullRequestUrl(e,t){return`${this._getRepositoryUrl(t)}/pull/${e}`}_getCommitLinkInternal(e){return e.repositoryName&&e.commitId?`${this._getRepositoryUrl(e.repositoryName)}/commit/${e.commitId}`:this._externalRepo.getCommitLink(e)}_getRepositoryUrl(e){if(!e)return console.error("Name is required to create a link to the repository"),"";if(e.startsWith(r.s_GitHubPrefix))return i.traceWarning(this.pageContext,l.area,"GitHub","Data shape issue: repositoryName may be a URL"),e.replace(/\.git$/g,"");const t=e.split("/",3);return 2===t.length&&t[0]&&t[1]?`${r.s_GitHubPrefix}/${e}`:(console.error(`Repository name "${e}" is not in the expected format ("user/repository")`),"")}}r.s_GitHubPrefix="https://github.com",t.GitHub.GitHub=r}(),function(e){g=t.GitHubEnterprise={},Object.defineProperty(t,"__esModule",{value:!0});t.GitHubEnterprise.GitHubEnterprise=class extends c.BaseGit{constructor(e){super(e),this._externalRepo=new u.ExternalUnknown(e)}getKey(){return s.RepositoryTypes.GitHubEnterprise}fetchBranchLink(e){return this._externalRepo.fetchBranchLink(e)}fetchCommitLink(e){return this._externalRepo.fetchCommitLink(e)}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepoUrl(e.repositoryUrl))}_getBranchLink(e,t){const r=this._getRepoUrl(e.repositoryUrl);return r&&e.branchName?`${r}/tree/${this._normalizeBranchName(e.branchName)}`:this._externalRepo.getBranchLink(e)}_getRepositoryLink(e,t){return this._getRepoUrl(e.repositoryUrl)}_getCommitLink(e,t){return this._externalRepo.getCommitLink(e)}getRepoIconName(){return"GitHubLogo"}getMaxWorkItems(){return 10}_getRepoUrl(e){return e?e.endsWith(".git")?e.slice(0,e.length-4):e:""}}}(),function(e){y=t.TfsGit={},Object.defineProperty(t,"__esModule",{value:!0});t.TfsGit.TfsGit=class extends c.BaseGit{getKey(){return s.RepositoryTypes.TfsGit}getRepoIconName(){return"GitLogo"}fetchBranchLink(e,t){return this.vcNavigationService.then(r=>this._getBranchLink(e,r,t))}fetchCommitLink(e,t){return this.vcNavigationService.then(r=>r.getGitCommitUrl(e.commitId,e.repositoryName||"",t))}fetchPRCommitLink(e,t){if(e.repositoryName&&e.branchName){const r=this._getPullRequestId(e.branchName);if(r)return this.vcNavigationService.then(i=>`${i.getPullRequestUrl(r,e.repositoryName,t)}?_a=commits`)}return this.emptyNullPromise}fetchCommitDiffLink(e,t){return this.vcNavigationService.then(r=>r.getGitCompareCommitsUrl(e.baseCommitId,e.targetCommitId,e.repositoryName||"",t))}fetchContentLinks(e){return this.vcNavigationService.then(t=>{let r=[];return(e||[]).forEach(e=>{const i=this._getContentLink(e,t);i&&r.push({id:e.id,link:i})}),r})}fetchContentLink(e){return e.repositoryName?this.vcNavigationService.then(t=>this._getContentLink(e,t)):this.emptyNullPromise}fetchRepositoryLink(e,t){return e.repositoryName?this.vcNavigationService.then(r=>this._getRepositoryLink(e,r,t)):this.emptyNullPromise}getProjectName(e){return this.gitClient.then(t=>t.getRepository(e).then(e=>e.project&&e.project.name,()=>null))}get gitClient(){return this._gitClient||(this._gitClient=this.getVcCode().then(()=>this.pageContext.getRestClient("IGitRestClient"))),this._gitClient}_getBranchLink(e,t,r){const i=this._getPullRequestId(e.branchName);return i?t.getPullRequestUrl(i,e.repositoryName,r):t.getRefUrl(e.branchName,e.repositoryName,r)}_getCommitLink(e,t,r){return t.getGitCommitUrl(e.commitId,e.repositoryName||"",r)}_getRepositoryLink(e,t,r){return t.getRepositoryUrl(e.repositoryName,r)}_getContentLink(e,t){let r="plain";return e.isError&&(r="error"),t.getRepositoryUrl(e.repositoryName,void 0,void 0,void 0,{line:e.lineNumber,lineStyle:r,lineTooltip:e.lineTooltip,version:this._getGitVersionSpec(e.version),path:e.path,_a:"contents"})}_getGitVersionSpec(e){return r.startsWith(e,"GC")||(e="GC"+e),e}}}(),function(e){_=t.Svn={},Object.defineProperty(t,"__esModule",{value:!0});t.Svn.Svn=class extends a.Base{getKey(){return s.RepositoryTypes.Svn}getRepoIconName(){return"SVNLogo"}getChangeText(e){return e&&e.id?r.format(o.CommitId,e.id.slice(0,7)):""}}}(),function(e){f=t.TfsVersionControl={},Object.defineProperty(t,"__esModule",{value:!0});class i extends a.Base{getKey(){return s.RepositoryTypes.TfsVersionControl}getCommitIconName(){return"DocumentSet"}getRepoIconName(){return"TFVCLogo"}getNormalizedBranch(e,t){return(e=e||"").replace(t.id,t.name)}getNormalizedCommit(e){return e&&!isNaN(parseInt(e))&&(e="C"+e),e}fetchBranchLink(e,t){return this.vcNavigationService.then(r=>this._getBranchLink(e,r,t))}fetchCommitLink(e,t){return this.vcNavigationService.then(r=>this._getCommitLink(e,r,t))}fetchRepositoryLink(e,t){return this.vcNavigationService.then(r=>this._getRepositoryLink(e,r,t))}_getBranchLink(e,t,n){const o=e.branchName;return r.startsWith(o,i.s_tfvcPrefix)?t.getRefUrl(e.branchName,null,n):t.getTfvcCommitUrl(e.branchName)}_getCommitLink(e,t,r){return t.getTfvcCommitUrl(this.getNormalizedCommit(e.commitId),r)}_getRepositoryLink(e,t,r){return t.getRepositoryUrl(null,r)}get tfvcClient(){return this._tfvcClient||(this._tfvcClient=this.getVcCode().then(()=>this.pageContext.getRestClient("ITfvcRestClient"))),this._tfvcClient}fetchShelvesets(e){const t={owner:e};return this.tfvcClient.then(e=>e.getShelvesets(t).then(e=>e))}}i.s_tfvcPrefix="$/",t.TfsVersionControl.TfsVersionControl=i}(),function(e){t.SourceProvider={},Object.defineProperty(t,"__esModule",{value:!0});class r extends n.VssService{constructor(){super(...arguments),this._sourceProviders={}}_serviceStart(e){super._serviceStart(e),[new m.Bitbucket(e),new h.ExternalGit(e),new p.GitHub(e),new g.GitHubEnterprise(e),new _.Svn(e),new y.TfsGit(e),new f.TfsVersionControl(e),new u.ExternalUnknown(e)].forEach(e=>{this._sourceProviders[e.getKey()]=e})}getSourceProvider(e){e=(e=e||"").toLocaleLowerCase();const t=this._sourceProviders[e];return t||(console.warn("Provider with type "+e+" is not initialized, fetching a generic external provider"),this._sourceProviders[s.RepositoryTypes.ExternalUnknown])}}t.SourceProvider.SourceProviderService=r,n.Services.add("ISourceProviderService",{serviceFactory:r})}()},["Resources","Common","Base","BaseGit","ExternalUnknown","TraceNames","Bitbucket","ExternalGit","GitHub","GitHubEnterprise","TfsGit","Svn","TfsVersionControl","SourceProvider"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.sourceproviders"}}));