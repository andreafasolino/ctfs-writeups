"use strict";define("DistributedTaskUI/LogReader",["require","exports","react","VSS/Core/Observable","VSS/Core/TimerManagement","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/Button","VSSUI/FocusZone","VSSUI/Intersection","VSSUI/Observer","VSSUI/TextField"],function(t,e,n,s,i,o,r,l,h,a,c,_){var d,u,p;d=e.Resources={},Object.defineProperty(e,"__esModule",{value:!0}),e.Resources.NoResults="No results",e.Resources.ResultsText="{0} of {1} lines",e.Resources.SearchKeyword="Search keyword",function(t){u=e[t]={},Object.defineProperty(e,"__esModule",{value:!0});const n="";e[t].RegexToIdentify=/\u200C/;const s=/(?:\u001b\[)(?:[\?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])/;var i;e[t].ansiEscapeCodeRegexString="(?:\\[)(?:[?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])",function(t){t.Reset="0",t.Bold="22",t.Italic="23",t.Underline="24",t.Fg="39",t.Bg="49"}(i||(i={}));const o={1:"bold",3:"italic",4:"underline"};function r(t){return(t||"").toLocaleLowerCase()}e[t].bgColors={40:"b",41:"r",42:"g",43:"y",44:"bl",45:"m",46:"c",47:"w"},e[t].fgColors={30:"b",31:"r",32:"g",33:"y",34:"bl",35:"m",36:"c",37:"w",90:"gr"},e[t].getText=r;e[t].SubParser=class{parse(t,e,n){let s="";return this.getStates(t).forEach(i=>{let o="";if(i.style){let t=i.style.fg,e=i.style.bg;t&&(o+=`ansifg-${t} `),e&&(o+=`ansibg-${e} `),i.style.bold&&(o+="fontWeightHeavy "),i.style.italic&&(o+=" italic"),i.style.underline&&(o+=" underline")}let l="<span";o&&(l+=` class='${o}'`),l+=">";let h="",a=-1,c=0;if(n&&-1!==n.lines.indexOf(e)){const s=n.text;for(;-1!==(a=r(t).indexOf(r(s),a+1));){const i=t.substring(c,a);i&&(h+=this._escape(i)),c=a+s.length;const o=t.substring(a,c);h+=`<span class="find-match ${e===n.toScroll?"highlight":""}">`+this._escape(o)+"</span>"}c>0&&t.length>c&&(h+=this._escape(t.substring(c,t.length)))}else h=this._escape(i.output);s+=l+h+"</span>"}),s}getStates(r){let l=[];if(!s.test(r))return[{output:r}];let h="",a="",c="",_={},d=!1,u=[];for(let s=0;s<r.length;s++){const p=r[s];d?";"===p?c&&(u.push(c),c=""):"m"===p?(c&&(d=!1,u.push(c),_.style=_.style||{},u.forEach(n=>{const s=_.style;e[t].fgColors[n]?s.fg=e[t].fgColors[n]:e[t].bgColors[n]?s.bg=e[t].bgColors[n]:n===i.Fg?s.fg="":n===i.Bg?s.bg="":o[n]?s[o[n]]=!0:n===i.Bold?s.bold=!1:n===i.Italic?s.italic=!1:n===i.Underline&&(s.underline=!1)}),h="",a="",c=""),u=[]):2===c.length?(c="",d=!1,p!==n&&(h="",a+=p)):c+=p:h?h===n&&"["===p&&(d=!0,a&&(_.output=a,l.push(_),_={},a="")):p===n?h=p:a+=p}return a&&(_.output=a+(h||""),l.push(_)),l}_escape(t){let e="";for(let n=0;n<t.length;n++){const s=t.charAt(n);e+="&"===s?"&amp;":"<"===s?"&lt;":">"===s?"&gt;":'"'===s?"&quot;":"'"===s?"&#x27;":"/"===s?"&#x2F;":s}return e}}}("SubParser"),function(t){var n;p=e.Parser={},Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Plain=0]="Plain",t[t.Command=1]="Command",t[t.Debug=2]="Debug",t[t.Error=3]="Error",t[t.Info=4]="Info",t[t.Section=5]="Section",t[t.Verbose=6]="Verbose",t[t.Warning=7]="Warning"}(n=e.Parser.NodeType||(e.Parser.NodeType={}));const s=7,i=["command","debug","error","info","section","verbose","warning"],o={command:n.Command,debug:n.Debug,error:n.Error,info:n.Info,section:n.Section,verbose:n.Verbose,warning:n.Warning},r={0:"plain",1:"command",2:"debug",3:"error",4:"info",5:"section",6:"verbose",7:"warning"},l="\n",h="#",a="[",c="]",_=t=>`<span class="dt-${t}">`,d="</span>",g=-1;e.Parser.Parser=class{constructor(){this._subParser=new u.SubParser}parse(t){let e=[],r=[],_=0,d=g,u=!0,p="",S="",f=g;const m=()=>{S="",p=""},b=()=>{d=g};for(let x=0;x<t.length;x++){const v=t.charAt(x);u=!0,v===l||x===t.length-1?(f!==n.Plain?r.push({type:f,start:_,end:x}):f===n.Plain&&r.push({type:n.Plain,start:d,end:x}),e.push({nodes:r}),r=[],_=x+1,b(),f=g,m(),u=!1):v===h?""!==S&&"#"!==S||(u=!1,S+=h):v===a?"##"===S?(u=!1,S+=a):0===S.length&&(u=!1,S+=a):v===c&&(-1!==i.indexOf(p)&&(u=!1,b(),f=o[p]),m()),u&&("##["!==S&&"["!==S||(p+=v.toLowerCase()),p.length>s&&m(),d===g&&(d=_,f===g&&(f=n.Plain)))}return e}transform(t,e,n,s){let i="";return t.nodes.forEach(t=>{const o=r[t.type];i+=_(o),i+=this._subParser.parse(e.substring(t.start,t.end),n,s),i+=d}),i}}}(),function(t){e.Reader={},Object.defineProperty(e,"__esModule",{value:!0});const g="Pipelines",S="Pipelines.LogParsing",f=150,m=100,b="main-content";e.Reader.Reader=class extends r.VssComponent{constructor(t){super(t),this._lineSize=f,this._scrollPending=!1,this._initialzed=!1,this._showFind=new s.ObservableValue(!1),this._onFind=(t=>{t&&t.lines.length>0?(this._findLine=t.toScroll,this._scrollPending=!0,this._scrollToLine(t)):this.setState({findResult:void 0})}),this._onKeyDown=(t=>{const e=u.getText(t.key);this._container&&(t.metaKey||t.ctrlKey)&&"f"===e&&(this._showFind.value=!0,this._find&&this._find.focus(),t.preventDefault())}),this._onLineClick=(t=>{if(this.props.onLineClick&&t){const e=t.target,n=parseInt(e.innerText);this.props.onLineClick(n)}}),this._onIntersect=(t=>{if(!this._scrollPending&&this._initialzed)for(const e of t){const t=parseInt(e.target.getAttribute("data-line")||"");if(e.target===this._bsentinel){if(e.intersectionRatio>0&&this.state.lineEnd===t&&this.state.lineEnd!==this.state.lines.length){this._sentinelLine=t,this._scrollPending=!0,this._intersectionContext.unobserve(this._bsentinel);const e=Math.min(this.state.lineEnd+this._lineSize,this.state.lines.length);this.setState({lineStart:Math.max(e-2*this._lineSize,1),lineEnd:e})}}else if(e.target===this._tsentinel&&e.intersectionRatio>0&&this.state.lineStart===t&&1!==this.state.lineStart){this._sentinelLine=t,this._scrollPending=!0,this._intersectionContext.unobserve(this._tsentinel);const e=Math.max(this.state.lineStart-this._lineSize,1);this.setState({lineStart:e,lineEnd:Math.min(e+2*this._lineSize,this.state.lines.length)})}}}),this._onResize=(()=>{this._setHeight()}),this._onFindHide=(()=>{this._showFind.value=!1}),this._timer=new i.TimerManagement,this._parser=new p.Parser,this.state={content:"",lines:[],findResult:void 0,lineStart:0,lineEnd:0},this._onResize=this._timer.debounce(this._onResize,m),this._onIntersect=this._timer.throttle(this._onIntersect,m),this._onKeyDown=this._timer.throttle(this._onKeyDown,m)}render(){let t=this.state.lineStart;const e=this.state.lines.slice(this.state.lineStart-1,this.state.lineEnd);return n.createElement("div",{className:"dt-reader flex-row",tabIndex:0,ref:t=>this._container=t,onKeyDown:this._onKeyDown},n.createElement(a.Intersection,null,n.createElement("div",{className:`${b} flex-grow scroll-auto`},n.createElement(a.IntersectionContext.Consumer,null,s=>(this._intersectionContext=s,n.createElement("div",{className:`flex-column content-area ${this.props.onLineClick?"linkable":""}`},n.createElement(c.Observer,{showFind:this._showFind},t=>t.showFind?n.createElement(x,{ref:t=>this._find=t,timer:this._timer,content:this.state.content,lines:this.state.lines,start:this.state.lineStart,end:this.state.lineEnd,onFind:this._onFind,hide:this._onFindHide}):null),n.createElement(h.FocusZone,{direction:2},n.createElement("ol",null,e.map((s,i)=>{const o=t++,r=this.props.lineToScroll===o?"highlight":"";return n.createElement(n.Fragment,null,0===i&&n.createElement("li",{"aria-hidden":!0},this._getSentinel(o,!0)),n.createElement("li",{className:`line-area flex-row ${r}`,"data-line":o},n.createElement("span",Object.assign({className:"flex-noshrink line"},this.props.onLineClick?{onClick:this._onLineClick}:{}),o),n.createElement("span",{className:"content",dangerouslySetInnerHTML:{__html:this._parser.transform(s,this.state.content,o,this.state.findResult)}})),i===e.length-1&&this.state.lines.length>e.length&&n.createElement("li",{"aria-hidden":!0},this._getSentinel(o)))})))))))))}componentDidMount(){this._intersectionContext&&this._intersectionContext.register(this._onIntersect),window.addEventListener("resize",this._onResize),this._setHeight(),this._setContent(),this.props.lineToScroll&&(this._scrollPending=!0),this._container&&this._container.focus()}componentWillUnmount(){this._intersectionContext&&this._intersectionContext.unregister(this._onIntersect),window.removeEventListener("resize",this._onResize)}componentDidUpdate(t){this.props.content!==t.content&&this._setContent(),this._scrollToLine()}get _perfService(){return this.context.pageContext.getService("IVssPerformanceService")}_scrollToLine(t){const e=this._findLine||this._sentinelLine||this.props.lineToScroll;if(this._initialzed&&this._scrollPending&&e&&this._container&&this.state.lines.length>0){if(this._isLineInLimits(e)){const t=this._container.querySelector(`[data-line="${e}"]`);if(t){if(this._hasScroll()){let n="end";e===this.props.lineToScroll&&(n="center",this.props.onScrollToLine&&this.props.onScrollToLine(e)),e===this._findLine&&(this._findLine=void 0),t.scrollIntoView({behavior:"auto",block:n})}this._scrollPending=!1,this._bsentinel&&this._intersectionContext.observe(this._bsentinel),this._tsentinel&&this._intersectionContext.observe(this._tsentinel)}}const n=this._getLineLimits(e,this.state.lines);n?this.setState({lineStart:n.lineStart,lineEnd:n.lineEnd,findResult:t||this.state.findResult}):this._scrollPending=!1}}_getLineLimits(t,e){let n;return t&&t<=e.length&&(n={lineStart:Math.max(t-this._lineSize,1),lineEnd:Math.min(t+this._lineSize,e.length)}),n}_isLineInLimits(t){return t>=this.state.lineStart&&t<=this.state.lineEnd}_setContent(){this._perfService.startScenario(S,!1),this._initialzed=!1,this.props.content.then?this.props.content.then(t=>{this._onData(t)}):this._onData(this.props.content)}_onData(t){this._perfService.addSplitTiming("ContentFetched",S);const e=t||"",n=this._parser.parse(e);if(this._container&&this._container.parentElement){const t=this._container.clientHeight,e=Math.ceil(t/10)+30;this._lineSize=Math.max(e,this._lineSize)}this._initialzed=!0;const s=this._getLineLimits(this.props.lineToScroll,n),i=s?s.lineStart:1,o=s?s.lineEnd:Math.min(this._lineSize,n.length);if(this.setState({content:e,lines:n,lineStart:this.state.lineStart?this.state.lineStart:i,lineEnd:this.state.lineEnd?this.state.lineEnd:o}),this._container&&this.props.autoScroll){const t=this._container.querySelector("."+b);if(t&&this._hasScroll(t))if(t.scroll)t.scroll(0,t.scrollHeight);else if(this._container){const t=this._container.querySelector(`[data-line="${this.state.lineEnd}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"end"})}}this._perfService.endScenario(g,S,!1,void 0,{lineCount:this.state.lines.length,lineStart:this.state.lineStart,lineEnd:this.state.lineEnd,contentLength:this.state.content.length,autoScroll:!!this.props.autoScroll,lineToScroll:this.props.lineToScroll,sentinelLine:this._sentinelLine})}_hasScroll(t){const e=t||(this._container?this._container.querySelector("."+b):void 0);return e&&e.scrollHeight>e.clientHeight}_getSentinel(t,e=!1){return n.createElement("span",{className:"sentinel","data-line":t,ref:t=>{this._observe(t,e)}})}_observe(t,e=!1){e?(this._tsentinel=t,this._tsentinel&&this._intersectionContext&&(this._intersectionContext.unobserve(this._tsentinel),this._intersectionContext.observe(this._tsentinel))):(this._bsentinel=t,this._bsentinel&&this._intersectionContext&&(this._intersectionContext.unobserve(this._bsentinel),this._intersectionContext.observe(this._bsentinel)))}_setHeight(){if(this._container){const t=this._container.parentElement;t&&(this._container.style.height=t.clientHeight-15+"px")}}};class x extends n.Component{constructor(t){super(t),this._toScrollIndex=0,this._onKeyDown=(t=>{"escape"===u.getText(t.key)&&(this._hide(),t.preventDefault())}),this._getResult=(()=>this._result?o.format(d.ResultsText,this._result.scrollCount,this._result.lines.length):d.NoResults),this._hide=(()=>{this.props.hide()}),this._onChange=((t,e)=>{let n;if(this._value.value=e,this._originalStart===this.props.start&&this._value.value===this._prevValue||this._resetSeekers(),this._prevValue=e,e){const t=this.props.lines,s=this._end-this._start;let i=0,o=[];for(let n=this._start-1;n<this._end;n++){const r=t[n];let l=!1;const h=r.nodes.length;if(h>0){const t=r.nodes[0].start,n=r.nodes[h-1].end;-1!==u.getText(this.props.content.substring(t,n)).indexOf(u.getText(e))&&(l=!0)}if(l){i++;const e=n+1;if(o.push(e),i===s){this._start=e,this._end=(e+s)%t.length;break}}}o.length>0&&(n={lines:o,text:e,toScroll:o[this._toScrollIndex],scrollCount:this._toScrollIndex+1})}this._result=n,this.props.onFind(n)}),this._onDown=(()=>{if(this._result){const t=this._toScrollIndex+1;this._toScrollIndex=t>=this._result.lines.length?0:t,this._updateResult(this._toScrollIndex),this.props.onFind(this._result)}}),this._onUp=(()=>{if(this._result){const t=this._toScrollIndex-1;this._toScrollIndex=t<0?this._result.lines.length-1:t,this._updateResult(this._toScrollIndex),this.props.onFind(this._result)}}),this._value=new s.ObservableValue(""),this._resetSeekers(),this._originalStart=this._start}render(){return n.createElement(h.FocusZone,{direction:1},n.createElement("div",{className:"dt-command dt-find flex-row",onKeyDown:this._onKeyDown},n.createElement(_.TextField,{ref:t=>this._textField=t,placeholder:d.SearchKeyword,value:this._value,onChange:this._onChange}),n.createElement("span",{className:"f-result f-mar"},this._getResult()),n.createElement(l.Button,{onClick:this._onUp,className:"f-icon f-mar",iconProps:{iconName:"ChevronUp"}}),n.createElement(l.Button,{onClick:this._onDown,className:"f-icon f-mar",iconProps:{iconName:"ChevronDown"}}),n.createElement(l.Button,{onClick:this._hide,className:"f-icon",iconProps:{iconName:"ChromeClose"}})))}focus(){this._textField&&this._textField.focus()}componentDidMount(){this._textField&&this._textField.focus()}_updateResult(t){this._result&&(this._result.toScroll=this._result.lines[this._toScrollIndex],this._result.scrollCount=this._toScrollIndex+1)}_resetSeekers(){this._start=1,this._end=this.props.lines.length,this._toScrollIndex=0}}e.Reader.Find=x}()},["Resources","SubParser","Parser","Reader"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.dt-logs"}}));