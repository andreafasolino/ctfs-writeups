"use strict";define("Build/Common/Artifacts",["require","exports","Build/Common/Library/ErrorHandler","Build/Flux/Action","react","Build/Common/Library/Navigation","VSS/Legacy/Legacy","VSS/Core/Util/String","VSS/Platform/Context","Build/Flux/Store","Build/Common/Library/Stores/Permissions","Build/Common/Library/Security","Build/Shared/Components/DetailsSection/DetailsSection","VSSUI/Icon","VSSUI/Link","VSSUI/TooltipEx","VSSUI/Menu"],function(t,e,r,i,o,s,a,n,c,l,d,p,u,f,h,m,A){var v,y,_,b,S,C,g,w,x,T,L,B,P,E,R;v=e.Resources={},Object.defineProperty(e,"__esModule",{value:!0}),e.Resources.AriaBuildArtifactDetailsChevron="Show build artifact details",e.Resources.AriaBuildArtifactsList="List of build artifacts",e.Resources.BuildArtifacts="Build artifacts published",e.Resources.BuildArtifactFormat="Artifact {0}",e.Resources.BuildArtifactLabelFormat="Label {0}",e.Resources.ContainerType="File container",e.Resources.Download="Download",e.Resources.DownloadFormat="Download {0}",e.Resources.PipelineArtifact="Pipeline artifact",e.Resources.FilePathType="File share",e.Resources.GitRefType="GitRef",e.Resources.MoreOptions="More options",e.Resources.SymbolRequestType="SymbolRequest",e.Resources.SymbolStoreType="SymbolStore",e.Resources.TfvcLabelType="TfvcLabel",e.Resources.UnknownType="Unknown",e.Resources.VersionControlType="VersionControl",e.Resources.ViewContents="View contents",function(t){y=e.Source={},Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(t){this._client=t.client,this._projectId=t.projectId}getArtifacts(t){return this._client.getArtifacts(this._projectId,t).then(r.sortArtifacts)}getArtifact(t,e){return this._client.getArtifact(this._projectId,t,e)}}r.sortArtifacts=(t=>(t||[]).sort((t,e)=>t.name>e.name?1:t.name<e.name?-1:0)),e.Source.ArtifactsSource=r}(),function(t){_=e.Action={},Object.defineProperty(e,"__esModule",{value:!0});e.Action.ArtifactsActionCreator=class{constructor(t){this._actionHub=t.actionHub||new o,this._source=new y.ArtifactsSource({client:t.client,projectId:t.projectId})}fetchArtifacts(t){this._source.getArtifacts(t).then(t=>this._actionHub.artifactsAvailable.invoke(t)).catch(r.handleError)}fetchArtifact(t,e){this._source.getArtifact(t,e).then(t=>this._actionHub.artifactAdded.invoke(t)).catch(r.handleError)}};class o{constructor(){this._artifactAdded=new i.Action,this._artifactsAvailable=new i.Action}get artifactAdded(){return this._artifactAdded}get artifactsAvailable(){return this._artifactsAvailable}}e.Action.ArtifactsActionHub=o}(),b=e.Common={},Object.defineProperty(e,"__esModule",{value:!0}),(R=e.Common.BuildArtifactTypes||(e.Common.BuildArtifactTypes={})).FilePath="FilePath".toLowerCase(),R.SymbolStore="SymbolStore".toLowerCase(),R.VersionControl="VersionControl".toLowerCase(),R.Container="Container".toLowerCase(),R.GitRef="GitRef".toLowerCase(),R.TfvcLabel="TfvcLabel".toLowerCase(),R.SymbolRequest="SymbolRequest".toLowerCase(),R.PipelineArtifact="PipelineArtifact".toLowerCase(),R.Unknown="Unknown".toLowerCase(),function(t){S=e.providersBase={},Object.defineProperty(e,"__esModule",{value:!0});e.providersBase.Base=class{constructor(t,e,r){this.pageContext=t,this.artifact=e,this.providerContext=r}getArtifact(){return this.artifact}getProviderContext(){return this.providerContext}supportsDownload(){return!1}supportsExploring(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"ZipFolder",tooltip:n.format(v.BuildArtifactFormat,this.artifact.name),type:this.getType()}}onDownload(){this.supportsDownload()&&this.openLink(this.getDownloadURL())}onExplore(){this.pageContext.getService("IVssLayoutManager").renderCallout(t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-explorer-dialog",artifact:this.artifact,buildId:this.providerContext.buildId,projectId:this.providerContext.projectId};return o.createElement(a.LegacyComponent,e)})}getDownloadURL(){return this.supportsDownload()?this.artifact.resource.downloadUrl:""}showCopyDialog(){this.pageContext.getService("IVssLayoutManager").renderCallout(t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-copy-dialog",content:this.artifact.resource.downloadUrl};return o.createElement(a.LegacyComponent,e)})}getType(){switch(this.getKey()){case b.BuildArtifactTypes.Container:return v.ContainerType;case b.BuildArtifactTypes.PipelineArtifact:return v.PipelineArtifact;case b.BuildArtifactTypes.FilePath:return v.FilePathType;case b.BuildArtifactTypes.GitRef:return v.GitRefType;case b.BuildArtifactTypes.SymbolRequest:return v.SymbolRequestType;case b.BuildArtifactTypes.SymbolStore:return v.SymbolStoreType;case b.BuildArtifactTypes.TfvcLabel:return v.TfvcLabelType;case b.BuildArtifactTypes.VersionControl:return v.VersionControlType}return v.UnknownType}openLink(t){s.openLinkSecurely(t)}}}(),function(t){C=e.providersContainer={},Object.defineProperty(e,"__esModule",{value:!0});e.providersContainer.Container=class extends S.Base{getKey(){return b.BuildArtifactTypes.Container}supportsDownload(){return!0}supportsExploring(){return!0}}}(),function(t){g=e.providersPipelineArtifact={},Object.defineProperty(e,"__esModule",{value:!0});e.providersPipelineArtifact.PipelineArtifact=class extends S.Base{constructor(t,e,r){super(t,e,r)}getKey(){return b.BuildArtifactTypes.PipelineArtifact}supportsDownload(){return!0}supportsExploring(){return!0}getDownloadURL(){let t=this.artifact.resource.properties.DownloadUri;if(!t){let i=/^[^:]+:\/\/(([^\.]*)\.([^\/]*))\/([^\/]*)\/.*$/,o=this.artifact.resource.url.match(i);if(null!==o){let i,s=o,a=s[1],n=s[2],c=s[3],l=s[4];i="dev.azure.com"==a.toLowerCase()||"codedev.ms"==a.toLowerCase()?"https://artifacts."+a+"/"+(n=l):"https://"+n+".artifacts."+c;let d=this.artifact.name,p="pipelineartifact://"+n+"/projectId/"+this.providerContext.projectId+"/buildId/"+this.providerContext.buildId+"/artifactName/"+d,u=window.btoa(p);var e=u.split("");let f=0;for(var r=e.length-1;r>=0&&"="==e[r];r--)f++;u=u.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),t=i+"/_apis/artifact/"+(u+=f.toString())+"/content?format=zip"}}return this.supportsDownload()?t:""}}}(),function(t){w=e.providersFilepath={},Object.defineProperty(e,"__esModule",{value:!0});e.providersFilepath.FilePath=class extends S.Base{getKey(){return b.BuildArtifactTypes.FilePath}supportsDownload(){return!0}supportsExploring(){return!1}onDownload(){this.showCopyDialog()}}}(),function(t){x=e.providersGitRef={},Object.defineProperty(e,"__esModule",{value:!0});e.providersGitRef.GitRef=class extends S.Base{getKey(){return b.BuildArtifactTypes.GitRef}getDisplayOptions(){return{text:this.artifact.name,iconName:"GitLogo",tooltip:n.format(v.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}}(),function(t){T=e.providersTfvcLabel={},Object.defineProperty(e,"__esModule",{value:!0});e.providersTfvcLabel.TfvcLabel=class extends S.Base{getKey(){return b.BuildArtifactTypes.TfvcLabel}supportsDownload(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:n.format(v.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}}(),function(t){L=e.providersVersionControl={},Object.defineProperty(e,"__esModule",{value:!0});e.providersVersionControl.VersionControl=class extends S.Base{getKey(){return b.BuildArtifactTypes.VersionControl}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:n.format(v.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}}(),function(t){B=e.providersSymbolRequest={},Object.defineProperty(e,"__esModule",{value:!0});e.providersSymbolRequest.SymbolRequest=class extends S.Base{getKey(){return b.BuildArtifactTypes.SymbolRequest}}}(),function(t){P=e.providersSymbolStore={},Object.defineProperty(e,"__esModule",{value:!0});e.providersSymbolStore.SymbolStore=class extends S.Base{getKey(){return b.BuildArtifactTypes.SymbolStore}}}(),function(t){E=e.providersUnknown={},Object.defineProperty(e,"__esModule",{value:!0});e.providersUnknown.Unknown=class extends S.Base{getKey(){return b.BuildArtifactTypes.Unknown}}}(),function(t){e.providersArtifactProvider={},Object.defineProperty(e,"__esModule",{value:!0});class r extends c.VssService{getArtifactProvider(t,e){switch(t.resource.type.toLowerCase()){case b.BuildArtifactTypes.Container:return new C.Container(this.pageContext,t,e);case b.BuildArtifactTypes.PipelineArtifact:return new g.PipelineArtifact(this.pageContext,t,e);case b.BuildArtifactTypes.FilePath:return new w.FilePath(this.pageContext,t,e);case b.BuildArtifactTypes.GitRef:return new x.GitRef(this.pageContext,t,e);case b.BuildArtifactTypes.TfvcLabel:return new T.TfvcLabel(this.pageContext,t,e);case b.BuildArtifactTypes.VersionControl:return new L.VersionControl(this.pageContext,t,e);case b.BuildArtifactTypes.SymbolRequest:return new B.SymbolRequest(this.pageContext,t,e);case b.BuildArtifactTypes.SymbolStore:return new P.SymbolStore(this.pageContext,t,e);default:return new E.Unknown(this.pageContext,t,e)}}}e.providersArtifactProvider.ArtifactProviderService=r,c.Services.add("IArtifactProviderService",{serviceFactory:r})}(),function(t){e.Store={},Object.defineProperty(e,"__esModule",{value:!0});class r extends l.Store{constructor(t){super(),this._artifacts=[],this._artifactProviders=[],this._fetchingArtifacts={},this._setArtifacts=(t=>{this._artifacts=t;const e={buildId:this._buildId,projectId:this._projectId};this._artifactProviders=(t||[]).map(t=>this._providerService.getArtifactProvider(t,e)),this._storeChanged()}),this._onArtifactAdded=(t=>{this._artifacts.push(t),this._artifacts=y.ArtifactsSource.sortArtifacts(this._artifacts),this._setArtifacts(this._artifacts)}),this._storeChanged=(()=>{this.emitChanged()}),this._buildClient=t.pageContext.getRestClient("IBuildRestClient"),this._providerService=t.pageContext.getService("IArtifactProviderService"),this._actionHub=t.actionHub||new _.ArtifactsActionHub,this._projectId=t.projectId,this._actionCreator=t.actionCreator||new _.ArtifactsActionCreator({actionHub:this._actionHub,client:this._buildClient,projectId:this._projectId}),this._permissionsStore=t.permissionsStore?t.permissionsStore:new d.PermissionsStore({pageContext:t.pageContext}),this._security=new p.Security({projectId:this._projectId,store:this._permissionsStore}),this._actionHub.artifactsAvailable.addListener(this._setArtifacts),this._actionHub.artifactAdded.addListener(this._onArtifactAdded),this._permissionsStore.addListener(this._storeChanged),this._buildId=t.buildId}dispose(){this._actionHub.artifactsAvailable.removeListener(this._setArtifacts),this._actionHub.artifactAdded.removeListener(this._onArtifactAdded),this._permissionsStore.removeListener(this._storeChanged),this._fetchingArtifacts={}}getArtifactProviders(){return this._artifactProviders}canExploreArtifacts(){return!(this._security.isAnonymousUser()||this._security.isPublicUser())}addArtifact(t,e){this._buildId!==t||this._fetchingArtifacts[e]||(this._actionCreator.fetchArtifact(t,e),this._fetchingArtifacts[e]=!0)}updateBuild(t){this._buildId!==t&&(this._buildId=t,this._buildId?this._actionCreator.fetchArtifacts(this._buildId):this._setArtifacts([]))}}r.key="build-artifacts-store",e.Store.ArtifactsStore=r}(),function(t){e.Timeline={},Object.defineProperty(e,"__esModule",{value:!0});e.Timeline.ArtifactSnapshotContent=class extends o.Component{constructor(t,e){super(t),this._updateArtifactsState=(()=>{this.setState({providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()})}),this._store=t.store,this.state={providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()}}componentDidMount(){this._store.addListener(this._updateArtifactsState)}componentWillUnmount(){this._store.removeListener(this._updateArtifactsState)}render(){return o.createElement(u.DetailsSection,{className:"details-timeline-left b-details-timeline ci-hover-behavior",sectionKey:"build-artifacts-timeline",chevronProps:{ariaLabel:v.AriaBuildArtifactDetailsChevron},isExpandedByDefault:!0},o.createElement(u.DetailsSectionHeader,{renderAsHeading:!0},o.createElement("span",null,v.BuildArtifacts)),o.createElement(u.DetailsSectionSecondaryHeader,null,o.createElement("span",null)),o.createElement(u.DetailsSectionContent,null,o.createElement(r,{providers:this.state.providers,canExploreArtifacts:this.state.canExploreArtifacts})))}};class r extends o.Component{render(){return o.createElement("div",{className:"build-artifacts-details-content"},o.createElement("ul",{className:"artifacts-list","aria-label":v.AriaBuildArtifactsList},this.props.providers.map(t=>o.createElement("li",{key:t.getArtifact().id},o.createElement(i,{provider:t,canExploreArtifacts:this.props.canExploreArtifacts})))))}}class i extends o.Component{constructor(t){super(t),this._onDownload=(()=>{this.props.provider.onDownload()}),this._onExplore=(()=>{this.props.provider.onExplore()}),this.state={}}render(){const t=this.props.provider,e=t.getDisplayOptions(),r=t.getDownloadURL();let i=[];this.props.canExploreArtifacts&&t.supportsExploring()&&i.push({id:"artifact-explore",text:v.ViewContents,onActivate:this._onExplore,iconProps:{iconName:"DocumentSet"}}),t.supportsDownload()&&i.push({id:"artifact-download",text:v.Download,onActivate:this._onDownload,iconProps:{iconName:"Download"}});const s=this.state.target?"":"hidden";return o.createElement("div",{className:"build-artifact-item flex flex-center"},o.createElement("div",{className:"artifact-name-area flex flex-grow"},o.createElement(f.Icon,{className:"artifact-icon fontSizeL",iconName:e.iconName}),o.createElement("span",null," "),o.createElement(m.Tooltip,{text:n.format(v.DownloadFormat,e.text)},o.createElement("div",{className:"artifact-data flex flex-column relative"},r&&o.createElement(h.Link,{className:"artifact-name",href:r},e.text),!r&&o.createElement("div",{className:"artifact-name"},e.text),o.createElement("div",{className:"artifact-info"},e.type)))),o.createElement("div",{className:`button-area ${s} relative flex-self-end`},i.length>0?o.createElement(A.MenuButton,{hideDropdownIcon:!0,className:"subtle",contextualMenuProps:{menuProps:{id:"timeline-menu",items:i}},iconProps:{iconName:"More"}}):null))}}}()},["Resources","Source","Action","Common","providers/Base","providers/Container","providers/PipelineArtifact","providers/Filepath","providers/GitRef","providers/TfvcLabel","providers/VersionControl","providers/SymbolRequest","providers/SymbolStore","providers/Unknown","providers/ArtifactProvider","Store","Timeline"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.common-artifacts"}}));