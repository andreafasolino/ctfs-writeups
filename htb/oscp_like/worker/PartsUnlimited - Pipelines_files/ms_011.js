"use strict";define("Build/Queue-Panel",["require","exports","Build/Flux/Action","Build/Flux/Store","Build/SourceProviders/Common","VSS/Core/Util/String","VSS/Core/Observable","react","VSSUI/Button","VSSUI/List","VSSUI/Link","VSSUI/Icon","VSSUI/Checkbox","VSSUI/FormItem","VSSUI/Observer","VSSUI/Panel","VSSUI/TextField","VSSUI/PickList","Build/Common/Library/Legacy/Components/ShelvesetAction","Build/Common/Library/Legacy/Components/BranchDropdown","Build/Common/Library/SingletonManager","Build/Common/Library/Legacy/Stores/Queue","DistributedTask/Common/Library/AgentQueueSelector","DistributedTask/Common/Library/Sources/Queue","VSS/Core/TimerManagement","VSS/Platform/FPS","VSSUI/Header","VSSUI/MessageCard","VSSUI/Spinner"],function(e,t,i,s,a,n,r,o,l,d,c,u,h,m,p,b,_,g,v,S,C,D,f,V,w,A,x,E,P){var B,y,N,R,k,T,q;B=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AddDemandButton="Add demand",t.Resources.AddDemandPanelTitle="New demand",t.Resources.AddVariableButton="Add variable",t.Resources.AddVariablePanelTitle="New variable",t.Resources.AgentPool="Agent pool",t.Resources.BranchLabel="Branch/tag",t.Resources.BuildQueuedMessage="Build #{0} has been queued.",t.Resources.CancelButtonText="Cancel",t.Resources.CloseButtonAriaLabel="Close",t.Resources.ConditionFieldLabel="Condition",t.Resources.CreateButtonText="Create",t.Resources.DeleteButtonEmptyTooltip="Delete variable",t.Resources.DeleteButtonTooltip="Delete variable '{0}'",t.Resources.DemandsTabTitle="Demands",t.Resources.DuplicateVariableMessage="Variable '{0}' is already defined",t.Resources.EmptyDemandsDescription="You can add demands for this run.",t.Resources.EmptyDemandsVariablesLink=" Learn more.",t.Resources.EmptyVariablesDescription="You can add variables for this run.",t.Resources.EqualsCondition="equals",t.Resources.ExistsCondition="exists",t.Resources.GitSourceSelectorDescription="select the branch or commit tag",t.Resources.NameFieldLabel="Name",t.Resources.QueueButtonText="Run",t.Resources.QueuePanelDescription="Select parameters below and manually run the pipeline",t.Resources.QueuePanelTitleNoDefinition="Run pipeline",t.Resources.RunWithDiagnostics="Enable system diagnostics",t.Resources.RunWithWarningsButtonText="Run anyway",t.Resources.SaveAndRunWithWarningsButtonText="Save and run anyway",t.Resources.SaveAndQueueButtonText="Save and run",t.Resources.SaveComment="Save comment",t.Resources.SecretFieldLabel="Keep this value secret",t.Resources.SecretValue="secret",t.Resources.SourceVersionLabel="Source version",t.Resources.StartingRun="Starting run...",t.Resources.TfsGitSourceSelectorDescription="Select the branch, commit or commit tag",t.Resources.UpdateButtonText="Update",t.Resources.UpdateDemandPanelTitle="Update demand",t.Resources.UpdateVariablePanelTitle="Update variable",t.Resources.ValueFieldLabel="Value",t.Resources.VariableRequiredNameMessage="Variable name is required",t.Resources.VariablesTabTitle="Variables",function(e){y=t.Action={},Object.defineProperty(t,"__esModule",{value:!0});t.Action.EnableDiagnosticActionCreator=class{constructor(e){this._actionHub=e.actionHub||new s}toggleEnableDiagnostic(e){this._actionHub.toggleEnableDiagnostic.invoke(e)}};class s{constructor(){this._toggleEnableDiagnostic=new i.Action}get toggleEnableDiagnostic(){return this._toggleEnableDiagnostic}}t.Action.EnableDiagnosticActionHub=s;class a{constructor(e){this._actionHub=e.actionHub||new n}queueBuild(e){const t={agentSpecification:e.agentSpecification,queue:{id:e.agentQueueId},definition:{id:e.definitionId},project:{id:e.projectId},sourceBranch:e.sourceBranch,sourceVersion:e.sourceVersion,reason:1,demands:e.demands,parameters:e.parameters};e.pageContext.getRestClient("IBuildRestClient").queueBuild(t,e.projectId,e.ignoreWarnings).then(e=>this._actionHub.buildQueued.invoke({build:e})).catch(e=>{const t=a._getErrorAndWarningMessage(e);this._actionHub.buildQueued.invoke({build:void 0,message:t.message,messageSeverity:t.severity})})}static _getErrorAndWarningMessage(e){let t="",i="Info";if(e&&e.length>0){const s=e.filter(e=>2===e.result);s.length>0?(t=this._joinValidateResults(s),i="Error"):(t=this._joinValidateResults(e),i="Warning")}else if(e)return this._getErrorMessageFromServer(e);return{message:t,severity:i}}static _joinValidateResults(e){let t=e.map(e=>e.message);return(t=t.filter(e=>!!e)).join(",")}static _getErrorMessageFromServer(e){let t="",i="Error";if(e&&(t=e.message||""),e&&e.serverError&&e.serverError.customProperties){let s=e.serverError.customProperties.ValidationResults;if(s&&s.length>0){const e=s.filter(e=>2===e.result);t=this._joinValidateResults(e);const a=s.filter(e=>1===e.result);a&&a.length>0&&(t=this._joinValidateResults(a),i="Warning")}}else e&&e.serverError&&0===t.length&&(t=e.serverError.message||"");return{message:t,severity:i}}}t.Action.QueueBuildActionCreator=a;class n{constructor(){this._buildQueued=new i.Action}get buildQueued(){return this._buildQueued}}t.Action.QueueBuildActionHub=n;t.Action.SourceVersionActionCreator=class{constructor(e){this._actionHub=e.actionHub||new r}updateVersion(e){this._actionHub.versionUpdated.invoke(e)}updateBranch(e){this._actionHub.branchUpdated.invoke(e)}updateShelveset(e){this._actionHub.shelvesetUpdated.invoke(e)}};class r{constructor(){this._versionUpdated=new i.Action,this._branchUpdated=new i.Action,this._shelvesetUpdated=new i.Action}get versionUpdated(){return this._versionUpdated}get branchUpdated(){return this._branchUpdated}get shelvesetUpdated(){return this._shelvesetUpdated}}t.Action.SourceVersionActionHub=r}(),function(e){N=t.StoresQueueBuild={},Object.defineProperty(t,"__esModule",{value:!0});const i="{0} -equals {1}",o="equals",l="refs/heads/",d="refs/tags/",c="refs/";class u extends s.Store{constructor(e){super(),this._sourceVersion="",this._shelvesetName="",this.updateDefinition=((e,t,i,s,a)=>{s||(this._buildDefinition=void 0),this._definitionId=e,this._runtimeVariables=new r.ObservableArray(this._createRuntimeVariablesArray(t)),this._sourceBranch=i||"",this._sourceVersion="",this._shelvesetName="",this._sourceTag="",this._selectedQueue={},this._buildRepository=a||{},this._enableDiagnostic=!1}),this.updateBuildDefinition=((e,t)=>{const i=e&&e.repository?e.repository.defaultBranch:"";this._buildDefinition=e,e&&e.id&&this.updateDefinition(e.id,t,i,!0,e.repository)}),this.fetchBuildDefinition=(()=>this._buildDefinition&&this._buildDefinition.id===this._definitionId?Promise.resolve(this._buildDefinition):this._buildClient.getDefinition(this._projectId,this._definitionId).then(e=>(this._buildDefinition=e,this._buildDefinition))),this.fetchDemands=(()=>{this._demands?this._demands.removeAll():this._demands=new r.ObservableArray([]),this.fetchBuildDefinition().then(e=>{const t=this._convertSerializedDemandToDemandData(e.demands);this._demands.value=t},e=>{console.log("failed to retrieve build definition: "+e)})}),this.getVariables=(()=>this._runtimeVariables),this._createRuntimeVariablesArray=(e=>{let t=0,i=[];return e&&e.length>0&&e.forEach(e=>{i.push({index:t,name:e.name,value:e.variable.value,isSecret:e.variable.isSecret,disableDelete:e.disableDelete}),t++}),i}),this._removeDuplicateDemands=(e=>{for(var t=0;t<e.length;++t)for(var i=t+1;i<e.length;++i)this._areEqualDemands(e[t],e[i])&&e.splice(i--,1)}),this._areEqualDemands=((e,t)=>{if(e.name===t.name&&e.condition===t.condition){if(1!==e.condition)return!0;if(e.value===t.value)return!0}return!1}),this._handleQueueSelected=(e=>{this._selectedQueue=e,this.fetchDemands(),this.emitChanged()}),this._handleBranchUpdated=(e=>{e.startsWith(u._tagVersionPrefix)?(this._sourceTag=e.substring(u._tagVersionPrefix.length),this._sourceBranch=""):(this._sourceBranch=e,this._sourceTag=""),this.emitChanged()}),this._handleShelvesetUpdated=(e=>{this._shelvesetName=e,this.emitChanged()}),this._handleToggleEnableDiagnostic=(e=>{this._enableDiagnostic=e,this.emitChanged()}),this._handleVersionUpdated=(e=>{this._sourceVersion=e,this.emitChanged()}),this.updateVariable=(e=>{this._runtimeVariables.change(e.index,e)}),this.addVariable=(e=>{this._runtimeVariables.push(e)}),this.deleteVariable=(e=>{this._runtimeVariables.splice(e,1)}),this.addDemand=(e=>{this._demands.push(e)}),this.deleteDemand=(e=>{this._demands.splice(e,1)}),this.updateDemand=(e=>{this._demands.change(e.index,e)}),this._pageContext=e.pageContext,this._definitionId=e.definitionId,e.buildDefinition&&(this._buildDefinition=e.buildDefinition),this._sourceBranch=e.sourceBranch||"",this._projectId=e.projectId,this._sourceVersionActionHub=e.sourceVersionActionHub,this._shelvesetPickerActiobHub=e.shelvesetPickerActiobHub,this._buildRepository=e.buildRepository,this._queueActionHub=e.queueActionHub,this._runtimeVariables=new r.ObservableArray(this._createRuntimeVariablesArray(e.runtimeVariables)),this._enableDiagnosticActionHub=e.enableDiagnosticActionHub,this._sourceVersionActionHub.versionUpdated.addListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.addListener(this._handleBranchUpdated),this._shelvesetPickerActiobHub.pickerDismissed.addListener(this._handleShelvesetUpdated),this._enableDiagnosticActionHub.toggleEnableDiagnostic.addListener(this._handleToggleEnableDiagnostic),this._queueActionHub.queueSelected.addListener(this._handleQueueSelected),this._demands=new r.ObservableArray([]),this._buildClient=this._pageContext.getRestClient("IBuildRestClient")}getSerializedVariables(){let e={};return this._runtimeVariables.value.forEach(t=>{!t.isSecret&&t.name&&t.name.trim()&&(e[t.name]=t.value)}),this._enableDiagnostic&&(e["system.debug"]="true",e["agent.diagnostic"]="true"),JSON.stringify(e)}getDemandsValues(){return this._convertDemandDataToSerializedDemand()}get demands(){return this._demands}get runtimeVariables(){return this._runtimeVariables}getSourceBranch(){if(this._buildRepository&&this._buildRepository.type&&this._buildRepository.type.toLowerCase()!==a.RepositoryTypes.TfsVersionControl.toLowerCase()){if(this._sourceBranch&&!this._sourceBranch.startsWith(l)&&!this._sourceBranch.startsWith(c))return l+this._sourceBranch;if(this._sourceTag&&!this._sourceTag.startsWith(d))return d+this._sourceTag}return this._sourceBranch}getSourceVersion(){return this._sourceVersion}getShelvesetName(){return this._shelvesetName}getSelectedQueue(){return this._selectedQueue}getEnableDiagnosticState(){return this._enableDiagnostic}getShelvesetPickerActionHub(){return this._shelvesetPickerActiobHub}getSourceControlSelectorActionHub(){return this._sourceVersionActionHub}getEnableDiagnosticActionHub(){return this._enableDiagnosticActionHub}dispose(){this._sourceVersionActionHub.versionUpdated.removeListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.removeListener(this._handleBranchUpdated),this._shelvesetPickerActiobHub.pickerDismissed.removeListener(this._handleBranchUpdated),this._queueActionHub.queueSelected.removeListener(this._handleQueueSelected)}_convertDemandDataToSerializedDemand(){let e=[];return(this._demands.value||[]).forEach(t=>{switch(t.condition){case 0:e.push(t.name.trim());break;case 1:e.push(n.format(i,t.name.trim(),t.value.trim()))}}),e}_convertSerializedDemandToDemandData(e){let t=[];if(e&&e.length>0){e.forEach((e,i)=>{let s={index:i,name:"",condition:0,value:""},a=u._demandRegex.exec(e)||{};a&&(s.name=a[1]?a[1]:"",s.value=a[4]?a[4]:"",a[3]&&a[3].length>0&&o===a[3].toLocaleLowerCase()?s.condition=1:s.condition=0),t.push(s),i++})}return t}}var h,m;u.key="build-commands-queue-build-store",u._demandRegex=/^([^\s]+)(\s+\-([^\s]+)\s+(.*))?/,u._tagVersionPrefix="GT",u.DesignerProcessType=1,t.StoresQueueBuild.QueueBuildStore=u,function(e){e.IconColumnIndex=0,e.NameColumnIndex=1,e.ConditionColumnIndex=2,e.ValueColumnIndex=3,e.DeleteColumnIndex=4}(h||(h={})),function(e){e.IconColumnIndex=0,e.NameColumnIndex=1,e.ValueColumnIndex=2,e.SecretColumnIndex=3,e.DeleteColumnIndex=4}(m||(m={}))}(),function(e){R=t.DemandsControllerView={},Object.defineProperty(t,"__esModule",{value:!0});const i="https://go.microsoft.com/fwlink/?linkid=2087182";t.DemandsControllerView.DemandsControllerView=class extends o.Component{constructor(e){super(e),this._renderRow=((e,t,i)=>{const s=t.name?n.format(B.DeleteButtonTooltip,t.name):B.DeleteButtonEmptyTooltip,a=1===t.condition?"= "+t.value:B.ExistsCondition;return o.createElement(d.ListItem,{key:"list-item"+e,index:e,details:i},o.createElement("div",{className:"variable-row flex-row h-scroll-hidden flex-grow"},o.createElement("div",{className:"flex-column h-scroll-hidden variable-row-content"},o.createElement("span",{className:"text-ellipsis primary-text"},t.name),o.createElement("span",{className:"font-size text-ellipsis secondary-text"},a)),o.createElement("span",{className:"flex flex-grow justify-end"},o.createElement("div",{className:"variable-delete-icon"},o.createElement(l.Button,{subtle:!0,className:"bolt-list-cell-content-reveal",iconProps:{iconName:"Delete"},onClick:t=>{this._deleteDemandClicked(e),t.preventDefault()},tooltipProps:{text:s}})))))}),this._demandClicked=((e,t)=>{!e.isDefaultPrevented()&&this.props.onDemandClicked&&this.props.onDemandClicked(t.data)}),this._createDemandClicked=(()=>{this.props.onDemandCreated&&this.props.onDemandCreated()}),this._deleteDemandClicked=(e=>{this.props.onDemandDeleted&&this.props.onDemandDeleted(e)}),this._itemProvider=this.props.store.demands}render(){return o.createElement("div",{className:"variables-list-container"},o.createElement("div",{className:"flex flex-row flex-center variables-title-container"},o.createElement("label",{className:"variables-demands-label title-s primary-text"},B.DemandsTabTitle),o.createElement("span",{className:"add-button-container flex-grow"},o.createElement(l.Button,{iconProps:{iconName:"Add"},onClick:this._createDemandClicked,ariaLabel:B.AddDemandButton}))),this._itemProvider.length>0&&o.createElement(d.List,{itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._demandClicked}),0===this._itemProvider.length&&o.createElement("span",{className:"empty-variables-demands-description"},o.createElement("label",null,B.EmptyDemandsDescription),o.createElement(c.Link,{href:i},B.EmptyDemandsVariablesLink)))}}}(),function(e){k=t.VariablesControllerView={},Object.defineProperty(t,"__esModule",{value:!0});const i="https://go.microsoft.com/fwlink/?linkid=2087183";t.VariablesControllerView.VariablesControllerView=class extends o.Component{constructor(e){super(e),this._renderRow=((e,t,i)=>{const s=t.name?n.format(B.DeleteButtonTooltip,t.name):B.DeleteButtonEmptyTooltip,a=t.isSecret?B.SecretValue:"= "+t.value,r=t.isSecret?o.createElement(u.Icon,{iconName:"Lock",className:"variable-icon fontSizeM secondary-text"}):o.createElement(u.Icon,{iconName:"Variable",className:"variable-icon fontSizeM secondary-text"});return o.createElement(d.ListItem,{key:"list-item"+e,index:e,details:i},o.createElement("div",{className:"variable-row flex-row h-scroll-hidden flex-grow"},r,o.createElement("div",{className:"flex-column h-scroll-hidden variable-row-content"},o.createElement("span",{className:"text-ellipsis primary-text"},t.name),o.createElement("span",{className:"font-size text-ellipsis secondary-text"},a)),o.createElement("span",{className:"flex flex-grow justify-end"},!t.disableDelete&&o.createElement("div",{className:"variable-delete-icon"},o.createElement(l.Button,{subtle:!0,className:"bolt-list-cell-content-reveal",iconProps:{iconName:"Delete"},onClick:t=>{this._deleteVariableClicked(e),t.preventDefault()},tooltipProps:{text:s}})))))}),this._variableClicked=((e,t)=>{!e.isDefaultPrevented()&&this.props.onVariableClicked&&this.props.onVariableClicked(t.data)}),this._createVariableClicked=(()=>{this.props.onVariableCreated&&this.props.onVariableCreated()}),this._deleteVariableClicked=(e=>{this.props.onVariableDeleted&&this.props.onVariableDeleted(e)}),this._itemProvider=this.props.store.runtimeVariables}render(){return o.createElement("div",{className:"variables-list-container"},o.createElement("div",{className:"flex flex-row flex-center variables-title-container"},o.createElement("label",{className:"variables-demands-label title-s primary-text"},B.VariablesTabTitle),o.createElement("span",{className:"add-button-container flex-grow"},o.createElement(l.Button,{iconProps:{iconName:"Add"},onClick:this._createVariableClicked,ariaLabel:B.AddVariableButton}))),this._itemProvider.length>0&&o.createElement(d.List,{itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._variableClicked}),0===this._itemProvider.length&&o.createElement("span",{className:"empty-variables-demands-description"},o.createElement("label",null,B.EmptyVariablesDescription),o.createElement(c.Link,{href:i},B.EmptyDemandsVariablesLink)))}}}(),function(e){T=t.VariablePanel={},Object.defineProperty(t,"__esModule",{value:!0});t.VariablePanel.VariablePanel=class extends o.Component{constructor(e){super(e),this._isValidVariableName=(()=>{const e=this.state.variable.name;return!!e&&""!==e.trim()}),this._getDuplicateValidationMessage=(()=>{const e=this.state.variable,t=e.name?e.name.trim().toLocaleLowerCase():"";return this._getDuplicateVariableNamesMap()[t]>1?n.format(B.DuplicateVariableMessage,e.name):""}),this._getDuplicateVariableNamesMap=(()=>{let e={};return this.props.runtimeVariables?((this.props.isNewVariable?this.props.runtimeVariables.value.concat([this.state.variable]):this.props.runtimeVariables.value).forEach((t,i)=>{if(t&&t.name){let i=t.name?t.name.trim().toLocaleLowerCase():"";e.hasOwnProperty(i)?e[i]++:e[i]=1}}),e):e}),this._dismissPanel=(()=>{this.setState({showPanel:!1}),this.props.onDismiss()}),this._clickOk=(()=>{this.props.isNewVariable&&this.props.onVariableAdded?this.props.onVariableAdded(this.state.variable):!this.props.isNewVariable&&this.props.onVariableUpdated&&this.props.onVariableUpdated(this.state.variable),this._dismissPanel()}),this._onNameChanged=((e,t)=>{this.state.variable.name=t,this.setState({variable:this.state.variable})}),this._onValueChanged=((e,t)=>{this.state.variable.value=t,this.setState({variable:this.state.variable})}),this.state={showPanel:this.props.showPanel,variable:this.props.variable}}render(){const e=this.props.isNewVariable?B.AddVariablePanelTitle:B.UpdateVariablePanelTitle,t=this.props.isNewVariable?B.CreateButtonText:B.UpdateButtonText,s=this._getDuplicateValidationMessage(),a=!this._isValidVariableName()||""!==s,n=this.props.isNewVariable?"variable-panel-variable-name-input":"variable-panel-variable-value-input";return o.createElement(p.Observer,{isPanelOpen:this.state.showPanel},r=>r.isPanelOpen?o.createElement(b.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},onClick:this._dismissPanel},onDismiss:this._dismissPanel,titleProps:{text:e},className:"variable-panel",defaultActiveElement:n,footerButtonProps:[{text:B.CancelButtonText,onClick:this._dismissPanel},{text:t,primary:!0,onClick:this._clickOk,disabled:a}]},r.isPanelOpen&&o.createElement(i,{variable:this.props.variable,isNewVariable:this.props.isNewVariable,validationMessage:s,onNameChanged:this._onNameChanged,onValueChanged:this._onValueChanged})):null)}};class i extends o.Component{constructor(e){super(e),this._getVariableNameControl=(()=>o.createElement("span",{className:"flex-grow"},o.createElement(m.FormItem,{className:"variable-panel-variable-name",label:B.NameFieldLabel,error:""!==this.props.validationMessage,message:this.props.validationMessage},o.createElement(_.TextField,{ref:e=>{this._nameTextFieldRef=e},value:this.props.variable.name,inputClassName:"variable-panel-variable-name-input",onChange:this.props.onNameChanged,disabled:!this.props.isNewVariable,required:!0})))),this._getVariableValueControl=(()=>{const e=this.props.variable.isSecret?"password":"text";return o.createElement("div",{className:"variable-value-container flex-grow flex-row"},o.createElement("span",{className:"variable-value-span flex-grow"},o.createElement(m.FormItem,{label:B.ValueFieldLabel,className:"variable-panel-variable-value"},o.createElement(_.TextField,{value:this.props.variable.value,inputClassName:"variable-panel-variable-value-input",ref:e=>{this._valueTextFieldRef=e},inputType:e,onChange:this.props.onValueChanged}))))}),this._getVariableSecretControl=(()=>{const e=!!this.props.variable&&this.props.variable.isSecret;return o.createElement("div",{className:"variable-secret-container"},o.createElement("span",{className:"error-icon-span"}),o.createElement("span",null,o.createElement(h.Checkbox,{label:B.SecretFieldLabel,checked:e,disabled:!0})))}),this.state={variable:this.props.variable}}render(){return o.createElement("div",{className:"variable-panel-content flex-grow"},o.createElement("div",{className:"variable-name-container flex-row"},this._getVariableNameControl()),this._getVariableValueControl(),!this.props.isNewVariable&&this.props.variable&&this.props.variable.isSecret&&this._getVariableSecretControl())}componentDidMount(){this.props.isNewVariable?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):(this._valueTextFieldRef&&this._valueTextFieldRef.focus(),this._valueTextFieldRef&&this._valueTextFieldRef.select())}}}(),function(e){q=t.DemandPanel={},Object.defineProperty(t,"__esModule",{value:!0});t.DemandPanel.DemandPanel=class extends o.Component{constructor(e){super(e),this._onNameChanged=((e,t)=>{this.state.demand.name=t,this.setState({demand:this.state.demand})}),this._onValueChanged=((e,t)=>{this.state.demand.value=t,this.setState({demand:this.state.demand})}),this._onConditionChanged=(e=>{this.state.demand.condition=e,this.setState({demand:this.state.demand})}),this._isValidName=(()=>{const e=this.state.demand;return!(!e.name||""===e.name.trim())}),this._isValidValue=(()=>{const e=this.state.demand;return!!(1!==e.condition||e.value&&""!==e.value.trim())}),this._dismissPanel=(()=>{this.setState({showPanel:!1}),this.props.onDismiss()}),this._clickOk=(()=>{this.props.isNewDemand&&this.props.onDemandAdded?this.props.onDemandAdded(this.state.demand):!this.props.isNewDemand&&this.props.onDemandUpdated&&this.props.onDemandUpdated(this.state.demand),this._dismissPanel()}),this.state={showPanel:this.props.showPanel,demand:this.props.demand}}render(){const e=this.props.isNewDemand?B.AddDemandPanelTitle:B.UpdateDemandPanelTitle,t=this.props.isNewDemand?B.CreateButtonText:B.UpdateButtonText,s=!this._isValidName()||!this._isValidValue(),a=this.props.isNewDemand?".variable-panel-demand-name":".variable-panel-demand-condition";return o.createElement(p.Observer,{isPanelOpen:this.state.showPanel},n=>n.isPanelOpen?o.createElement(b.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},onClick:this._dismissPanel},onDismiss:this._dismissPanel,titleProps:{text:e},className:"variable-panel",defaultActiveElement:a,footerButtonProps:[{text:B.CancelButtonText,onClick:this._dismissPanel},{text:t,primary:!0,onClick:this._clickOk,disabled:s}]},n.isPanelOpen&&o.createElement(i,{demand:this.state.demand,isNewDemand:this.props.isNewDemand,onNameChanged:this._onNameChanged,onConditionChanged:this._onConditionChanged,onValueChanged:this._onValueChanged})):null)}};class i extends o.Component{constructor(){super(...arguments),this._getDemandNameControl=(()=>o.createElement("span",{className:"variable-name-span"},o.createElement(m.FormItem,{className:"variable-panel-demand-name",label:B.NameFieldLabel},o.createElement(_.TextField,{value:this.props.demand.name,className:"primary-text",ref:e=>{this._nameTextFieldRef=e},onChange:this.props.onNameChanged,disabled:!this.props.isNewDemand,required:!0})))),this._getDemandConditionControl=(()=>o.createElement("div",{className:"variable-condition-container flex flex-row"},o.createElement("span",{className:"flex-grow"},o.createElement("div",{className:"demand-condition-label"},o.createElement("label",null,B.ConditionFieldLabel)),o.createElement("div",{className:"flex-grow"},o.createElement("span",{className:"variable-value-span flex flex-grow"},o.createElement(g.PickListDropdown,{selectOnFocus:!0,selectedItems:this._getSelectedCondition(),className:"flex flex-grow variable-panel-demand-condition primary-text",ref:e=>{this._conditionDropDownRef=e},getPickListItems:this._getConditions,getListItem:e=>({key:e&&e.key?e.key.toString():"",name:e?e.name:""}),onSelectionChanged:e=>this.props.onConditionChanged(e.selectedItems[0].key)})))))),this._getDemandValueControl=(()=>o.createElement("div",{className:"variable-value-container flex-row flex-grow"},o.createElement("span",{className:"variable-value-span flex-grow"},o.createElement(m.FormItem,{className:"variable-panel-variable",label:B.ValueFieldLabel},o.createElement(_.TextField,{value:this.props.demand.value,className:"primary-text",onChange:this.props.onValueChanged,required:!0}))))),this._getSelectedCondition=(()=>1===this.props.demand.condition?[{key:this.props.demand.condition,name:B.EqualsCondition}]:[{key:this.props.demand.condition,name:B.ExistsCondition}]),this._getConditions=(()=>[{key:1,name:B.EqualsCondition},{key:0,name:B.ExistsCondition}])}render(){return o.createElement("div",{className:"variable-panel-content flex-grow"},o.createElement("div",{className:"variable-name-container flex-row"},this._getDemandNameControl()),this._getDemandConditionControl(),1===this.props.demand.condition&&this._getDemandValueControl())}componentDidMount(){this.props.isNewDemand?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):this._conditionDropDownRef&&this._conditionDropDownRef.focus()}}}(),function(e){t.QueuePanel={},Object.defineProperty(t,"__esModule",{value:!0});class i extends o.Component{constructor(e){super(e),this._showPanel=!1,this._showError=!1,this._showVariablePanel=!1,this._showDemandPanel=!1,this._errorMessage="",this._enableDiagnostic=!1,this._agentSpecificationServiceErrorMessage=new r.ObservableValue(""),this._agentSpecifications=new r.ObservableArray,this._isLoadingAgentSpecifications=new r.ObservableValue(!1),this._saveCommentText=new r.ObservableValue(""),this._queueActionPending=new r.ObservableValue(!1),this._timerManagement=new w.TimerManagement,this._pendingOverlayTimeoutId=0,this._onSaveCommentChange=((e,t)=>{this._saveCommentText.value=t}),this._branchSelected=(e=>{this._sourceVersionActionCreator.updateBranch(e)}),this._versionSelected=(e=>{this._sourceVersionActionCreator.updateVersion(e)}),this._shelvesetSelected=(e=>{this._sourceVersionActionCreator.updateShelveset(e)}),this._dismissPanel=(()=>{this._showPanel=!1,this.setState(this._getState()),this.props.onDismiss()}),this._addDemandClicked=(e=>{this._queueBuildStore.addDemand(e)}),this._deleteDemandClicked=(e=>{this._queueBuildStore.deleteDemand(e)}),this._demandEdited=(e=>{this._queueBuildStore.updateDemand(e)}),this._storeChanged=(()=>{this._selectedAgentQueue=this._queueBuildStore.getSelectedQueue(),this._selectedBranch=(this._queueBuildStore.getSourceBranch()||"").replace("refs/heads/",""),this._sourceVersion=this._queueBuildStore.getSourceVersion(),this._shelvesetName=this._queueBuildStore.getShelvesetName(),this._currentCommit=this._queueBuildStore.getSourceVersion(),this._enableDiagnostic=this._queueBuildStore.getEnableDiagnosticState(),this.setState(this._getState())}),this._queueStoreChanged=(()=>{this._queues=this._queueStore.getQueues()||[],this.setState(this._getState())}),this._queueBuild=(()=>{this._pendingOverlayTimeoutId=this._timerManagement.setTimeout(this._showOverlay,250),this._runButtonDisabled=!0,this.setState({runButtonDisabled:this._runButtonDisabled});let e=Promise.resolve();this.props.isSaveEnabled&&this.props.onSave&&(e=this.props.onSave(this._saveCommentText.value));const t=this._queueBuildStore.getShelvesetName();e.then(()=>{const e=this._queueStore.getSelectedQueue(),i=e?e.id:-1,s={definitionId:this.props.definitionId,agentQueueId:i,ignoreWarnings:"Warning"===this.state.messageSeverity,projectId:this.props.projectId,pageContext:this.props.pageContext,parameters:this._queueBuildStore.getSerializedVariables(),demands:this._queueBuildStore.getDemandsValues(),sourceBranch:t||this._queueBuildStore.getSourceBranch(),sourceVersion:this._queueBuildStore.getSourceVersion(),agentSpecification:this._selectedAgentSpecification};this._actionCreator.queueBuild(s)}).catch(e=>{this._actionHub.buildQueued.invoke({build:void 0,message:e&&e.message,messageSeverity:"Error"})})}),this._onSelectedQueueChanged=(e=>{e&&(this._selectedAgentSpecification=void 0,this._queueActionCreator.selectQueue(e),this._updateAgentSpecifications(e))}),this._onToggleEnableDiagnostic=((e,t)=>{this._enableDiagnosticActionCreator.toggleEnableDiagnostic(t)}),this._onSelectedAgentSpecificationChanged=(e=>{this._selectedAgentSpecification=e,this.setState(this._getState())}),this._addVariableClicked=(e=>{this._queueBuildStore.addVariable(e)}),this._deleteVariableClicked=(e=>{this._queueBuildStore.deleteVariable(e)}),this._variabledEdited=(e=>{this._queueBuildStore.updateVariable(e)}),this._getDemandsControl=(()=>o.createElement("div",{className:"h-scroll-hidden demands-control-container"},o.createElement(R.DemandsControllerView,{store:this._queueBuildStore,onDemandCreated:this._createDemand,onDemandDeleted:this._deleteDemandClicked,onDemandClicked:this._updateDemand}),this.state.showDemandPanel&&o.createElement(q.DemandPanel,{showPanel:this.state.showDemandPanel,isNewDemand:this.state.isNewDemand,onDismiss:this._dismissDemandsPanel,demand:this.state.selectedDemand,onDemandAdded:this._addDemandClicked,onDemandUpdated:this._demandEdited}))),this._getVariablesControl=(()=>o.createElement("div",{className:"h-scroll-hidden"},o.createElement(k.VariablesControllerView,{runtimeVariables:this.props.runtimeVariables,pageContext:this.props.pageContext,project:this.props.projectId,store:this._queueBuildStore,onVariableCreated:this._createVariable,onVariableDeleted:this._deleteVariableClicked,onVariableClicked:this._updateVariable}),this.state.showVariablePanel&&o.createElement(T.VariablePanel,{showPanel:this.state.showVariablePanel,isNewVariable:this.state.isNewVariable,runtimeVariables:this._queueBuildStore.runtimeVariables,onDismiss:this._dismissVariablePanel,variable:this.state.selectedVariable,onVariableAdded:this._addVariableClicked,onVariableUpdated:this._variabledEdited}))),this._dismissVariablePanel=(()=>{this._showVariablePanel=!1,this.setState(this._getState())}),this._dismissDemandsPanel=(()=>{this._showDemandPanel=!1,this.setState(this._getState())}),this._showOverlay=(()=>{this._showPanel&&(this._queueActionPending.value=!0)}),this._createVariable=(()=>{this._showVariablePanel=!0,this._isNewVariable=!0;const e=this._queueBuildStore.runtimeVariables.length;this._selectedVariable={index:e},this.setState(this._getState())}),this._createDemand=(()=>{this._showDemandPanel=!0,this._isNewDemand=!0;const e=this._queueBuildStore.demands.length;this._selectedDemand={index:e,condition:0},this.setState(this._getState())}),this._updateVariable=(e=>{this._showVariablePanel=!0,this._selectedVariable=e,this._isNewVariable=!1,this.setState(this._getState())}),this._updateDemand=(e=>{this._showDemandPanel=!0,this._selectedDemand=e,this._isNewDemand=!1,this.setState(this._getState())}),this._handleBuildQueued=(e=>{this._publishQueueBuildTelemetry(),this._timerManagement.clearTimeout(this._pendingOverlayTimeoutId),e.build?this._onSuccess(e.build):(this._queueActionPending.value=!1,this._showError=!0,this._errorMessage=e.message||"",this._messageSeverity=e.messageSeverity||"Info",this._runButtonDisabled=!1,this.setState(this._getState()))}),this._onSuccess=(e=>{const t=this.props.pageContext.getService("IBuildLinkingService").getBuildUrl(e.id);A.onClickFPS(this.props.pageContext,t,!0)}),this._getState=(()=>({showPanel:this._showPanel,showVariablePanel:this._showVariablePanel,showDemandPanel:this._showDemandPanel,showError:this._showError,errorMessage:this._errorMessage,messageSeverity:this._messageSeverity,isRootPath:!1,queues:this._queues,selectedAgentQueue:this._selectedAgentQueue,sourceVersion:this._sourceVersion,shelvesetName:this._shelvesetName,currentCommit:this._currentCommit,selectedBranch:this._selectedBranch,agentSpecifications:this._agentSpecifications?this._agentSpecifications.value:[],selectedAgentSpecification:this._selectedAgentSpecification,isLoadingAgentSpecifications:!!this._isLoadingAgentSpecifications&&this._isLoadingAgentSpecifications.value,runButtonDisabled:this._runButtonDisabled,selectedVariable:this._selectedVariable,isNewVariable:this._isNewVariable,isNewDemand:this._isNewDemand,selectedDemand:this._selectedDemand,enableDiagnostic:this._enableDiagnostic})),this._showPanel=e.showPanel,this._runButtonDisabled=!0,this._selectedBranch=this.props.sourceBranch.replace("refs/heads/",""),this.props.runtimeVariables&&this.props.runtimeVariables.length>0&&this.props.runtimeVariables.forEach(e=>{e.disableDelete=!0}),this._actionHub=new y.QueueBuildActionHub,this._actionCreator=new y.QueueBuildActionCreator({actionHub:this._actionHub});let t=C.getSingletonManager().get(D.QueueStore.key);t?this._queues=t.getQueues():(this._queueActionHub=new D.QueueActionHub,t=new D.QueueStore({pageContext:e.pageContext,project:e.projectId,actionHub:this._queueActionHub}),C.getSingletonManager().add(D.QueueStore.key,t)),this._queueStore=t,this._queueActionHub=t.getActionHub(),this._queueActionCreator=new D.QueueActionCreator({actionHub:this._queueActionHub,source:new V.QueueSource({pageContext:this.props.pageContext,project:this.props.projectId})});let i=C.getSingletonManager().get(N.QueueBuildStore.key);i?(this._sourceVersionActionHub=i.getSourceControlSelectorActionHub(),this._shelvesetPickerActionHub=i.getShelvesetPickerActionHub(),this._enableDiagnosticActionHub=i.getEnableDiagnosticActionHub(),e.buildDefinition?i.updateBuildDefinition(e.buildDefinition,e.runtimeVariables):i.updateDefinition(e.definitionId,e.runtimeVariables,e.sourceBranch,!1,e.buildRepository)):(this._sourceVersionActionHub=new y.SourceVersionActionHub,this._shelvesetPickerActionHub=new v.ShelvesetPickerActionHub,this._enableDiagnosticActionHub=new y.EnableDiagnosticActionHub,i=new N.QueueBuildStore({pageContext:e.pageContext,projectId:e.projectId,definitionId:e.definitionId,buildDefinition:e.buildDefinition,sourceBranch:e.sourceBranch,runtimeVariables:this.props.runtimeVariables,sourceVersionActionHub:this._sourceVersionActionHub,shelvesetPickerActiobHub:this._shelvesetPickerActionHub,enableDiagnosticActionHub:this._enableDiagnosticActionHub,queueActionHub:this._queueActionHub,buildRepository:e.buildRepository}),C.getSingletonManager().add(N.QueueBuildStore.key,i)),this._queueBuildStore=i,this._sourceVersionActionCreator=new y.SourceVersionActionCreator({actionHub:this._sourceVersionActionHub}),this._enableDiagnosticActionCreator=new y.EnableDiagnosticActionCreator({actionHub:this._enableDiagnosticActionHub}),this.state=this._getState(),this._queueBuildStore.fetchDemands(),this._setupAgentSpecifications()}_setupAgentSpecifications(){this._agentSpecificationService=this.props.pageContext.getService("IAgentSpecificationService"),this._queueBuildStore.fetchBuildDefinition().then(e=>{this._buildDefinition=e;const t=e.queue;this._selectedAgentQueue={id:t.id,name:t.name,pool:t.pool,projectId:e.project.id},this._queueActionCreator.selectQueue(this._selectedAgentQueue),this._updateAgentSpecifications(this._selectedAgentQueue);const i=e.process;i&&i.target&&i.target.agentSpecification&&(this._selectedAgentSpecification=i.target.agentSpecification),this._runButtonDisabled=!1,this.setState(this._getState())}).catch(e=>{e&&e.message&&(this._errorMessage=e.message,this._showError=!0,this.setState(this._getState()))})}_updateAgentSpecifications(e){this._isLoadingAgentSpecifications.value=!0,this._runButtonDisabled=!0,this.setState(this._getState()),this._agentSpecificationService.getAgentSpecificationsByQueue(e).then(e=>{this._agentSpecificationServiceErrorMessage.value="",this._agentSpecifications.removeAll(),e&&e.length>0&&(this._agentSpecifications.push(...e),this._selectedAgentSpecification||(this._selectedAgentSpecification=e[0])),this._runButtonDisabled=!1}).catch(e=>{this._agentSpecifications.removeAll(),e&&e.message&&(this._agentSpecificationServiceErrorMessage.value=e.message)}).then(()=>{this._isLoadingAgentSpecifications.value=!1,this.setState(this._getState())})}render(){const e=!!this._buildDefinition&&this._buildDefinition.process.type===i.YamlProcessType,t=this._buildDefinition?this._buildDefinition.repository:void 0,s=t&&t.properties&&t.properties.connectedServiceId||"",n=!this._buildDefinition,r=this._getRunButtonText(),d=[],c=this.props.buildRepository.type===a.RepositoryTypes.TfsVersionControl?B.SourceVersionLabel:B.BranchLabel,u=this.props.buildRepository&&this.props.buildRepository.type&&this.props.buildRepository.type.toLowerCase()===a.RepositoryTypes.TfsVersionControl.toLowerCase()&&!this.state.sourceVersion?this.state.selectedBranch:this.state.sourceVersion,m=this.props.buildRepository&&this.props.buildRepository.type&&this.props.buildRepository.type.toLowerCase()===a.RepositoryTypes.TfsGit.toLowerCase()?B.TfsGitSourceSelectorDescription:B.GitSourceSelectorDescription;return d.push({id:"queue-panel-close-button",onActivate:this._dismissPanel,ariaLabel:B.CloseButtonAriaLabel,iconProps:{iconName:"Cancel"},subtle:!0}),o.createElement(p.Observer,{isPanelOpen:this._showPanel,queueActionPending:this._queueActionPending},t=>t.isPanelOpen?o.createElement(b.CustomPanel,{className:"queue-panel flex-column h-scroll-hidden",lightDismiss:!t.queueActionPending,onDismiss:this._dismissPanel},o.createElement(x.Header,{className:"bolt-panel-header body-xl",commandBarItems:d},B.QueuePanelTitleNoDefinition,o.createElement("div",{className:"secondary-text fontSizeM"},B.QueuePanelDescription)),o.createElement(b.PanelContent,null,o.createElement("div",{className:"flex-column flex-grow"},this.state.showError&&o.createElement(E.MessageCard,{className:"queue-build-error",severity:this.state.messageSeverity},this.state.errorMessage),t.isPanelOpen&&!n&&o.createElement(o.Fragment,null,!e&&o.createElement(o.Fragment,null,this._getSaveCommentContent(),this._getAgentPools()),o.createElement(S.BranchDropdown,{className:"vertical-spacing flex-column label",label:c,repositoryType:this.props.buildRepository.type,repositoryId:this.props.buildRepository.id,defaultBranch:this.state.selectedBranch,description:m,connectionId:s,sourceVersion:u,shelvesetName:this.state.shelvesetName,currentCommit:this.state.currentCommit,projectId:this.props.projectId,onBranchSelected:this._branchSelected,onVersionSelected:this._versionSelected,onShelvesetSelected:this._shelvesetSelected,viewCommits:!0,viewTags:!0,pageContext:this.props.pageContext,actionHub:this._shelvesetPickerActionHub}),this._getVariablesControl(),!e&&this._getDemandsControl()),n&&t.isPanelOpen&&o.createElement(P.Spinner,{className:"queue-build-spinner"}))),o.createElement(b.PanelFooter,{className:"flex-row"},o.createElement(h.Checkbox,{label:B.RunWithDiagnostics,className:"diagnostic-checkbox flex-grow",onChange:this._onToggleEnableDiagnostic,checked:this.state.enableDiagnostic}),o.createElement(l.Button,{text:B.CancelButtonText,className:"queue-panel-cancel-button",onClick:this._dismissPanel}),o.createElement(l.Button,{text:r,primary:!0,onClick:this._queueBuild,disabled:this.state.runButtonDisabled})),t.queueActionPending&&o.createElement(b.PanelOverlay,{overlayContent:o.createElement(P.Spinner,{label:B.StartingRun})})):null)}_getSaveCommentContent(){return this.props.isSaveEnabled?o.createElement(o.Fragment,null,o.createElement("label",{className:"label"},B.SaveComment),o.createElement(_.TextField,{value:this._saveCommentText,onChange:this._onSaveCommentChange}),o.createElement("hr",null)):null}_getAgentPools(){return o.createElement(p.Observer,{agentSpecifications:this._agentSpecifications,errorMessage:this._agentSpecificationServiceErrorMessage,isLoading:this._isLoadingAgentSpecifications},e=>o.createElement(f.AgentQueueSelector,{agentSpecifications:[...e.agentSpecifications],isLoadingAgentSpecifications:e.isLoading,selectedAgentSpecification:this.state.selectedAgentSpecification,onAgentSpecificationSelected:this._onSelectedAgentSpecificationChanged,agentSpecificationErrorMessage:e.errorMessage,label:B.AgentPool,agentQueues:this.state.queues,selectedQueue:this._selectedAgentQueue,onAgentChanged:this._onSelectedQueueChanged}))}_getRunButtonText(){return this.props.isSaveEnabled?"Warning"!==this.state.messageSeverity?B.SaveAndQueueButtonText:B.SaveAndRunWithWarningsButtonText:"Warning"!==this.state.messageSeverity?B.QueueButtonText:B.RunWithWarningsButtonText}componentDidMount(){this._actionHub.buildQueued.addListener(this._handleBuildQueued),this._queueStore.addListener(this._queueStoreChanged),this._queueBuildStore.addListener(this._storeChanged)}componentWillUnmount(){this._actionHub.buildQueued.removeListener(this._handleBuildQueued),this._queueStore.removeListener(this._queueStoreChanged),this._queueBuildStore.removeListener(this._storeChanged),this._timerManagement.dispose()}_publishQueueBuildTelemetry(){const e=this._queueBuildStore.getDemandsValues(),t=this._queueBuildStore.getVariables(),i={};i.variablesCount=t?t.length:0,i.customDemandsCount=e?e.length:0,i.buildDefinitionId=this.props.definitionId,this.props.pageContext.getService("IVssTelemetryService").publishEvent("Build","queueBuild",i)}}i.YamlProcessType=2,t.QueuePanel.QueuePanel=i}()},["Resources","Action","Stores/QueueBuild","DemandsControllerView","VariablesControllerView","VariablePanel","DemandPanel","QueuePanel"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.queue-panel"}}));