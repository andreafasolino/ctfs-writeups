"use strict";define("Build/DesignerExtensions/YamlSnippetForm",["require","exports","DistributedTask/Client/RestClient/TaskAgent","ServiceEndpoints/Client/RestClient/ServiceEndpoint","ServiceEndpoints/Client/Constants/ServiceEndpoint","Build/DesignerExtensions/YamlAssistantLibrary/Contracts/Constants","VSS/Platform/Util/Cookie","VSS/Core/Util/String","react","VSS/Core/Util/Object","VSSUI/Util","VSSUI/PickList","VSSUI/Observer","VSSUI/Icon","VSSUI/Spinner","VSSUI/Button","VSS/Core/Observable","VSSUI/RadioButton","VSSUI/Checkbox","VSSUI/FormItem","VSSUI/TextField","Pipelines/Common/Library/Contracts/Constants","Build/Flux/Store","DistributedTask/Common/AadAuthorizer/AadAuthorizer","Tfs/Platform/Page","VSS/Platform/Feature","VSS/Platform/Layout","VSSUI/Link","VSSUI/FocusZone","Build/CollapsibleSectionGroup/CollapsibleSectionGroup"],function(e,t,s,i,n,r,o,a,p,u,c,l,d,h,m,g,S,b,y,C,_,v,f,E,I,N,V,k,P,T){var A,D,x,R,z,L,w,B,O,F,M,j,G;A=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.Authorize="Authorize",t.Resources.Authorizing="Authorizing...",t.Resources.Connecting="Connecting...",t.Resources.NeedsAuthorizing="This subscription requires authorization",t.Resources.AzureSubscriptionPanelTitle="Azure service connection",t.Resources.Connect="Connect",t.Resources.Cancel="Cancel",t.Resources.FailedToFindSnippet="Could not find task for {0}",t.Resources.FailedToFindServiceConnection="Failed to connect to {0}",t.Resources.AddSnippetYaml="Add",t.Resources.CancelSnippetYaml="Cancel",t.Resources.AzureConnectionGroupTitle="Service connections",t.Resources.AzureSubscriptionGroupTitle="Subscriptions",t.Resources.AzureConnectionsEmptyMessage="No subscription or service connection found",t.Resources.FailedToLoadSnippet="Error loading task: {0}",t.Resources.NoServiceConnections="No existing service connections of the appropriate type could be found",t.Resources.NoResultsFound="No results found",t.Resources.NoAzureRMResults="No Azure service connections or subscriptions could be found",t.Resources.CreateRMTimeout="Timed out waiting for the service connection to be ready",t.Resources.TaskReference="About this task",t.Resources.UnsupportedSnippetMessage="The guide for this task is not yet supported, but you can add an outline for it.",t.Resources.AddSnippetOutlineYaml="Add outline",t.Resources.ProjectInfoNotFound="Could not find information for the project selected",t.Resources.ResourcesCannotBeCreated="Kubernetes resources cannot be created. Please review the template definition.",t.Resources.UnknownDatasourceError="Unknown datasource error",t.Resources.EndpointNotFound="The endpoint {0} cannot be found or has been deleted. Please retry the pipeline creation.",function(e){D=t.SourcesSnippetFormSource={},Object.defineProperty(t,"__esModule",{value:!0});t.SourcesSnippetFormSource.SnippetFormSource=class{constructor(e){this._sleepTimeAwaitingEndpoint=1e3,this._dtClient=s.getTaskAgentClient(e),this._serviceEndpointClient=i.getServiceEndpointClient(e),this._telemetryService=e.getService("IVssTelemetryService");const t=e.getService("ITfsPageService");this._projectId=t.getData().project.id}async getAzureSubscriptions(){return this._dtClient.getAzureSubscriptions().then(e=>e.value)}async getServiceConnections(e){return this._dtClient.getServiceEndpoints(this._projectId,e,void 0,void 0,void 0)}async createAzureRMConnection(e){this._telemetryService&&this._telemetryService.publishEvent(r.TelemetryConstants.Area,r.TelemetryConstants.createAzureRM,{});const t={authorization:{parameters:{authenticationType:n.AzureEndpointConstants.spnKeyAuthType,tenantId:e.subscriptionTenantId},scheme:n.EndpointAuthorizationSchemes.ServicePrincipal},data:{creationMode:n.AzureEndpointConstants.SpnCreationModeAutomatic,environment:n.AzureEndpointConstants.DefaultAzureEnvironment,scopeLevel:n.AzureEndpointConstants.SubscriptionString,subscriptionId:e.subscriptionId,subscriptionName:e.displayName},type:r.AzureRMConnectionType,name:e.displayName+"("+e.subscriptionId+")"},s=await this._dtClient.createServiceEndpoint(t,this._projectId);return this._returnEndpointWhenReady(s.id)}async getDataSourceResources(e,t,s,i,n){t=r.InternalDataSources[e.type]||t;const o={dataSourceDetails:{dataSourceName:e.dataSourceBinding.dataSourceName,dataSourceUrl:e.dataSourceBinding.endpointUrl,headers:[],resourceUrl:"",resultSelector:e.dataSourceBinding.resultSelector,initialContextTemplate:e.dataSourceBinding.initialContextTemplate,parameters:Object.assign({},e.dataSourceBinding.parameters,i)},resultTransformationDetails:{resultTemplate:e.dataSourceBinding.resultTemplate,callbackContextTemplate:e.dataSourceBinding.callbackContextTemplate,callbackRequiredTemplate:e.dataSourceBinding.callbackRequiredTemplate},serviceEndpointDetails:s};e.dataSourceDependency&&(o.dataSourceDetails.parameters[e.dataSourceDependency]=t);let a=[];a=await this._getServiceEndpointResult(o,t,a,n);let p={};return a&&a.length>0&&a.forEach(t=>{if(e.dataSourceBinding.resultTemplate){const e=JSON.parse(t);e.DisplayValue&&e.Value&&(p[e.Value]=e.DisplayValue)}else p[t]=t}),p}async _getServiceEndpointResult(e,t,s,i){if(!i){const s=await this._serviceEndpointClient.executeServiceEndpointRequest(e,this._projectId,t),i=parseInt(s.statusCode);if(s.errorMessage&&404!==i)throw new Error(s.errorMessage);return s.result}const n=await this._serviceEndpointClient.executeServiceEndpointRequest(e,this._projectId,t);if(n.errorMessage){if(0==s.length)throw new Error(n.errorMessage)}else{const e=n.result;e&&e.length>0&&(s=s.concat(e))}return n.callbackRequired&&(Object.assign(e.dataSourceDetails.parameters,n.callbackContextParameters),s=await this._getServiceEndpointResult(e,t,s,i)),s}async _returnEndpointWhenReady(e){let t=await this._dtClient.getServiceEndpointDetails(this._projectId,e),s=0;for(;!t.isReady;){if(t.operationStatus&&"Failed"===t.operationStatus.state)throw new Error(t.operationStatus.statusMessage);if(s>=120)throw new Error(A.CreateRMTimeout);s++,await this._sleep(this._sleepTimeAwaitingEndpoint),t=await this._dtClient.getServiceEndpointDetails(this._projectId,e)}return t}async _sleep(e){return new Promise(t=>setTimeout(t,e))}_getDebugSubscriptions(){if(!this._debugSubscriptions){this._debugSubscriptions=[];for(let e=1;e<10;++e)this._debugSubscriptions.push({displayName:"sub "+e,subscriptionId:""+e,subscriptionTenantId:"tenant"+e,subscriptionTenantName:"tenant "+e})}return this._debugSubscriptions}_getDebugServiceConnections(){if(!this._debugServiceConnections){this._debugServiceConnections=[];for(let e=1;e<10;++e)this._debugServiceConnections.push({name:"sc "+e,id:"sc"+e})}return this._debugServiceConnections}}}(),function(e){x=t.UtilitiesVisibilityHelper={},Object.defineProperty(t,"__esModule",{value:!0});const s="&&",i="||";t.UtilitiesVisibilityHelper.VisibilityHelper=class{static getVisibility(e,t){const i=this._getVisibilityRule(e);if(!i)return!0;let n=i.operator===s;for(let e=0,s=i.predicateRules.length;e<s;e++){const s=i.predicateRules[e];if(!s)continue;let r=t(s.inputName);const o=this._getPredicateResult(s,r);n=this._evaluate(n,o,i.operator)}return n}static _getVisibilityRule(e){let t=null;if(e)if(-1!==e.indexOf(s)){let i=e.split(s).map(this._getPredicateRule);t={operator:s,predicateRules:i}}else if(-1!==e.indexOf(i)){let s=e.split(i).map(this._getPredicateRule);t={operator:i,predicateRules:s}}else t={operator:null,predicateRules:[this._getPredicateRule(e)]};return t}static _getPredicateRule(e){let t=null,s=/([a-zA-Z0-9 ]+)([!=<>]+)([a-zA-Z0-9. ]+)|([a-zA-Z0-9 ]+(?=NotContains|NotEndsWith|NotStartsWith))(NotContains|NotEndsWith|NotStartsWith)([a-zA-Z0-9. ]+)|([a-zA-Z0-9 ]+(?=Contains|EndsWith|StartsWith))(Contains|EndsWith|StartsWith)([a-zA-Z0-9. ]+)/g.exec(e);return s&&10===s.length&&(t=s[1]?{inputName:s[1].trim(),condition:s[2].trim(),expectedValue:s[3].trim()}:s[4]?{inputName:s[4].trim(),condition:s[5].trim(),expectedValue:s[6].trim()}:{inputName:s[7].trim(),condition:s[8].trim(),expectedValue:s[9].trim()}),t}static _getPredicateResult(e,t){let s=!1,i=t?t.toString().toLowerCase():t;if(e){let n=e.expectedValue?e.expectedValue.toString().toLowerCase():e.expectedValue;switch(e.condition){case"=":case"==":s=i===n;break;case"!=":s=i!==n;break;case"<":s=i<n;break;case">":s=i>n;break;case"<=":s=i<=n;break;case">=":s=i>=n;break;case"Contains":s=!!t&&t.indexOf(n)>=0;break;case"StartsWith":s=!!t&&a.startsWith(t,n,!0);break;case"EndsWith":s=!!t&&a.endsWith(t,n,!0);break;case"NotContains":s=!(t&&t.indexOf(n)>=0);break;case"NotStartsWith":s=!(t&&a.startsWith(t,n,!0));break;case"NotEndsWith":s=!(t&&a.endsWith(t,n,!0))}}return s}static _evaluate(e,t,n){return n===s?e&&t:n===i?e||t:null!==n||t}}}(),function(e){R=t.ComponentsEnhancedPickList={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsEnhancedPickList.EnhancedPickList=class extends p.PureComponent{constructor(e){super(e),this._getListItem=(e=>e),this._dropdownId=u.getId("yaml-snippet-panel-picklist")}render(){return p.createElement("div",{className:c.css("flex-column",this.props.required&&"required")},p.createElement("label",{id:this._dropdownId,className:"bolt-textfield-label"},this.props.label),p.createElement("span",{className:"flex-row"},p.createElement(l.PickListDropdown,Object.assign({className:c.css("flex-grow h-scroll-hidden"),ariaDescribedBy:this._dropdownId,getListItem:this._getListItem},this.props))),this._statusMessage())}_statusMessage(){return this.props.status?p.createElement(d.Observer,{status:this.props.status},e=>{if(!e.status)return null;const t=e.status instanceof Error,s=t?e.status.message:e.status;return p.createElement("div",{"aria-live":"assertive"},p.createElement("span",{className:c.css("picklist-status-message flex-row",t&&"picklist-status-message-error")},p.createElement(h.Icon,{iconName:"Info",className:c.css(t&&"errorIcon")}),p.createElement("div",{className:"picklist-status-message-content body-s"},s)))}):null}}}(),function(e){z=t.ComponentsAzureSubscriptionPickList={},Object.defineProperty(t,"__esModule",{value:!0});const s="connections",i="subscriptions";t.ComponentsAzureSubscriptionPickList.AzureSubscriptionPickList=class extends p.PureComponent{constructor(e){super(e),this._status=new S.ObservableValue(void 0),this._getListItems=(()=>this.state.items?this.state.items:this._loadSubscriptions()),this._onSelectionChanged=(e=>{const t=e.selectedItems[0].key;this.state.subscriptions[t]?(this._status.value=A.NeedsAuthorizing,this.setState({selectedSubscriptionKey:t,selectedConnectionKey:void 0})):this.state.connections[t]&&(this._status.value=void 0,this.setState({selectedConnectionKey:t,selectedSubscriptionKey:void 0}),this.props.onValueChanged(this.props.inputDefinition.name,t,e.selectedItems[0].name))}),this._onAuthorize=(async()=>{try{const e=this.state.selectedSubscriptionKey&&this.state.subscriptions[this.state.selectedSubscriptionKey];if(!e)return Promise.resolve(void 0);this.setState({authorizing:!0});const t=await this.props.serviceConnectionProvider.createAzureRMConnection(e),s=Object.assign({},this.state.connections,{[t.id]:t});this.props.onValueChanged(this.props.inputDefinition.name,t.id,t.name),this._status.value=void 0,this.setState({connections:s,selectedConnectionKey:t.id,selectedSubscriptionKey:void 0,items:this._buildConnectionOptions(this.state.subscriptions,s),authorizing:!1})}catch(e){this._status.value=e,this.setState({authorizing:!1}),this.props.onError("AzureSubscriptionPickList._onAuthorize",e)}}),this.state={loading:!0,subscriptions:{},connections:{},authorizing:!1}}render(){const e=[{key:s,name:A.AzureConnectionGroupTitle,isLoading:this.state.loading},{key:i,name:A.AzureSubscriptionGroupTitle,isLoading:this.state.loading}],t=this.state.selectedConnectionKey||this.state.selectedSubscriptionKey,n=this.state.items&&this.state.items.find(e=>e.key===t);let r=this.state.selectedSubscriptionKey,o=this.state.authorizing?A.Authorizing:A.Authorize,a=this.state.authorizing;return p.createElement("div",{className:"flex-column"},p.createElement(R.EnhancedPickList,{label:this.props.inputDefinition.label,groups:e,getPickListItems:this._getListItems,selectedItems:n&&[n],status:this._status,onSelectionChanged:this._onSelectionChanged,required:this.props.inputDefinition.required,noItemsText:A.NoAzureRMResults}),r&&p.createElement(g.Button,{className:"authorize-button flex-self-start",onClick:this._onAuthorize,primary:!0,disabled:this.state.authorizing},a&&p.createElement(m.Spinner,{size:"small"}),o))}componentDidMount(){this._loadSubscriptions()}async _loadSubscriptions(){try{const e=this.props.serviceConnectionProvider.getAzureSubscriptions(),t=this.props.serviceConnectionProvider.getServiceConnections(r.AzureRMConnectionType),s=await e,i=await t,n=s.reduce((e,t)=>(e[t.subscriptionId]=t,e),{}),o=i.reduce((e,t)=>(e[t.id]=t,e),{}),a=this._buildConnectionOptions(n,o);return this.setState({loading:!1,items:a,subscriptions:n,connections:o}),a}catch(e){return this._status.value=e,this.setState({loading:!1,items:[]}),this.props.onError("AzureSubscriptionPickList._loadSubscriptions",e),[]}}_buildConnectionOptions(e,t){let n=[],r=Object.keys(t);if(r.length>0){const e=r.map(e=>({key:t[e].id,name:t[e].name,groupKey:s}));e.sort((e,t)=>e.name.localeCompare(t.name)),n=n.concat(e)}let o=Object.keys(e);if(o.length>0){const t=o.map(t=>({key:e[t].subscriptionId,name:this._getSubscriptionDisplayName(e[t]),groupKey:i}));t.sort((e,t)=>e.name.localeCompare(t.name)),n=n.concat(t)}return 0===n.length&&n.push({key:"Empty",name:A.AzureConnectionsEmptyMessage}),n}_getSubscriptionDisplayName(e){return e.displayName+"("+e.subscriptionId+")"}}}(),function(e){L=t.ComponentsDataSourcePickList={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsDataSourcePickList.DataSourcePickList=class extends p.Component{constructor(e){super(e),this._error=new S.ObservableValue(void 0),this._getListItems=(()=>{const e=this.props.getValue(this.props.inputDefinition.dataSourceDependency),t=this._getParameters(),s=e+Object.keys(t).map(e=>t[e]);return s===this._lastCheckedDependencies&&!this._error.value&&this._cachedPromise?this._cachedPromise:(this._lastCheckedDependencies=s,this._cachedPromise=this._loadItems(e,t),this._cachedPromise)}),this._onSelectionChanged=(e=>{const t=e.selectedItems[0].key;this.props.onValueChanged(this.props.inputDefinition.name,t)}),this.state={}}render(){const e=this.props.getValue(this.props.inputDefinition.dataSourceDependency)||r.InternalDataSources[this.props.inputDefinition.type],t=!(!this.props.validateDatasourceParameters||this.props.validateDatasourceParameters(this.props.inputDefinition))||!e;return!t&&this.props.preloadItems&&this._getListItems(),p.createElement(R.EnhancedPickList,{label:this.props.inputDefinition.label,getPickListItems:this._getListItems,initiallySelectedItems:[],onSelectionChanged:this._onSelectionChanged,status:this._error,required:this.props.inputDefinition.required,disabled:t,noItemsText:A.NoResultsFound})}async _loadItems(e,t){try{const s=await this.props.serviceConnectionProvider.getDataSourceResources(this.props.inputDefinition,e,this.props.serviceEndpointDetails,t,this.props.makeRecursiveDatasourceCalls);let i=[];return Object.keys(s).forEach(e=>{i.push({key:e,name:s[e]})}),i.sort((e,t)=>e.name.localeCompare(t.name)),this._error.value=void 0,i}catch(e){return e?e instanceof Error||(e=new Error(e)):e=new Error(A.UnknownDatasourceError),this._error.value=e,this.props.onError("DataSourcePickList._loadItems",e),[]}}_getParameters(){let e={};return Object.keys(this.props.inputDefinition.dataSourceBinding.parameters).forEach(t=>{let s=this.props.inputDefinition.dataSourceBinding.parameters[t];0===s.indexOf("$(")&&(s=this.props.getValue(s.substr(2,s.length-3))),e[t]=s}),e}}}(),function(e){w=t.ComponentsServiceConnectionPickList={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsServiceConnectionPickList.ServiceConnectionPickList=class extends p.Component{constructor(e){super(e),this._error=new S.ObservableValue(void 0),this._getListItems=(()=>this._items&&!this._error.value?this._items:this._loadConnections()),this._onSelectionChanged=(e=>{const t=e.selectedItems[0].key,s=e.selectedItems[0].name;this.props.onValueChanged(this.props.inputDefinition.name,t,s)}),this.state={}}render(){return p.createElement(R.EnhancedPickList,{label:this.props.inputDefinition.label,getPickListItems:this._getListItems,initiallySelectedItems:[],onSelectionChanged:this._onSelectionChanged,status:this._error,required:this.props.inputDefinition.required,noItemsText:A.NoServiceConnections})}componentDidMount(){this._loadConnections()}async _loadConnections(){try{const e=await this.props.serviceConnectionProvider.getServiceConnections(this.props.connectionType);let t=[];return e.forEach(e=>{t.push({key:e.id,name:e.name})}),t.sort((e,t)=>e.name.localeCompare(t.name)),this._items=t,this._error.value=void 0,t}catch(e){return this._items=[],this._error.value=e,this.props.onError("ServiceConnectionPickList._loadConnections",e),[]}}}}(),function(e){B=t.ComponentsRadioGroup={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsRadioGroup.RadioGroup=class extends p.Component{constructor(e){super(e),this._onChange=(e=>{this.props.onValueChanged(this.props.inputDefinition.name,e)}),this._groupId=u.getId("yaml-snippet-panel-radiogroup")}render(){let e=this.props.getValue(this.props.inputDefinition.name),t=this.props.direction?this.props.direction:2;return p.createElement("div",{className:"flex-column"},p.createElement("label",{htmlFor:this._groupId,className:"bolt-textfield-label"},this.props.inputDefinition.label),p.createElement(b.RadioButtonGroup,{className:c.css(this.props.inputDefinition.required&&"required"),selectedButtonId:e,onSelect:this._onChange,id:this._groupId,direction:t},this._radioButtons()))}_radioButtons(){let e=[];return Object.keys(this.props.inputDefinition.options).forEach(t=>{e.push(p.createElement(b.RadioButton,{key:t,id:t,text:this.props.inputDefinition.options[t]}))}),e}}}(),function(e){O=t.ComponentsSnippetInput={},Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentsSnippetInput.unsupportedInputs=function(e){const t=[];return e.forEach(e=>{e.type===v.InputTypes.BOOL||e.type===v.InputTypes.STRING||e.type===v.InputTypes.PICKLIST||e.type===v.InputTypes.RADIO||e.type===v.InputTypes.INT||e.type===v.InputTypes.MULTILINE||0===e.type.indexOf(r.DataSourcePrefix)||0===e.type.indexOf(r.ConnectedServicePrefix)||r.InternalDataSources[e.type]||t.push(e.type)}),t};t.ComponentsSnippetInput.SnippetInput=class extends p.Component{render(){if(!this.props.isVisible)return null;const e=this.props.snippetInput,t=this.props.getValue(e.name);switch(e.type){case v.InputTypes.BOOL:return p.createElement(y.Checkbox,{className:c.css(e.required&&"required","yaml-snippet-checkbox"),label:e.label,checked:"true"===t,onChange:(t,s)=>this.props.onValueChanged(e.name,!0===s?"true":"false")});case v.InputTypes.FILEPATH:case v.InputTypes.STRING:case v.InputTypes.INT:return p.createElement(C.FormItem,{className:c.css(e.required&&"required"),label:e.label},p.createElement(_.TextField,{value:t,onChange:(t,s)=>this.props.onValueChanged(e.name,s)}));case v.InputTypes.MULTILINE:return p.createElement(C.FormItem,{className:c.css(e.required&&"required"),label:e.label},p.createElement(_.TextField,{className:"snippet-multiline",value:t,multiline:!0,autoAdjustHeight:!0,rows:3,onChange:(t,s)=>this.props.onValueChanged(e.name,s)}));case v.InputTypes.PICKLIST:{const t={key:e.defaultValue,name:e.options[e.defaultValue]};return p.createElement(R.EnhancedPickList,{label:e.label,required:e.required,initiallySelectedItems:[t],onSelectionChanged:t=>this.props.onValueChanged(e.name,t.selectedItems[0].key),getPickListItems:()=>Object.keys(e.options).map(t=>({key:t,name:e.options[t]}))})}case v.InputTypes.RADIO:return p.createElement(B.RadioGroup,{inputDefinition:e,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue})}if(0===e.type.indexOf(r.DataSourcePrefix)||r.InternalDataSources[e.type])return p.createElement(L.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this.props.serviceConnectionProvider,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue,validateDatasourceParameters:this.props.validateDatasourceParameters,onError:this.props.onError});if(0===e.type.indexOf(r.ConnectedServicePrefix)){const t=e.type.substr(r.ConnectedServicePrefix.length).toLowerCase();switch(t){case r.AzureRMConnectionType:return p.createElement(z.AzureSubscriptionPickList,{inputDefinition:e,serviceConnectionProvider:this.props.serviceConnectionProvider,onValueChanged:this.props.onValueChanged,onError:this.props.onError});default:return p.createElement(w.ServiceConnectionPickList,{inputDefinition:e,connectionType:t,serviceConnectionProvider:this.props.serviceConnectionProvider,onValueChanged:this.props.onValueChanged,onError:this.props.onError})}}return p.createElement(C.FormItem,{className:c.css(e.required&&"required"),label:e.label},p.createElement(_.TextField,{value:t,onChange:(t,s)=>this.props.onValueChanged(e.name,s)}))}}}(),function(e){F=t.ComponentsSnippetInputGroup={},Object.defineProperty(t,"__esModule",{value:!0});class s extends p.Component{render(){return p.createElement("div",{className:c.css("snippet-input-group flex-column",this.props.className)},this.props.inputs.map(e=>p.createElement(O.SnippetInput,{key:e.name,snippetInput:e,isVisible:this.props.inputValueProvider.isVisible(e.name),onValueChanged:this.props.inputValueProvider.setValue,getValue:this.props.inputValueProvider.getValue,validateDatasourceParameters:this.props.inputValueProvider.validateDatasourceParameters,serviceConnectionProvider:this.props.serviceConnectionProvider,onError:this.props.onError})))}}t.ComponentsSnippetInputGroup.SnippetInputList=s;class i{constructor(e,t,s,i,n,r,o){this.groupKey=e,this.groupTitle=t,this.isCollapsed=s,this.inputs=i,this.inputValueProvider=n,this.serviceConnectionProvider=r,this.onError=o}get key(){return this.groupKey}get title(){return this.groupTitle}onRenderContent(){return p.createElement(s,{inputs:this.inputs,inputValueProvider:this.inputValueProvider,serviceConnectionProvider:this.serviceConnectionProvider,onError:this.onError})}}t.ComponentsSnippetInputGroup.SnippetInputGroup=i,t.ComponentsSnippetInputGroup.getSnippetInputGroups=function(e,t,s,n,r,o){const a=[];return t.forEach(t=>{a.push(new i(t.name,t.displayName,s(t.name),e[t.name],n,r,o))}),a}}(),function(e){M=t.StoresSnippetFormStore={},Object.defineProperty(t,"__esModule",{value:!0});t.StoresSnippetFormStore.SnippetFormStore=class extends f.Store{constructor(){super(...arguments),this._inputsByGroup={},this._groupCollapsedState={},this._inputsByName={},this._inputValues={},this._inputValueAliases={},this._inputVisibility={},this._groupVisibility={},this.getValuesForExport=(()=>{let e={};return this._snippet.inputs.forEach(t=>{this._snippet.includeInputs.some(e=>e===t.name)?e[t.name]=t.defaultValue:t.required&&this._inputVisibility[t.name]&&t.defaultValue&&(t.groupName===r.UnparentedInputsGroupName||this._groupVisibility[t.groupName])&&(e[t.name]=t.defaultValue)}),Object.keys(this._inputValues).forEach(t=>{void 0!==this._inputValueAliases[t]&&this._inputValueAliases[t]!==this._inputsByName[t].defaultValue?e[t]=this._inputValueAliases[t]:void 0!==this._inputValues[t]&&this._inputValues[t]!==this._inputsByName[t].defaultValue&&(e[t]=this._inputValues[t])}),Object.keys(this._inputVisibility).forEach(t=>{this._inputVisibility[t]||delete e[t]}),e}),this.setValue=((e,t,s)=>{this._inputValues[e]=t,s&&(this._inputValueAliases[e]=s),this._updateVisibilityMaps(),this.emitChanged()}),this.getValue=(e=>this._inputVisibility[e]?void 0!==this._inputValues[e]?this._inputValues[e]:this._inputsByName[e]&&this._inputsByName[e].defaultValue||"":""),this.isVisible=(e=>this._inputVisibility[e]),this.isGroupVisible=(e=>this._groupVisibility[e]),this.isGroupCollapsed=(e=>this._groupCollapsedState[e]),this.toggleGroup=(e=>{const t=this._groupCollapsedState[e].value;this._groupCollapsedState[e].value=!t}),this.validateDatasourceParameters=(e=>{let t=!0;return Object.keys(e.dataSourceBinding.parameters).forEach(s=>{let i=e.dataSourceBinding.parameters[s];0===i.indexOf("$(")&&(i=i.substr(2,i.length-3),this._inputsByName[i]&&!this.getValue(i)&&(t=!1))}),t})}loadSnippet(e){this._snippet=e,this._inputsByGroup={},this._inputsByName={},this._organizeInputs(),this._updateVisibilityMaps(),this._findInitiallyExpandedGroups(),this._unsupportedInputs=O.unsupportedInputs(Object.keys(this._inputsByName).map(e=>this._inputsByName[e])),this.emitChanged()}get visibleGroups(){return this._snippet.groups.filter(e=>this._groupVisibility[e.name]&&this._inputsByGroup[e.name]&&this._inputsByGroup[e.name].length>0)}get snippet(){return this._snippet}get inputsByGroup(){return this._inputsByGroup}get isSnippetSupported(){return 0===this._unsupportedInputs.length}get unsupporedInputTypes(){return this._unsupportedInputs}hasInputType(e){let t=!1;return Object.keys(this._inputsByName).forEach(s=>{this._inputsByName[s].type===e&&(t=!0)}),t}_organizeInputs(){this._snippet.inputs.forEach(e=>{this._inputsByGroup[e.groupName]||(this._inputsByGroup[e.groupName]=[]),this._inputsByGroup[e.groupName].push(e),this._inputsByName[e.name]=e})}_updateVisibilityMaps(){this._snippet.inputs.forEach(e=>{this._inputVisibility[e.name]=x.VisibilityHelper.getVisibility(e.visibleRule,this.getValue)}),this._snippet.groups.forEach(e=>{0===(this._inputsByGroup[e.name]||[]).filter(e=>this._inputVisibility[e.name]).length?this._groupVisibility[e.name]=!1:this._groupVisibility[e.name]=x.VisibilityHelper.getVisibility(e.visibleRule,this.getValue)})}_findInitiallyExpandedGroups(){this._snippet.groups.forEach(e=>{let t=!1;t=!1===e.isExpanded||e.displayName.trim().toLowerCase().indexOf("advanced")>=0,this._groupCollapsedState[e.name]=new S.ObservableValue(t)})}}}(),function(e){var n,r;j=t.UtilitiesEndpointHelper={},Object.defineProperty(t,"__esModule",{value:!0});class o{}o.AuthSchemes=((n=class{}).docker="Docker",n.kubernetes="Kubernetes",n.servicePrincipal="serviceprincipal",n),o.EndpointTypes=((r=class{}).docker="dockerregistry",r.kubernetes="Kubernetes",r.azureRM="azurerm",r),o.azureEnvironment="AzureCloud",o.azureManagementUrl="https://management.azure.com/",t.UtilitiesEndpointHelper.EndpointConstants=o;const p="WebAccess.AutoCreateServicePrincipalCompleteCallbackByAuthcode";class u{static _getClusterNameFromClusterId(e){let t="";if(e){const s=e.split("/"),i=s.findIndex(e=>"managedClusters"===e)+1;i>0&&(t=s[i])}return t}static async getAuthorizationToken(e,t){const i=s.getTaskAgentClient(e),n=await i.getVstsAadTenantId();if(t&&n&&n.toLocaleLowerCase()!=t.subscriptionAccount.subscriptionTenantId.toLocaleLowerCase()){const s=new E.AadAuthorizer(e),i=I.getTFSPageData(e);if(i&&i.project){return await s.getAccessTokenKey(i.project,t.subscriptionAccount.subscriptionTenantId,n)}}}static getAzureRMServiceEndpointDetails(e,t,s){if(!t)return{};let i={accessTokenType:"AppToken",tenantId:t.subscriptionAccount.subscriptionTenantId};return s&&(i.accessToken=s,N.isFeatureFlagEnabled(e,p,!0)&&(i.accessTokenFetchingMethod=1..toString())),{authorization:{parameters:i,scheme:o.AuthSchemes.servicePrincipal},data:{subscriptionId:t.id,subscriptionName:t.displayName,environment:o.azureEnvironment,scopeLevel:"subscription"},type:o.EndpointTypes.azureRM,url:o.azureManagementUrl}}static getEndpointStatus(e,t){const s=I.getTFSPageData(t);if(s&&s.project){const n=s.project.name;return new Promise((s,r)=>{let o=!1,p={state:"InProgress",statusMessage:""},u=setTimeout(function c(){o||i.getServiceEndpointClient(t).getServiceEndpointDetails(n,e).then(t=>{null===t&&(clearTimeout(u),o=!0,r(a.format(A.EndpointNotFound,e))),t.operationStatus&&(p=t.operationStatus),t.isReady?(clearTimeout(u),o=!0,s(p.state)):"Failed"===p.state?(clearTimeout(u),o=!0,r(p.statusMessage)):"InProgress"===p.state&&(u=setTimeout(c,2e3))},e=>{clearTimeout(u),o=!0,r(e)})},2e3)})}return Promise.reject(A.ProjectInfoNotFound)}static generateAuxillaryResourcesForEndpoints(e,t,s){let i={};const n=t.k8sConnection,r=e.filter(e=>"environmentresource:kubernetes"===e.type.toLocaleLowerCase());if(r.length>0){if(!n)return Promise.reject(A.ResourcesCannotBeCreated);for(let e=0;e<r.length;e++){const t={name:n.Data.namespace,namespace:n.Data.namespace,clusterName:u._getClusterNameFromClusterId(n.Data.clusterId),serviceEndpointId:n.Id};i[r[e].name]={resourcetocreate:t,type:r[e].type}}i.environment={resourcetocreate:{name:s.repositoryName,description:`CI/CD setup from this repo: '${s.repositoryName}'`},type:"environment"}}return Promise.resolve(i)}}t.UtilitiesEndpointHelper.EndpointHelper=u}(),function(e){G=t.UtilitiesYamlExport={},Object.defineProperty(t,"__esModule",{value:!0});const s="\r\n",i="  ",n="    ",r="      ";t.UtilitiesYamlExport.exportYaml=async function(e,t,o){return Boolean(t.content)?function(e,t,s){const i=e.getService("IVssContributionService"),n={templateParameters:Object.assign({},s,{templateId:t.id}),validateAssets:!1,branch:"",connectionId:"",repositoryId:"",sourceProviderType:""};return i.getDataAsync("ms.vss-build-web.customized-template-data-provider",n).then(e=>e&&e.content||"")}(e,t,o):function(e,t){let o="- task: "+e.name+"@"+e.version.major+s;return e.inputs.length>0&&(o+=i+"inputs:"+s),e.inputs.forEach(e=>{let i=t[e.name];if(void 0!==i){e.type!==v.InputTypes.BOOL&&e.type!==v.InputTypes.INT&&""!==i&&(i="'"+i.replace(/'/g,"''").trim()+"'").indexOf("\n")>0&&(i=i.split("\n").join(s+r));const t=e.aliases&&e.aliases.length>0&&e.aliases[0]||e.name;o+=n+t+": "+i+s}}),o}(t,o)}}(),function(e){t.ComponentsAzureContainerRegistryPicker={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsAzureContainerRegistryPicker.AzureContainerRegistryPicker=class extends V.VssComponent{constructor(e,t){super(e,t),this.getValue=(e=>"subscriptionId"===e&&this.props.subscription&&this.props.subscription.id?"0":""),this._createServiceEndpointObject=((e,t)=>{let s=JSON.parse(t.replace(/'/g,'"')),i=this.getRegistryNameFromRegistryId(s.id),n={data:{registrytype:"ACR",registryId:s.id,subscriptionId:this.props.subscription?this.props.subscription.id:"",subscriptionName:this.props.subscription?this.props.subscription.displayName:""},name:i,type:j.EndpointConstants.EndpointTypes.docker,url:`https://${s.loginServer}`,authorization:{scheme:j.EndpointConstants.AuthSchemes.servicePrincipal,parameters:{tenantId:this.props.subscription?this.props.subscription.subscriptionAccount.subscriptionTenantId:"",servicePrincipalId:"<placeholder>",scope:s.id,loginServer:s.loginServer}}};this.props.onAllValuesReceived(n)}),this.state={registryUrl:""},this._source=new D.SnippetFormSource(this.context.pageContext)}render(){let e={dataSourceBinding:{dataSourceName:"AzureRMContainerRegistries",resultTemplate:"{ \"Value\": \"{'id':'{{id}}', 'name':'{{name}}' , 'loginServer': '{{ properties.loginServer}}'}\", \"DisplayValue\" : \"{{name}}\" }",parameters:{}},dataSourceDependency:"subscriptionId",label:"Container registry",name:"containerRegistry"};const{className:t}=this.props;return p.createElement("div",{className:V.css("section",t)},p.createElement(L.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this._source,onValueChanged:this._createServiceEndpointObject,getValue:this.getValue,onError:this.props.onError,preloadItems:!0,serviceEndpointDetails:j.EndpointHelper.getAzureRMServiceEndpointDetails(this.context.pageContext,this.props.subscription,this.props.endpointToken)}))}componentDidMount(){super.componentDidMount()}getRegistryNameFromRegistryId(e){let t="";if(e){let s=e.split("/"),i=s.findIndex(e=>"registries"===e)+1;i>0&&(t=s[i])}return t}}}(),function(e){t.ComponentsAzureKubernetesEndpointInput={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsAzureKubernetesEndpointInput.AzureKubernetesEndpointInput=class extends V.VssComponent{constructor(e,t){super(e,t),this.onValueChanged=((e,t)=>{if("clusterName"===e){let e=JSON.parse(t.replace(/'/g,'"'));this.setState({clusterId:e.id,fqdn:`https://${e.fqdn}`,clusterName:e.name,namespace:""})}else"namespace"===e?this.setState(Object.assign({},this.state,{namespace:t}),()=>{this.props.onAllValuesReceived(this._createServiceEndpointObject())}):"createNewNamespace"===e&&this.setState(Object.assign({},this.state,{createNewNamespace:t,namespace:""}))}),this.getValue=(e=>{switch(e){case"createNewNamespace":return this.state.createNewNamespace;case"namespace":return this.state.namespace;case"subscriptionId":return this.props.subscription&&this.props.subscription.id?"0":"";case"clusterName":return this.state.clusterName?this.state.clusterName:"";default:return""}}),this._getKubernetesServiceEndpointDetails=(()=>{if(this.props.subscription){let e=void 0;return e={authorization:{parameters:{azureEnvironment:j.EndpointConstants.azureEnvironment,azureTenantId:this.props.subscription.subscriptionAccount.subscriptionTenantId},scheme:j.EndpointConstants.AuthSchemes.kubernetes},data:{authorizationType:"AzureSubscription",azureSubscriptionId:this.props.subscription.id,azureSubscriptionName:this.props.subscription.displayName,clusterId:this.state.clusterId},type:j.EndpointConstants.EndpointTypes.kubernetes,url:this.state.fqdn}}}),this._createServiceEndpointObject=(()=>{if(this.props.subscription)return{data:{authorizationType:"AzureSubscription",azureSubscriptionId:this.props.subscription.id,azureSubscriptionName:this.props.subscription.displayName,clusterId:this.state.clusterId,namespace:this.state.namespace,"operation.createNamespace":this.state.createNewNamespace},name:`${this.state.clusterName}-${this.state.namespace}`,type:"kubernetes",url:this.state.fqdn,authorization:{scheme:"Kubernetes",parameters:{azureEnvironment:"AzureCloud",azureTenantId:this.props.subscription.subscriptionAccount.subscriptionTenantId}}}}),this._getRadioButtons=(()=>[p.createElement(b.RadioButton,{key:"true",className:"namespace-radio-button",id:"true",text:"New"}),p.createElement(b.RadioButton,{key:"false",className:"namespace-radio-button",id:"false",text:"Existing"})]),this.state={clusterId:"",namespace:"",fqdn:"",createNewNamespace:"false",clusterName:""},this._source=new D.SnippetFormSource(this.context.pageContext)}render(){let e={dataSourceBinding:{dataSourceName:"AzureKubernetesClusters",resultTemplate:"{ \"Value\": \"{'id':'{{id}}', 'fqdn': '{{properties.fqdn}}', 'name': '{{name}}' }\", \"DisplayValue\" : \"{{name}}\" }",parameters:{}},dataSourceDependency:"subscriptionId",label:"Cluster",name:"clusterName"},t={dataSourceBinding:{dataSourceName:"KubernetesNamespaces",resultTemplate:'{ "Value" : "{{metadata.name}}", "DisplayValue" : "{{metadata.name}}" }',parameters:{}},dataSourceDependency:"clusterName",label:"",name:"namespace"};const{className:s}=this.props;return p.createElement("div",{className:"section"},p.createElement("div",{className:s},p.createElement(L.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this._source,onValueChanged:this.onValueChanged,getValue:this.getValue,onError:this.props.onError,preloadItems:!0,serviceEndpointDetails:j.EndpointHelper.getAzureRMServiceEndpointDetails(this.context.pageContext,this.props.subscription,this.props.endpointToken),makeRecursiveDatasourceCalls:!0})),p.createElement("div",{className:s},p.createElement("label",{className:"bolt-textfield-label"},"Namespace"),p.createElement(b.RadioButtonGroup,{className:"",selectedButtonId:this.getValue("createNewNamespace"),onSelect:e=>this.onValueChanged("createNewNamespace",e),direction:1},this._getRadioButtons()),"false"===this.state.createNewNamespace&&p.createElement(L.DataSourcePickList,{inputDefinition:t,serviceConnectionProvider:this._source,onValueChanged:this.onValueChanged,getValue:this.getValue,onError:this.props.onError,preloadItems:!0,serviceEndpointDetails:this._getKubernetesServiceEndpointDetails()}),"true"===this.state.createNewNamespace&&p.createElement(C.FormItem,{className:"flex-row",label:""},p.createElement(_.TextField,{containerClassName:"namespace-text-field",value:this.getValue("namespace"),onChange:(e,t)=>this.onValueChanged("namespace",t)}))))}componentDidMount(){super.componentDidMount()}}}(),function(e){t.SnippetForm={},Object.defineProperty(t,"__esModule",{value:!0});class s extends V.VssComponent{constructor(e){super(e),this._addSnippetToYaml=(()=>{this._export(this._store.getValuesForExport(),r.TelemetryConstants.ExportSnippet)}),this._getStateFromStore=(()=>{this.setState({snippetInputsByGroup:this._store.inputsByGroup,visibleGroups:this._store.visibleGroups,isSnippetSupported:this._store.isSnippetSupported})}),this._onError=((e,t)=>{const s=this.context.pageContext.getService("IVssTelemetryService");s&&s.publishEvent(r.TelemetryConstants.Area,r.TelemetryConstants.Error,{location:e,error:t,snippetName:this.props.snippet.friendlyName})}),this.state={snippetInputsByGroup:{},visibleGroups:[],isSnippetSupported:!0}}render(){return p.createElement("div",{className:"yaml-snippet-form flex-column flex-grow"},this._content())}_content(){if(this.state.error&&this.state.error.message)return p.createElement("div",null,p.createElement(g.Button,{className:"yaml-snippet-back-button",onClick:this.props.onDismiss,subtle:!0,iconProps:{iconName:"Back"},ariaLabel:A.CancelSnippetYaml}),p.createElement("span",null,a.format(A.FailedToLoadSnippet,this.state.error.message)));const e=this.state.snippetInputsByGroup[r.UnparentedInputsGroupName];return p.createElement(p.Fragment,null,p.createElement(P.FocusZone,{focusOnMount:!0},p.createElement("div",{className:"yaml-snippet-form-content flex-grow v-scroll-auto h-scroll-hidden"},p.createElement("div",{className:"yaml-snippet-form-inner-content"},p.createElement("span",{className:"flex-row snippet-form-header"},p.createElement(g.Button,{className:"yaml-snippet-back-button",onClick:this.props.onDismiss,subtle:!0,iconProps:{iconName:"Back"}}),p.createElement("span",{className:"snippet-name-header text-ellipsis title-s"},this.props.snippet.friendlyName),!1),e&&e.length>0&&p.createElement(F.SnippetInputList,{className:"ungrouped",inputs:e,inputValueProvider:this._store,serviceConnectionProvider:this._source,onError:this._onError}),this.state.visibleGroups.length>0&&p.createElement(T.CollapsibleSectionGroup,{items:F.getSnippetInputGroups(this.state.snippetInputsByGroup,this.state.visibleGroups,this._store.isGroupCollapsed,this._store,this._source,this._onError),onSectionClicked:this._store.toggleGroup}),!1))),p.createElement("div",{className:"yaml-snippet-form-footer"},this.props.snippet.documentationUrl&&p.createElement(k.Link,{className:"snippet-documentation",href:this.props.snippet.documentationUrl,target:"_blank",rel:"noopener noreferrer"},A.TaskReference),p.createElement(g.Button,{primary:!0,onClick:this._addSnippetToYaml},A.AddSnippetYaml)))}componentDidMount(){super.componentDidMount(),this.props.snippet.inputs.length>0?(this._store=new M.SnippetFormStore,this._store.addListener(this._getStateFromStore),this._source=new D.SnippetFormSource(this.context.pageContext),this._loadSnippet(this.props.snippet)):this._export({},r.TelemetryConstants.ExportSnippet)}componentWillUnmount(){super.componentWillUnmount(),this._store&&this._store.dispose()}_loadSnippet(e){try{if(this._store.loadSnippet(e),!this._store.isSnippetSupported){const e=this.context.pageContext.getService("IVssTelemetryService");e&&e.publishEvent(r.TelemetryConstants.Area,r.TelemetryConstants.LoadedUnsupportedSnippet,{name:this.props.snippet.friendlyName,version:this.props.snippet.version,isTemplate:Boolean(this.props.snippet.content),unsupportedInputs:this._store.unsupporedInputTypes.join(",")})}}catch(e){this.setState({error:e});const t=this.context.pageContext.getService("IVssTelemetryService");t&&t.publishEvent(r.TelemetryConstants.Area,r.TelemetryConstants.Error,{location:"loadSnippetForm",error:e})}}async _export(e,t){if(this.props.onInputsCompleted&&this.props.onInputsCompleted(e),this.props.onYamlGenerated){const t=await G.exportYaml(this.context.pageContext,this.props.snippet,e);this.props.onYamlGenerated(t)}this.props.onDismiss&&this.props.onDismiss();const s=this.context.pageContext.getService("IVssTelemetryService");s&&s.publishEvent(r.TelemetryConstants.Area,t,{name:this.props.snippet.friendlyName,version:this.props.snippet.version,isTemplate:Boolean(this.props.snippet.content)})}}t.SnippetForm.SnippetForm=s,V.Components.add("yaml-snippet-form",s)}()},["Resources","Sources/SnippetFormSource","Utilities/VisibilityHelper","Components/EnhancedPickList","Components/AzureSubscriptionPickList","Components/DataSourcePickList","Components/ServiceConnectionPickList","Components/RadioGroup","Components/SnippetInput","Components/SnippetInputGroup","Stores/SnippetFormStore","Utilities/EndpointHelper","Utilities/YamlExport","Components/AzureContainerRegistryPicker","Components/AzureKubernetesEndpointInput","SnippetForm"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.designer-extensions.yaml-snippet-form"}}));