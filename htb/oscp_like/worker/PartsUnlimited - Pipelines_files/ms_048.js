"use strict";define("Build/Designer",["require","exports","Build/Common/Library/Navigation","VSS/Platform/Context","VSS/Core/Observable","VSS/Platform/FPS","Build/Common/Library/Resources","Build/SourceProviders/Common","VSS/Core/Util/String","react","VSSUI/Icon","VSSUI/List","VSSUI/Utilities/Provider","VSSUI/Image","VSSUI/Pill","VSSUI/PillGroup","VSS/Platform/Layout","Build/DesignerExtensions/YamlSnippetForm/Utilities/EndpointHelper","OfficeFabric/ProgressIndicator","VSS/Platform/Feature","VSSUI/Button","VSSUI/MessageCard","VSSUI/Observer","VSSUI/FormItem","VSSUI/Panel","VSSUI/RadioButton","VSSUI/Spinner","VSSUI/TextField","VSS/Legacy/Legacy","VSSUI/Card","VSSUI/Util","VSS/Features/PlatformUI/FPSLink","VSS/Platform/Components/Format","VSS/Platform/Location","VSSUI/Page","VSSUI/Surface","VSSUI/Wizard","VSSUI/VssIcon","Build/Common/Library/Legacy/Components/BranchDropdown","VSSUI/Header","VSSUI/HeaderCommandBar","VSSUI/TooltipEx","VSSUI/Dialog","Build/Common/Library/Components/CommandComponent","Build/Common/Library/Legacy/Components/PipelineSettingsPanel","Build/Common/Library/StateHandler","Build/Queue-Panel/QueuePanel","OfficeFabric/Selection","VSSUI/Link","VSSUI/Ago","VSSUI/FilterBar","VSSUI/PickList","VSSUI/TextFilterBarItem","VSSUI/Utilities/Filter"],function(e,t,s,i,r,n,o,a,l,c,p,d,h,m,u,g,S,v,y,f,C,_,b,P,E,R,T,I,w,x,N,B,F,L,A,D,M,k,O,z,V,U,Y,W,j,H,q,K,G,Q,J,Z,X,$){var ee,te,se,ie,re,ne,oe,ae,le,ce,pe,de,he,me,ue,ge,Se,ve,ye,fe;ee=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AddedSnippet="Added task",t.Resources.AuthorizeAndRunButtonText="Authorize resources and run",t.Resources.AuthorizeButtonText="Authorize",t.Resources.AuthorizeWithExternalIdentity="To continue, authorize a connection using your {0} identity",t.Resources.AuthorizingMessage="Authorizing...",t.Resources.AuthorizingWithProviderMessage="Authorizing with {0}...",t.Resources.AutoAuthorizeErrorMessage="An unspecified error occurred while attempting to authorize resources.",t.Resources.AzurePipelinesApp="Azure Pipelines GitHub App",t.Resources.Branch="Branch",t.Resources.BranchDataProviderErrorMessage="Error retrieving branches for repository {0}.",t.Resources.BranchNameErrorInvalidCharacter="A branch name cannot contain '{0}'.",t.Resources.BranchNameErrorInvalidLeadCharacter="A branch name cannot start with '{0}'.",t.Resources.BranchNameErrorInvalidTrailCharacter="A branch name cannot end with '{0}'.",t.Resources.BranchNameErrorSameAsTarget="The branch name cannot be the same as the target branch.",t.Resources.BranchNameErrorTooLong="The branch name cannot be longer than {0} characters.",t.Resources.BringYourOwnYamlTitle="Existing Azure Pipelines YAML file",t.Resources.BringYourOwnYamlTitleShort="Select an existing YAML file",t.Resources.BringYourOwnYamlDesc="Select an Azure Pipelines YAML file in any branch of the repository.",t.Resources.BuildInSimpleSteps="Build your code in a few easy steps",t.Resources.BuildNumberFormat="#{0}",t.Resources.BuildQueuedMessage="Build {0} has been queued.",t.Resources.BuildQueuingMessage="Queuing a build...",t.Resources.BuildsHubName="Builds",t.Resources.Cancel="Cancel",t.Resources.ChangeToAppConnection="Use app connection",t.Resources.ChooseSubscription="Azure subscription",t.Resources.CommandRunWithParameters="Run with parameters",t.Resources.CommandSettings="Settings",t.Resources.CommandTriggers="Triggers",t.Resources.CommandVariables="Variables",t.Resources.CommitMessage="Commit message",t.Resources.Configure="Configure",t.Resources.Configuring="Configuring...",t.Resources.ConfigureYourPipeline="Configure your pipeline",t.Resources.ConfiguringYourPipelineAndGeneratingYaml="Configuring resources and generating YAML",t.Resources.ConfigFileDataProviderErrorMessage="Error retrieving config files for repository {0}.",t.Resources.ConfigFileNotFound="File not found.",t.Resources.ConfigFileInvalid="File is not a valid Dockerfile or YAML file.",t.Resources.ConfirmLosingUnsavedChange="You have unsaved changes which will be lost if you navigate away. Are you sure you want to discard these changes?",t.Resources.ConfirmLosingUnsavedChangeTitle="Are you sure you want to leave?",t.Resources.Connect="Connect",t.Resources.ConnectionChanged="Connection was successfully changed",t.Resources.Continue="Continue",t.Resources.CreatingPipeline="Creating pipeline...",t.Resources.DefaultBranch="default",t.Resources.EditInOldDesigner="Use the classic editor",t.Resources.EditorDefaultTitle="Pipeline editor",t.Resources.EditorPipelineFetchError="An error occurred while fetching the pipeline. {0}",t.Resources.EditorServiceConnectionError="{0} You can use the classic editor to fix the service connection in the YAML source settings.",t.Resources.ErrorMessage="Error: {0}",t.Resources.ExistingFileFound="An existing YAML file was found",t.Resources.FilesToBeAdded="Files to be added to your repository ({0})",t.Resources.ImageName="Image name",t.Resources.GetFileContentErrorMessage="An unspecified error occurred while fetching file {0} from branch {1}.",t.Resources.LearnMore="Learn more",t.Resources.Leave="Leave",t.Resources.LoadingEditor="Loading the editor...",t.Resources.LoginUrlNotSpecified="Could not login to view this YAML file",t.Resources.InstallApp="Install app",t.Resources.InvalidServiceConnection="Unable to fetch any repositories. Please ensure the service connection is valid.",t.Resources.NameColumnHeader="Name",t.Resources.NewPipeline="New pipeline",t.Resources.OldDesignerFallbackFormat="{0} to create a pipeline without YAML.",t.Resources.OldDesignerLinkText="Use the classic editor",t.Resources.OptionalExtendedDescription="Optional extended description",t.Resources.OrFormat="Or, {0}",t.Resources.Path="Path",t.Resources.PipelineHostedOn="This pipeline's YAML is hosted on {0}",t.Resources.PipelineSettingsPanelTitle="Pipeline settings",t.Resources.PipelineSettingsSubheaderStatus="Processing of new run requests",t.Resources.PipelineSettingsStatusEnabled="Enabled",t.Resources.PipelineSettingsStatusDisabled="Disabled",t.Resources.PipelineSettingsStatusPaused="Paused",t.Resources.PipelineSettingsYamlDiscard="This will discard unsaved changes in the current YAML file",t.Resources.PipelineSettingsYamlFetchError="An unspecified error occurred while fetching existing YAML files.",t.Resources.PipelineSettingsYamlFilePath="YAML file path",t.Resources.PipelineStatusCIDisabled="CI Disabled",t.Resources.PipelineStatusDisabled="Disabled",t.Resources.PipelineStatusPaused="Paused",t.Resources.PreferAppConnectionInstall="Enhance this pipeline by installing the {0}",t.Resources.PreferAppConnectionChange="Enhance this pipeline by changing its connection to use the {0}",t.Resources.QueueResourceName="Agent pool",t.Resources.Recommended="Recommended",t.Resources.RepositoryAlreadyMapped="The repository {0} is in use with the {1} in another Azure DevOps organization. {2}",t.Resources.RepositoryAnalyzing="Analyzing your repository to suggest a compatible template...",t.Resources.RepositorySelectorFetchingRepositories="Fetching repositories...",t.Resources.RepositorySelectorFilterPlaceholder="Filter by keywords",t.Resources.RepositorySelectorFilterReset="Reset",t.Resources.RepositorySelectorNoneFoundDescription="No matching repositories were found.",t.Resources.RepositorySelectorProvideAccessDescription="If you can't find a repository, make sure you {0}.",t.Resources.RepositorySelectorProvideAccessDescriptionLink="provide access",t.Resources.RepositorySelectorTagFork="fork",t.Resources.RepositorySelectorTagPrivate="private",t.Resources.RepositorySelectorTitle="Select a repository",t.Resources.ResourcesVariables="Variables",t.Resources.ResourcesAuthorizedResources="Authorized resources",t.Resources.Review="Review",t.Resources.ReviewYourPipelineYAML="Review your pipeline YAML",t.Resources.RunBuildErrorMessage="An unspecified error occurred while queuing the build.",t.Resources.RunButtonLabel="Run",t.Resources.SaveAndRunButtonLabel="Save and run",t.Resources.SaveButtonLabel="Save",t.Resources.SaveErrorMessage="An unspecified error occurred while saving the file.",t.Resources.SavePanelCommitDescriptionPlaceholder="Add an optional description...",t.Resources.SavePanelCommitMessage="Set up CI with Azure Pipelines",t.Resources.SavePanelCommitMessageForEdit="Update {0} for Azure Pipelines",t.Resources.SavePanelCommitToDefault="Commit directly to the {0} branch.",t.Resources.SavePanelCommitToNewBranch="Create a new branch for this commit.",t.Resources.SavePanelCreatePullRequest="Create a new branch for this commit and start a pull request.",t.Resources.SavePanelDescription="Saving will commit {0} to the repository.",t.Resources.SavePanelNewBranchName="azure-pipelines",t.Resources.SavePanelTitleSave="Save",t.Resources.SavePanelTitleSaveAndRun="Save and run",t.Resources.SavePipelineCommentDisableCI="Disable pipeline CI",t.Resources.SavePipelineCommentEnableCI="Enable YAML pipeline CI",t.Resources.SavingChanges="Saving changes...",t.Resources.SecureFileResourceName="Secure file",t.Resources.Select="Select",t.Resources.SelectAzureSubscription="Select an Azure subscription",t.Resources.ServiceEndpointResourceName="Service connection",t.Resources.ServicePort="Service port",t.Resources.ShowMore="Show more",t.Resources.SidePanelClose="Hide",t.Resources.SidePanelOpen="Show assistant",t.Resources.Stay="Stay",t.Resources.StepTemplate="Template",t.Resources.StepSubscription="Subscription",t.Resources.TemplateRequiresMoreInfo="The selected template requires the following information",t.Resources.TestPanelCommandName="TestPanel",t.Resources.TypeColumnHeader="Type",t.Resources.UnauthorizeButtonText="Unauthorize",t.Resources.UnableToInstallMarketplaceApp="The {0} is not installed to repository {1}. {2}",t.Resources.ValidateAndConfigureButtonLabel="Validate and configure",t.Resources.VariableGroupResourceName="Variable group",t.Resources.ViewOnExternalSite="view it on {0}",t.Resources.VisibilityMismatchProjectSettings="project settings",t.Resources.VisibilityMismatchRepoPrivate="You selected a private repository, but this is a public project. Go to {0} to change the visibility of the project. {1}",t.Resources.VisibilityMismatchRepoPublic="You selected a public repository, but this is not a public project. Go to {0} to change the visibility of the project. {1}",t.Resources.VariableColumnHeaderName="Name",t.Resources.VariableColumnHeaderValue="Value",t.Resources.VariableColumnHeaderSecret="Secret variable",t.Resources.VariableColumnHeaderIcon="Variable error message",t.Resources.VariableErrorNameIsRequired="Variable name is required",t.Resources.VariableErrorNameIsAlreadyDefined="Variable '{0}' is already defined",t.Resources.VariableSecretTooltipChangeToSecret="Change variable type to secret",t.Resources.VariableSecretTooltipChangeToPlainText="Change variable type to plain text",t.Resources.VariableSecretMask="***********",t.Resources.VariableAddButtonText="Add variable",t.Resources.VariableDeleteButtonTooltipText="Delete variable",t.Resources.WhereIsYourCode="Where is your code?",t.Resources.Yaml="YAML",t.Resources.YamlFileDescription="Pipeline process",te=t.Constants={},Object.defineProperty(t,"__esModule",{value:!0}),(ve=t.Constants.EditorConstants||(t.Constants.EditorConstants={})).ElementToFocusOnEscape="ci-editor-escape-focus-element",ve.YamlAssistantToggleElement="yaml-assistant-toggle-element",(t.Constants.FwLinks||(t.Constants.FwLinks={})).AzurePipelinesDocs="https://go.microsoft.com/fwlink/?linkid=2024748",(Se=t.Constants.LegacyDesignerTabKeys||(t.Constants.LegacyDesignerTabKeys={})).Triggers="Tab_Triggers",Se.Variables="Tab_Variables",Se.Yaml="Tab_Tasks",(ge=t.Constants.TemplateConstants||(t.Constants.TemplateConstants={})).TemplateIdKey="templateid",ge.RepositoryNameKey="repositoryName",ge.K8sConnectionKey="k8sConnection",ge.SubscriptionId="subscriptionId",(ue=t.Constants.TemplateRequiredConstants||(t.Constants.TemplateRequiredConstants={})).AzureSubscription="connectedService:azureRM",ue.DataSourcePicklist="dataSourcePicklist",ue.KubernetesEndpoint="endpoint:kubernetes",(me=t.Constants.TemplateParameterTypes||(t.Constants.TemplateParameterTypes={})).AzureContainerRegistry="endpoint:containerRegistry",me.AzureRmEndpoint="endpoint:azureRm",me.DataSourcePickList="dataSourcePicklist",me.KubernetesResource="environmentResource:kubernetes",me.PickList="picklist",me.String="string",(t.Constants.TemplateAssetTypes||(t.Constants.TemplateAssetTypes={})).File="file",function(e){t.InstallAppService={},Object.defineProperty(t,"__esModule",{value:!0});class r extends i.VssService{installApp(){const e=this.pageContext.getService("IVssContributionService"),t=this._getTelemetrySession();e.getDataAsync("ms.vss-build-web.wizard-continuation-data-provider",{telemetrySession:t},!0).then(()=>{this._logTelemetry("installApp","CreatePipeline",t,""),s.openLinkSecurely(r._redirectUrl,!1)})}installAppForWizard(e,t,i,n){let o=r._redirectUrl;if(n.properties&&n.properties.ownerId){const e=n.properties.ownerId,t=n.properties.externalId,s=i.indexOf("?")>0?"&":"?";o=i+s+"suggested_target_id="+e+"&repository_ids[]="+t}const a=this._getTelemetrySession();this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.wizard-continuation-data-provider",{sourceProvider:e,repositoryId:n.id,repositoryName:n.name,connectionId:t,telemetrySession:a},!0).then(()=>{this._logTelemetry("installAppForRepository","CreatePipeline",a,n.id),s.openLinkSecurely(o,!1)})}installAppForEdit(e,t,i,r){let n=i;if(r.properties&&r.properties.ownerId){const e=r.properties.ownerId,t=r.properties.externalId,s=i.indexOf("?")>0?"&":"?";n=i+s+"suggested_target_id="+e+"&repository_ids[]="+t}this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{pipelineId:e.toString(),nonce:t},!0).then(()=>{this._logTelemetry("installAppForRepository","EditPipeline",r.id),s.openLinkSecurely(n,!1)})}_getTelemetrySession(){return this.pageContext.getService("IVssHistoryService").getState().telemetrySession}_logTelemetry(e,t,s,i){this.pageContext.getService("IVssTelemetryService").publishEvent("Build",t,{GitHubApp:e,GitHubAppRepo:i,action:"InstallGitHubApp",telemetrySession:s||"unknown"})}}r._redirectUrl="https://go.microsoft.com/fwlink/?linkid=874367",t.InstallAppService.InstallAppService=r,i.Services.add("IInstallAppService",{serviceFactory:r})}(),se=t.Performance={},Object.defineProperty(t,"__esModule",{value:!0}),(t.Performance.PerformanceConstants||(t.Performance.PerformanceConstants={})).Area="Build",(ye=t.Performance.PageLoadScenarios||(t.Performance.PageLoadScenarios={})).Sources="PLT.CI.AcquisitionWizard.Sources",ye.YamlEditor="PLT.CI.YamlEditor",ye.Repository="CI.Designer.Repository",ye.Templates="CI.Designer.Templates",function(e){t.PipelineEditorBreadcrumbService={},Object.defineProperty(t,"__esModule",{value:!0});i.Services.add("pipeline-editor-breadcrumb-service",{serviceFactory:class extends i.VssService{constructor(){super(...arguments),this.items=new r.ObservableArray}getBreadcrumbItems(e){return this.items}setPipeline(e){this.items.removeAll();const t=this.buildLinkingService.getDefinitionUrl();if(this.items.push({key:"pipeline-editor-builds-breadcrumb",text:ee.BuildsHubName,href:t,onClick:e=>{n.onClickFPS(this.pageContext,t,!0,e,{telemetrySource:"pipeline-editor-breadcrumb"})}}),e){const t=this.buildLinkingService.getDefinitionUrl(e.id);this.items.push({key:"pipeline-editor-definition-breadcrumb",text:e.name,href:t,onClick:e=>{n.onClickFPS(this.pageContext,t,!0,e,{telemetrySource:"pipeline-editor-breadcrumb"})}},{key:"pipeline-editor-pipeline-yaml-breadcrumb",text:ee.Yaml})}}clearPipeline(){this.items.removeAll()}get buildLinkingService(){return this.pageContext.getService("IBuildLinkingService")}}})}(),function(e){t.PipelineService={},Object.defineProperty(t,"__esModule",{value:!0});class s extends i.VssService{createAndRunPipeline(e,t,i,r,n,o){const a=this.pageContext.getService("IVssContributionService");let l={connectionId:e.connectionId,sourceProvider:e.sourceProviderType,pipelinePath:o,repositoryId:e.id,repositoryName:e.name,branch:e.defaultBranch,sourceBranch:r||e.defaultBranch,path:t,queue:"Hosted Ubuntu 1604"};return n&&(l=Object.assign({},l,{commitId:n.commitId,pullRequestNumber:n.pullRequestNumber,commitDescriptorName:n.commitDescriptorName})),a.getDataAsync(s._pipelineDataProviderId,l,!0)}runPipeline(e,t){const s=this.pageContext.getRestClient("IBuildRestClient"),i={definition:{id:e.id},sourceBranch:t};return s.queueBuild(i,e.project.id)}enablePipelineCI(e,t){if((e=this.shallowCopy(e)).triggers&&(e.triggers=e.triggers.filter(e=>2!==e.triggerType)),t){const t={batchChanges:!1,maxConcurrentBuildsPerBranch:1,pollingJobId:"",pollingInterval:0,pathFilters:[],branchFilters:[],settingsSourceType:2,triggerType:2};e.triggers=e.triggers||[],e.triggers.push(t),e.comment=ee.SavePipelineCommentEnableCI}return e.comment=t?ee.SavePipelineCommentEnableCI:ee.SavePipelineCommentDisableCI,this.savePipeline(e)}enablePipeline(e,t){switch((e=this.shallowCopy(e)).queueStatus=t,t){case 2:e.comment=o.SavePipelineCommentDisable;break;case 0:e.comment=o.SavePipelineCommentEnable;break;case 1:e.comment=o.SavePipelineCommentPause}return this.savePipeline(e)}savePipeline(e){return this.pageContext.getRestClient("IBuildRestClient").updateDefinition(e,e.project.id,e.id)}getPipelineErrorMessage(){const e=this.pageContext.getService("IVssContributionService").getDataProviderExceptions()[s._pipelineDataProviderId];return e&&e.message}deepCopy(e){return JSON.parse(JSON.stringify(e))}shallowCopy(e){return Object.assign({},e)}}s._pipelineDataProviderId="ms.vss-build-web.create-and-run-pipeline-data-provider",i.Services.add("IPipelineService",{serviceFactory:s})}(),function(e){t.YamlFileService={},Object.defineProperty(t,"__esModule",{value:!0});const s="[skip ci]",r=["***no_ci***",s,"[ci skip]","skip-checks: true","skip-checks:true","[skip azp]","[azp skip]","[skip azpipelines]","[azpipelines skip]","[skip azurepipelines]","[azurepipelines skip]"];i.Services.add("IYamlFileService",{serviceFactory:class extends i.VssService{commitFile(e,t,s,i,r,n){const o=[{content:i,path:s,oldObjectId:n||""}];return this.commitFiles(e,t,o,r)}commitFiles(e,t,s,i){i.skipCi&&this._suppressCIBuild(i);const r="ms.vss-build-web.commit-file-data-provider",n={connectionId:e.connectionId,sourceProviderType:e.sourceProviderType,repositoryId:e.id,projectId:e.projectId||"",files:s,targetBranch:t,sourceBranch:i.createNewBranch?i.newBranchName:"",message:i.message,description:i.description};if(e.projectId){const t={contributionIds:[r],context:{properties:n}};return t.context.properties.projectId=e.projectId,this.pageContext.getRestClient("IContributionsRestClient").queryDataProviders(t,"project",e.projectId).then(e=>{if(e.resolvedProviders&&e.resolvedProviders.length){if(e.exceptions&&e.exceptions[r])throw new Error(e.exceptions[r].message);{const t=e.data[r]||{};return Object.assign({},t,{commitDescriptorName:i.message})}}throw new Error(ee.SaveErrorMessage)},e=>{throw new Error(e&&e.message||ee.SaveErrorMessage)})}{const e=this.pageContext.getService("IVssContributionService");return e.getDataAsync(r,n,!0).then(t=>{if(t)return Object.assign({},t,{commitDescriptorName:i.message});{const t=e.getDataProviderExceptions()[r],s=t&&t.message||ee.SaveErrorMessage;throw new Error(s)}})}}getFileContentData(e,t,s){const i="ms.vss-build-web.file-content-data-provider",r={connectionId:e.connectionId,sourceProvider:e.sourceProviderType,repository:e.id,path:s,branch:t},n=this.pageContext.getService("IVssContributionService");return n.getDataAsync(i,r).then(r=>{if(r)return r;{const r=n.getDataProviderExceptions()[i];let o=r&&r.message||l.format(ee.GetFileContentErrorMessage,s,t);throw o=this._processErrorMessage(o,e),new Error(o)}})}_suppressCIBuild(e){let t=e.description||"";const i=((e.message||"")+"|"+t).toLocaleLowerCase();r.every(e=>-1===i.indexOf(e))&&(t+=(t?" ":"")+s,e.description=t)}_processErrorMessage(e,t){let s=e||"";return l.equals(t.sourceProviderType,a.RepositoryTypes.TfsGit,!0)&&t.name&&t.id&&(s=e.replace(t.id,t.name)),s}}})}(),function(e){t.YamlResourcesService={},Object.defineProperty(t,"__esModule",{value:!0});t.YamlResourcesService.AvailableResourcesModel=class{constructor(e){const t=e&&e.queues||[];this._queues=new r.ObservableArray(t.map(e=>({id:e.id,name:e.alias})))}get queues(){return this._queues}};class s extends i.VssObservableService{getVariables(){if(!this._variables){const e=this.pageContext.getService("IVssContributionService").getData(s.PipelineDataProviderKey),t=e&&e.definition&&e.definition.variables||{};this._variables=Object.keys(t).map(e=>Object.assign({name:e},t[e])).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())),this._originalJson=JSON.stringify(this._variables)}return[...this._variables]}isVariablesChanged(){return JSON.stringify(this._variables.sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())))!==this._originalJson}getAvailableQueues(){const e=new r.ObservableArray,t=this.pageContext.getService("IVssContributionService").getData(s.ContributionKey);return t&&(e.value=t.queues),e}updateVariables(e){this._variables=e,this._notify([...this._variables],"updateVariables".toString())}getBuildDefinitionVariables(){return this._variables.reduce((e,t)=>(e[t.name]=Object.assign({},t),e),{})}}s.ContributionKey="ms.vss-build-web.pipeline-resources-data-provider",s.PipelineDataProviderKey="ms.vss-build-web.pipeline-editor-data-provider",i.Services.add("IYamlResourcesService",{serviceFactory:s})}(),ie=t.ComponentsFileList={},Object.defineProperty(t,"__esModule",{value:!0}),(fe=t.ComponentsFileList.FileType||(t.ComponentsFileList.FileType={})).Yaml="FileYML",fe.Other="FileCode",t.ComponentsFileList.FileList=(e=>{const t=new h.ArrayItemProvider(e.files);return c.createElement("div",{className:"fileList flex-column"},c.createElement("label",{className:"fileList-label"},l.format(ee.FilesToBeAdded,e.files.length)),c.createElement(d.List,{className:"section-content",itemProvider:t,renderRow:(e,t,s,i)=>c.createElement(d.ListItem,{key:i||"list-item"+e,index:e,details:s},c.createElement(p.Icon,{className:"fileList-icon body-xl",iconName:t.type}),c.createElement("div",{className:"fileList-info flex-column"},c.createElement("div",{className:"fileList-name body-m"},t.name),c.createElement("div",{className:"fileList-description body-s secondary-text"},t.description))),width:"100%"}))}),function(e){re=t.WizardList={},Object.defineProperty(t,"__esModule",{value:!0}),t.WizardList.WizardList=function(e){const t=new h.ArrayItemProvider(e.wizardListItems);return c.createElement(d.List,{className:"wizard-list",itemProvider:t,onActivate:e.onClick,singleClickActivation:!0,renderRow:(e,t,s,i)=>c.createElement(d.ListItem,{key:i||"list-item"+e,index:e,details:s},c.createElement("div",{className:"flex-row flex-grow cursor-pointer scroll-hidden"},(e=>e.iconUrl?c.createElement(m.Image,{className:S.css("list-image",e.iconClass),src:e.iconUrl}):c.createElement(p.Icon,{className:S.css("list-icon",e.iconClass),iconName:e.iconName}))(t),c.createElement("div",{className:"list-content flex-column flex-grow scroll-hidden"},c.createElement("div",{className:"flex-row flex-grow flex-center"},c.createElement("span",{className:"body-m text-ellipsis"},t.name),(e=>{if(e&&e.labels)return c.createElement(g.PillGroup,{className:"flex-row flex-noshrink"},e.labels.map((e,t)=>c.createElement(u.Pill,{className:"list-item-label",size:0,key:t,excludeTabStop:!0,excludeFocusZone:!0},e)))})(t)),t.renderDescription?t.renderDescription():c.createElement("span",{className:"body-s secondary-text"},t.description)),t.isFavorite&&c.createElement(p.Icon,{className:"favorite-icon",iconName:"FavoriteStarFill"}))),width:"100%"})}}(),function(e){ne=t.TemplateSelector={},Object.defineProperty(t,"__esModule",{value:!0});const s="bringYourOwn";class r extends S.VssComponent{constructor(e,t){super(e,t),this._selectTemplate=((e,t,s)=>{const i=e&&e.parameters&&e.parameters.filter(e=>!!e)||[];f.isFeatureFlagEnabled(this.context.pageContext,"Pipelines.NewAcquisitionFlow",!0)&&i.length>0?(e.parameters=i,this.setState({progress:0,incompleteTemplate:{template:e,repoAnalysis:t,configuration:s},requiredInfoPanelIsOpen:!0})):this._onTemplateSelected(e,t,void 0)}),this._completeTemplate=(async e=>{if(this.state.incompleteTemplate){const t=this.state.incompleteTemplate,s=this._getTemplateParameters(t.template);this.setState({renderingTemplate:!0}),this._creatingResources=!0,this.monitorAndUpdateProgress(),this._recordTelemetryInfo("CreatingResources");const i=this._parseResponse(await this._createRequiredResources(e));this._createdResources=!0,this._recordTelemetryInfo("WaitingForEndpointsToBeReady");const r=(t.template.parameters||[]).filter(e=>e.type.startsWith("endpoint")||e.type.toLocaleLowerCase()===te.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase()),n=[];r.forEach(e=>{e.type.toLocaleLowerCase()===te.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase()?n.push(v.EndpointHelper.getEndpointStatus(i[te.TemplateConstants.K8sConnectionKey].Id,this.context.pageContext)):n.push(v.EndpointHelper.getEndpointStatus(i[e.name].Id,this.context.pageContext))});try{await Promise.all(n),this.setState({progress:.8})}catch(e){this._recordTelemetryInfo("WaitingForEndpointsToBeReadyFailed",{error:e}),this._handleError(e)}try{this._recordTelemetryInfo("RenderingTemplateWithValues"),this._endpointStatusCompleted=!0,await this._renderAndSelectTemplate(Object.assign({},e,s,i),t.template,t.repoAnalysis,t.configuration),this._recordTelemetryInfo("RenderingTemplateWithValuesSucceeded")}catch(e){this._recordTelemetryInfo("RenderTemplateWithValuesFailed",{error:e}),this._handleError(e)}}}),this._renderAndSelectTemplate=(async(e,t,s,i)=>{const r=this.context.pageContext.getService("IBuildTemplateService"),n=await r.renderTemplate(this.props.wizardState,e);if(n.exception)return this.setState({renderingTemplate:!1}),this._recordTelemetryInfo("RenderTemplateWithValuesFailed",{error:n.exception}),void this._handleError(n.exception);t.content=n.content,t.assets=n.assets,this._fetchedCustomizedTemplates=!0,this._onTemplateSelected(t,s,i)}),this._createRequiredResources=(async e=>{let t={},s={};const i=this.state.incompleteTemplate&&this.state.incompleteTemplate.template.parameters?this.state.incompleteTemplate.template.parameters:[];let r=!1;if(i.forEach(s=>{s.type.toLocaleLowerCase().startsWith("endpoint:")?t[s.name]={resourcetocreate:e[s.name],type:s.type}:s.type.toLocaleLowerCase()===te.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase()&&(t[te.TemplateConstants.K8sConnectionKey]={resourcetocreate:e[s.name],type:te.TemplateRequiredConstants.KubernetesEndpoint},r=!0)}),!t)return Promise.resolve({});const n=this.context.pageContext.getService("IVssContributionService"),o="ms.vss-build-web.create-resources-data-provider";try{const e=await n.getDataAsync(o,t)||{};if(Object.keys(e).forEach(t=>s[t]=e[t]),r){const t=await v.EndpointHelper.generateAuxillaryResourcesForEndpoints(i,e,this.props.wizardState);if(t){const e=await n.getDataAsync(o,t)||{};Object.keys(e).forEach(t=>s[t]=e[t])}}}catch(e){this._handleError(e)}return Promise.resolve(s)}),this._parseResponse=(e=>{const t=this.context.pageContext.getService("IVssContributionService").getDataProviderExceptions()["ms.vss-build-web.create-resources-data-provider"];return t?(this._handleError(t),{}):e}),this._getTemplateParameters=(e=>({[te.TemplateConstants.TemplateIdKey]:e.id,[te.TemplateConstants.RepositoryNameKey]:this.props.wizardState.repositoryName})),this._onTemplatesRetrieved=((e,t)=>{t!==n.templatesRetrieved||this._templatesFetched?t===n.templatesRetrievedFail&&this._handleError(e&&e.exception):(this._templatesFetched=!0,this._recommendedConfigPath=e.configurationPath,this._mounted&&this.setState({progress:this.state.progress+r.s_progressBarTemplateResults}))}),this._showFileSelectPanel=(()=>{this.setState({fileSelectPanelIsOpen:!0})}),this._dismissFileSelectPanel=(()=>{this.setState({fileSelectPanelIsOpen:!1})}),this._dismissRequiredInfoPanel=(()=>{this.setState({requiredInfoPanelIsOpen:!1})}),this._onTemplateSelected=((e,t,i,r)=>{e&&e.id===s?this._showFileSelectPanel():!this.state.errorMessage&&this.props.onTemplateSelected(e,t,i,r,this._recommendedConfigPath)}),this._normalizeHTML=(async e=>this._markdownPromise.then(()=>{return this.context.pageContext.getService("IHtmlNormalizerService").normalizeStripAttributes(e)})),this._recordTelemetryInfo=((e,t)=>{let s="";this.state.incompleteTemplate&&(s=this.state.incompleteTemplate.template.id);const i=Object.assign({action:e,template:s},t);this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","CreatePipeline",i)}),this.state={progress:0,loadComplete:!1,errorMessage:"",fileSelectPanelIsOpen:!1,requiredInfoPanelIsOpen:!1,renderingTemplate:!1},this._progressTicker=this._getPromiseTicker(),this._existingConfigFileFetched=!1,this._creatingResources=!1,this._createdResources=!1,this._endpointStatusCompleted=!1,this._fetchedCustomizedTemplates=!1,this.context.pageContext.getService("IVssPerformanceService").startScenario(se.PageLoadScenarios.Templates,!1)}render(){const e=this.context.pageContext.getService("IBuildTemplateService"),t=!!this.state.incompleteTemplate&&!!this.state.incompleteTemplate.template.parameters&&this.state.incompleteTemplate.template.parameters,s=f.isFeatureFlagEnabled(this.context.pageContext,"Pipelines.NewAcquisitionFlow",!0);return c.createElement("div",{className:"template-selector"},c.createElement("div",{className:"header-section"},c.createElement("div",{className:"subheader body-m secondary-text"},ee.NewPipeline),c.createElement("div",{className:"header title-l"},ee.ConfigureYourPipeline)),!this.state.renderingTemplate&&c.createElement(c.Fragment,null,this.state.errorMessage&&this.state.loadComplete&&c.createElement(_.MessageCard,{severity:"Error"},c.createElement("span",{dangerouslySetInnerHTML:{__html:this.state.errorMessage}})),c.createElement(b.Observer,{templateData:e},c.createElement(a,{templateData:void 0,loadComplete:this.state.loadComplete,onTemplateSelected:this._selectTemplate,progress:this.state.progress})),this.state.fileSelectPanelIsOpen&&c.createElement(S.WrappedComponent,{wrappedType:"designer-file-select-panel",dependencies:["ms.vss-build-web.designer-extensions.file-select-panel"],wrappedProps:{wizardState:this.props.wizardState,isOpen:this.state.fileSelectPanelIsOpen,onDismiss:this._dismissFileSelectPanel,onTemplateSelected:this._onTemplateSelected}}),!!t&&t.length>0&&this.state.incompleteTemplate&&s&&c.createElement(S.WrappedComponent,{wrappedType:"designer-required-template-info-panel",dependencies:["ms.vss-build-web.designer-extensions.required-template-info-panel"],wrappedProps:{template:this.state.incompleteTemplate.template,requires:t,isOpen:this.state.requiredInfoPanelIsOpen,onRequiredTemplateInfoCompleted:this._completeTemplate,onDismiss:this._dismissRequiredInfoPanel,onError:this._handleError}})),this.state.renderingTemplate&&c.createElement(c.Fragment,null,this.state.errorMessage&&c.createElement(_.MessageCard,{severity:"Error"},c.createElement("span",{dangerouslySetInnerHTML:{__html:this.state.errorMessage}})),!this.state.errorMessage&&c.createElement(c.Fragment,null,c.createElement("div",null,ee.ConfiguringYourPipelineAndGeneratingYaml),c.createElement(y.ProgressIndicator,{className:"progress",percentComplete:this.state.progress}))))}componentDidMount(){this._mounted=!0,this._existingConfigFileFetched=!1;const e=this.context.pageContext.getService("IVssContributionService");e.getDataAsync("ms.vss-build-web.existing-configuration-data-provider",this.props.wizardState).then(e=>{this._existingConfigFileFetched=!0,e?(this.props.onTemplateSelected(void 0,void 0,e),this._progressTicker=Promise.resolve()):this._mounted&&this.setState({progress:this.state.progress+r.s_progressBarExistingResults,loadComplete:this._existingConfigFileFetched})}),this._templatesFetched=!1;const t=this.context.pageContext.getService("IBuildTemplateService");t.subscribe(this._onTemplatesRetrieved),t.getTemplates(this.props.wizardState),this._markdownPromise=e.getContributionAsync("ms.vss-features.markdown")}componentWillUnmount(){super.componentWillUnmount(),this.context.pageContext.getService("IBuildTemplateService").unsubscribe(this._onTemplatesRetrieved),this._mounted=!1}monitorAndUpdateProgress(){let e;return e=this._fetchedCustomizedTemplates?r.s_progressBarMax:this._endpointStatusCompleted?.75:this._createdResources?.5:.25,!this.state.errorMessage&&this.state.progress<r.s_progressBarMax?new Promise(()=>setTimeout(()=>{let t=this.state.progress+r.s_progressBarStep;t=t<e?t:e,this._mounted&&(this.setState({progress:t}),this.monitorAndUpdateProgress())},100)):Promise.resolve()}_getPromiseTicker(){return this._existingConfigFileFetched&&this._templatesFetched||!(this.state.progress<r.s_progressBarMax)?Promise.resolve():new Promise(()=>setTimeout(()=>{this._mounted&&this.setState({progress:this.state.progress+r.s_progressBarStep}),this._progressTicker=this._getPromiseTicker()},100))}_handleError(e){let t="";this._mounted&&e&&(e.message?t=e.message:"string"==typeof e&&(t=e),this._normalizeHTML(t).then(e=>{this.setState({errorMessage:e})}))}}var n;r.s_progressBarMax=.99,r.s_progressBarExistingResults=.3*r.s_progressBarMax,r.s_progressBarTemplateResults=.3*r.s_progressBarMax,r.s_progressBarStep=(r.s_progressBarMax-r.s_progressBarExistingResults)/55,t.TemplateSelector.TemplateSelector=r,function(e){e.templatesRetrieved="templatesRetrieved",e.templatesRetrievedFail="templatesRetrievedFail"}(n||(n={}));class o extends i.VssObservableService{getTemplates(e){const t=this._getParametersKey(e);if(t!==this._currentParameters){this._currentParameters=t;const s=this.pageContext.getService("IVssContributionService"),i="ms.vss-build-web.recommended-configuration-data-provider";s.getDataAsync(i,e).then(e=>{if(e)this._currentState=e,this._notify(this._currentState,n.templatesRetrieved);else{const e={templates:[],configurationPath:"",exception:s.getDataProviderExceptions()[i]};this._notify(e,n.templatesRetrievedFail)}})}}renderTemplate(e,t){const s=this.pageContext.getService("IVssContributionService"),i="ms.vss-build-web.customized-template-data-provider",r={templateParameters:t,validateAssets:!0,sourceProviderType:e.sourceProvider,repositoryId:e.repositoryId||e.repositoryName,connectionId:e.connectionId,branch:e.branch};return s.getDataAsync(i,r).then(e=>e||{content:"",exception:s.getDataProviderExceptions()[i]})}_getParametersKey(e){return JSON.stringify(e)}}t.TemplateSelector.TemplateService=o;class a extends S.VssComponent{constructor(e,t){super(e,t),this._ttiMarked=!1,this._showAllTemplates=(()=>{this.setState({showAllTemplates:!0})}),this.state={showAllTemplates:!1}}render(){let e=void 0,t=[],i=[];const r={content:"",id:s,name:ee.BringYourOwnYamlTitle,description:ee.BringYourOwnYamlDesc,recommendedWeight:0};if(this.props.templateData){for(let s=0;s<this.props.templateData.templates.length;++s){const n=this.props.templateData.templates[s];n.id!==a.s_empty?n.recommendedWeight>0?i.push(n):t.push(n):(e=n,r.iconUrl=e.iconUrl)}t=this._sortTemplatesByName(t),i=this._sortTemplatesByWeight(i),e&&i.push(e),i.length>0&&i.push(r)}if(!this.props.templateData||!this.props.loadComplete)return c.createElement("div",{className:"analyzing-container"},c.createElement("div",null,ee.RepositoryAnalyzing),c.createElement("div",null,c.createElement(y.ProgressIndicator,{className:"progress",percentComplete:this.props.progress})));const n=this.state.showAllTemplates?i.concat(t):i,o={recommendTemplate:n[0],suggestedTemplates:i};return n.length>0?c.createElement("div",{className:"template-view flex-column"},c.createElement(re.WizardList,{wizardListItems:this._mapToWizardListItems(n),onClick:(e,t)=>{this.props.onTemplateSelected(n[t.index],o)}}),!this.state.showAllTemplates&&c.createElement(C.Button,{className:"all-templates-button flex-self-start",onClick:this._showAllTemplates},ee.ShowMore)):c.createElement("div",null)}componentDidMount(){super.componentDidMount(),this._ttiMarked||(this._ttiMarked=!0,this.context.pageContext.getService("IVssPerformanceService").endScenario(se.PerformanceConstants.Area,se.PageLoadScenarios.Templates,!1))}_sortTemplatesByName(e){return e&&e.length>0?e.sort((e,t)=>{const s=e&&e.name?e.name:"",i=t&&t.name?t.name:"";return s.localeCompare(i)}):e}_sortTemplatesByWeight(e){return e&&e.length>0?e.sort((e,t)=>{const s=e&&e.recommendedWeight?e.recommendedWeight:0,i=t&&t.recommendedWeight?t.recommendedWeight:0;if(s==i){const s=e&&e.name?e.name:"",i=t&&t.name?t.name:"";return s.localeCompare(i)}return i-s}):e}_mapToWizardListItems(e){return e.map(e=>({name:e.name,description:e.description,iconUrl:e.iconUrl,iconName:"FileCode"}))}}a.s_empty="empty",i.Services.add("IBuildTemplateService",{serviceFactory:o,options:2})}(),function(e){var s;oe=t.SavePanel={},Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.DefaultBranch="DefaultBranch",e.NewBranch="NewBranch"}(s||(s={}));t.SavePanel.SavePanel=class extends S.VssComponent{constructor(e,t){super(e,t),this._maxGitRefNameLength=400,this._invalidRefNameStrings=["~","^",":"," ","?","*","[","\\","/.",".lock/","//","..","@{"],this._invalidLeadNameStrings=["/","."],this._invalidTrailNameStrings=[".lock",".","/"],this._renderFooter=(()=>{const e=this.props.saveAndRun?ee.SaveAndRunButtonLabel:ee.SaveButtonLabel,t=!(this.props.isSaving||this.props.isRunning),s={className:"primary-action-button",disabled:!this._isValidInput(),onClick:this._onSaveClick,primary:!0,text:e},i={onClick:this.props.onDismiss,text:ee.Cancel},r=t?this.props.showCancelButton?[i,s]:[s]:void 0,n=this.props.isSaving?ee.SavingChanges:ee.CreatingPipeline;return c.createElement(E.PanelFooter,{buttonProps:r},!t&&c.createElement("div",{className:"ci-designer-save-panel-footer flex-row justify-end"},c.createElement(T.Spinner,{className:"flex-row",label:n})))}),this._getCommitToRadioButtons=(()=>{const e=this._normalizeBranchName(this.props.defaultBranch),t=this.props.canCreatePr?ee.SavePanelCreatePullRequest:ee.SavePanelCommitToNewBranch,i=this.props.isSaving||this.props.isRunning;return[c.createElement(R.RadioButton,{id:s.DefaultBranch,key:s.DefaultBranch,text:l.format(ee.SavePanelCommitToDefault,e),disabled:i}),c.createElement(R.RadioButton,{id:s.NewBranch,key:s.NewBranch,text:t,disabled:i})]}),this._checkMessage=(()=>{0===this.state.message.length&&this.setState({message:ee.SavePanelCommitMessage})}),this._setMessage=((e,t)=>{this.setState({message:t})}),this._setDescription=((e,t)=>{this.setState({description:t})}),this._checkNewBranchName=(()=>{0===this.state.newBranchName.length&&this.setState({newBranchName:ee.SavePanelNewBranchName})}),this._setNewBranchName=((e,t)=>{this.setState({newBranchName:t,newBranchNameErrorMessage:this._getBranchNameValidationError(t)})}),this._getSelectedOption=(()=>this.state.createNewBranch?s.NewBranch:s.DefaultBranch),this._onCommitToOptionSelect=(e=>{this.setState({createNewBranch:e===s.NewBranch})}),this._onSaveClick=(()=>{this.props.onSave({description:this.state.description.trim(),createNewBranch:this.state.createNewBranch,message:this.state.message.trim(),newBranchName:this.state.createNewBranch?this.state.newBranchName.trim():""})}),this.state={message:this.props.commitMessage||ee.SavePanelCommitMessage,description:"",createNewBranch:!1,newBranchName:ee.SavePanelNewBranchName,newBranchNameErrorMessage:""}}componentDidUpdate(e,t,s){super.componentDidUpdate(e,t,s),e.defaultBranch&&e.defaultBranch!==this.props.defaultBranch&&this.setState({createNewBranch:!1,newBranchNameErrorMessage:this._getBranchNameValidationError(this.state.newBranchName)})}render(){const e=this.props.saveAndRun?ee.SavePanelTitleSaveAndRun:ee.SavePanelTitleSave,t=this.props.filesAdded&&this.props.filesAdded.length>1?"":l.format(ee.SavePanelDescription,this.props.fileName);return c.createElement("div",null,this.props.isOpen&&c.createElement(E.CustomPanel,{size:1,onDismiss:this.props.onDismiss,lightDismiss:!this.props.isSaving},c.createElement(E.PanelHeader,{titleProps:{text:e,size:1},description:t,onDismiss:this.props.onDismiss}),c.createElement(E.PanelContent,null,this._renderBody()),this._renderFooter()))}_renderBody(){const e=this.props.isSaving||this.props.isRunning;return c.createElement("div",{className:"ci-designer-save-panel-body flex-grow"},this.props.errorMessage&&c.createElement(_.MessageCard,{className:"error-message",severity:"Error"},this.props.errorMessage),c.createElement(I.TextField,{className:"commit-message section-content",label:ee.CommitMessage,disabled:e,value:this.state.message,onBlur:this._checkMessage,onChange:this._setMessage}),c.createElement(I.TextField,{className:"commit-description section-content",label:ee.OptionalExtendedDescription,ariaLabel:ee.OptionalExtendedDescription,disabled:e,placeholder:ee.SavePanelCommitDescriptionPlaceholder,value:this.state.description,multiline:!0,rows:6,resizable:!1,onChange:this._setDescription}),this.props.filesAdded&&this.props.filesAdded.length>1&&c.createElement(ie.FileList,{files:this.props.filesAdded}),c.createElement(R.RadioButtonGroup,{className:"commit-to",selectedButtonId:this._getSelectedOption(),onSelect:this._onCommitToOptionSelect},this._getCommitToRadioButtons()),this.state.createNewBranch&&c.createElement("div",{className:"commit-new-branch"},c.createElement(P.FormItem,{message:this.state.newBranchNameErrorMessage,error:!!this.state.newBranchNameErrorMessage},c.createElement(I.TextField,{disabled:e||!this.state.createNewBranch,value:this.state.newBranchName,onBlur:this._checkNewBranchName,onChange:this._setNewBranchName}))))}_normalizeBranchName(e){return e&&e.startsWith("refs/heads/")?e.substring("refs/heads/".length):e}_isValidInput(){return this.state.message.length>0&&!(this.state.createNewBranch&&(!this.state.newBranchName||this.state.newBranchNameErrorMessage))}_getBranchNameValidationError(e){if(!e||0===e.length)return"";if(("refs/heads/"+e).length>this._maxGitRefNameLength)return l.format(ee.BranchNameErrorTooLong,this._maxGitRefNameLength);const t=this._normalizeBranchName(this.props.defaultBranch);if(l.equals(e,t,!0))return ee.BranchNameErrorSameAsTarget;let s=null;return this._invalidRefNameStrings.some(t=>e.indexOf(t)>-1&&(s=t,!0)),s?l.format(ee.BranchNameErrorInvalidCharacter,s):(this._invalidLeadNameStrings.some(t=>0===e.lastIndexOf(t,0)&&(s=t,!0)),s?l.format(ee.BranchNameErrorInvalidLeadCharacter,s):(this._invalidTrailNameStrings.some(t=>{const i=e.length-t.length;return i>=0&&e.indexOf(t,i)===i&&(s=t,!0)}),s?l.format(ee.BranchNameErrorInvalidTrailCharacter,s):""))}}}(),function(e){ae=t.YamlEditor={},Object.defineProperty(t,"__esModule",{value:!0});t.YamlEditor.YamlEditor=class extends S.VssComponent{constructor(e,t){super(e,t),this._disposables=[],this._onEditorCreated=(e=>{e&&(this._editor=e,this._disposables.push(this._editor),this.props.onEditorCreated&&this.props.onEditorCreated(e),this.setState({isEditorLoaded:!0},()=>{this._editor&&this._editor.layout()}))}),this._onResizeHandler=(()=>{this._editor&&this._editor.layout()}),this._onThemeChanged=(()=>{const e=this._getEditorTheme();this.setState({monacoTheme:e})}),this.state={isEditorLoaded:!1,monacoTheme:this._getEditorTheme()}}render(){return c.createElement(c.Fragment,null,this.props.spinnerMessage?this._getSpinner(this.props.spinnerMessage):c.createElement(c.Fragment,null,c.createElement(s,{content:this.props.content,errorMessage:this.props.errorMessage,isReadOnly:this.props.isReadOnly,elementToFocusOnEscape:this.props.elementToFocusOnEscape,monacoTheme:this.state.monacoTheme,onEditorContentUpdated:this.props.onEditorContentUpdated,onEditorCreated:this._onEditorCreated}),!this.state.isEditorLoaded&&this._getSpinner(ee.LoadingEditor)),this.state.isEditorLoaded&&c.createElement(S.WrappedComponent,{dependencies:["ms.vss-build-web.pipelines-language"],wrappedType:"azure-pipelines-language-component",pageContext:this.context.pageContext,editor:this._editor}))}componentDidMount(){window.addEventListener("resize",this._onResizeHandler),this._themeService.subscribe(this._onThemeChanged,"themeChanged")}componentWillUnmount(){window.removeEventListener("resize",this._onResizeHandler),this._themeService.unsubscribe(this._onThemeChanged,"themeChanged"),this._editor&&(this.props.onEditorDisposing&&this.props.onEditorDisposing(this._editor),this._disposables.forEach(e=>e.dispose()),this._editor=void 0)}componentDidUpdate(e,t,s){super.componentDidUpdate(e,t,s),this._editor&&this.props.sidePanelIsOpen!==e.sidePanelIsOpen&&(this._editor.updateOptions({minimap:{enabled:!this.props.sidePanelIsOpen}}),this._editor.layout())}_getSpinner(e){return c.createElement(T.Spinner,{className:"absolute-fill",size:"large",label:e})}_getEditorTheme(){const e=this._themeService.getCurrentTheme();return e&&e.isDark?"vs-dark":"vs"}get _themeService(){return this.context.pageContext.getService("IVssThemeService")}};class s extends c.PureComponent{constructor(e){super(e),this._editorOptions={fontSize:14,lineNumbersMinChars:8,readOnly:this.props.isReadOnly,renderWhitespace:"all",fixedOverflowWidgets:!0,quickSuggestions:{comments:!1,strings:!0,other:!0},quickSuggestionsDelay:200,suggestOnTriggerCharacters:!0,wordBasedSuggestions:!1,minimap:{enabled:!1}}}render(){const e=Object.assign({},this._editorOptions,{readOnly:this.props.isReadOnly});return c.createElement(w.LegacyComponent,{className:"ci-editor-host"+(this.props.errorMessage?" ci-show-error":""),wrappedType:"vss-code-editor-type",modules:["CodeEditor/Components/Editor"],monacoTheme:this.props.monacoTheme,editorOptions:e,elementToFocusOnEscape:this.props.elementToFocusOnEscape,editorRef:this.props.onEditorCreated,onContentUpdated:this.props.onEditorContentUpdated,content:{content:this.props.content,contentType:"application/x-yaml"}})}}}(),function(e){le=t.YamlWizardPage={},Object.defineProperty(t,"__esModule",{value:!0});t.YamlWizardPage.YamlWizardPage=class extends S.VssComponent{constructor(e,t){super(e,t),this._renderHeader=(()=>c.createElement("div",{className:"ci-editor-header header-section flex-row"},c.createElement("div",{className:"ci-editor-title"},c.createElement("div",{className:"subheader body-m secondary-text"},ee.NewPipeline),c.createElement("div",{className:"title-l"},ee.ReviewYourPipelineYAML)),c.createElement("div",{className:"ci-editor-action-buttons flex-self-end"},c.createElement(C.Button,{primary:!0,className:N.css("ci-editor-action-button",te.EditorConstants.ElementToFocusOnEscape),onClick:this.state.actionButtonOnClick,disabled:!this.state.isEditorReady||!this.state.content||this.state.isRunning},this.state.isRunning&&c.createElement(T.Spinner,{className:"loading-indicator",size:"small"}),this.state.isRunning?ee.Configuring:this.state.actionButtonText)))),this._navigateAwayHandler=(e=>{this._isDirty()&&(e.returnValue=ee.ConfirmLosingUnsavedChange)}),this._onHistoryChanged=(e=>{this._isDirty()&&!confirm(ee.ConfirmLosingUnsavedChange)||(this._switchHistoryChangeHandler(this._onHistoryChanged,this.props.onHistoryChanged),this.props.onHistoryChanged(e))}),this._onEditorCreated=(e=>{e&&(this._editor=e,e.focus(),this.setState({isEditorReady:!0}))}),this._onEditorContentUpdated=(e=>{if(e){const t=e.getValue()||"";if(t!==this.state.content){const e=this._isDirty(),s=!this._isExistingConfigFile()||e;this.setState({content:t,actionButtonText:s?ee.SaveAndRunButtonLabel:ee.RunButtonLabel,actionButtonOnClick:s?this._showSavePanel:this._runBuild,yamlWasEdited:e})}}}),this._showSavePanel=(()=>{const e=this._editor&&this._editor.getValue()||"";this.setState({content:e,savePanelIsOpen:!0,isSaving:!1},()=>this.props.onAction("ShowSavePanel"))}),this._runBuild=(()=>{this._ensureEditorIsReadOnly(!0),this.setState({isRunning:!0,errorMessage:""},()=>this.props.onAction("Run",{yamlWasEdited:this.state.yamlWasEdited}));const e={sourceProviderType:this.props.wizardState.sourceProvider,connectionId:this.props.wizardState.connectionId,id:this.props.wizardState.repositoryId,name:this.props.wizardState.repositoryName,defaultBranch:this.props.wizardState.branch},t=this.state.sourceBranch,s=this.state.savedFileInfo,i=this.props.path,r=this.props.wizardState.pipelinePath,n=this.context.pageContext.getService("IPipelineService");n.createAndRunPipeline(e,i,"Hosted Ubuntu 1604",t,s,r).then(e=>{if(e){if(e.pipeline){const t=this.context.pageContext.getService("ITfsPageService").getData().project.id||l.EmptyGuidString,s=l.format("{0}:{1}",t,e.pipeline.id);this.props.onAction("PipelineCreated",{ProjectAndPipelineId:s}),this.setState({pipelineCreated:e.pipeline})}e.pipelineBuildWebUrl&&this.props.redirectToPipeline(e.pipelineBuildWebUrl),e.queuePipelineErrorMessage&&this._handleRunError(e.queuePipelineErrorMessage)}this._ensureEditorIsReadOnly(!1);const t=n.getPipelineErrorMessage();t&&this._handleRunError(t)})}),this._onDataProviderQueryEnd=(e=>{if(e.dataProviderExceptions){const t=e.dataProviderExceptions["ms.vss-build-web.create-and-run-pipeline-data-provider"];t&&this._handleRunError(t.message)}}),this._saveAndRun=(e=>{this._ensureEditorIsReadOnly(!0),this.setState({saveErrorMessage:"",isSaving:!0},()=>this.props.onAction(e.createNewBranch?"SavePR":"SaveCommit"));const t=this._editor&&this._editor.getValue()||"",s={connectionId:this.props.wizardState.connectionId,sourceProviderType:this.props.wizardState.sourceProvider,id:this.props.wizardState.repositoryId,projectId:this.props.wizardState.repositoryProjectId};e.skipCi=!0;const i=this.context.pageContext.getService("IYamlFileService");if(this.props.additionalFiles){const r=[{path:this.props.path,content:t,oldObjectId:this.props.contentSha},...this._mapToCommitFileInfo(this.props.additionalFiles)];i.commitFiles(s,this.props.wizardState.branch,r,e).then(e=>{this._onSave(e,t)},e=>{this._handleSaveError(e.message)})}else i.commitFile(s,this.props.wizardState.branch,this.props.path,t,e,this.props.contentSha).then(e=>{this._onSave(e,t)},e=>{this._handleSaveError(e.message)})}),this._onSave=((e,t)=>{this._lastSavedContent=t,this.setState({isSaving:!1,sourceBranch:e.branch,savedFileInfo:e},()=>{this._runBuild()})}),this._dismissSavePanel=(()=>{this.state.isSaving||this.setState({saveErrorMessage:"",savePanelIsOpen:!1})}),this._handleRunError=(e=>{this.setState({isRunning:!1,savePanelIsOpen:!1,errorMessage:e}),this._ensureEditorIsReadOnly(!1)}),this._handleSaveError=(e=>{this.setState({saveErrorMessage:e,isSaving:!1,isRunning:!1,savePanelIsOpen:!0}),this._ensureEditorIsReadOnly(!1)}),this._mapToFileListItems=(e=>e.map(e=>({name:e.destinationPath,description:e.description,type:this._getFileType(e.path)}))),this._getFileType=(e=>l.endsWith(e,"yml",!0)?ie.FileType.Yaml:ie.FileType.Other),this._mapToCommitFileInfo=(e=>e.map(e=>({path:e.destinationPath,content:e.content,oldObjectId:""}))),this._editorIsReadOnly=!1,this._lastSavedContent=e.content||"",this.state={content:this._lastSavedContent,sourceBranch:"",isEditorReady:!1,isRunning:!1,savePanelIsOpen:!1,isSaving:!1,saveErrorMessage:"",errorMessage:"",pipelineCreated:void 0,savedFileInfo:void 0,actionButtonText:this.props.contentSha?ee.RunButtonLabel:ee.SaveAndRunButtonLabel,actionButtonOnClick:this.props.contentSha?this._runBuild:this._showSavePanel,yamlWasEdited:!1}}componentDidMount(){window.addEventListener("beforeunload",this._navigateAwayHandler),this.context.pageContext.getService("IVssContributionService").subscribe(this._onDataProviderQueryEnd,"dpqCompleted"),this._switchHistoryChangeHandler(this.props.onHistoryChanged,this._onHistoryChanged)}componentWillUnmount(){window.removeEventListener("beforeunload",this._navigateAwayHandler),this.context.pageContext.getService("IVssHistoryService").unsubscribe(this._onHistoryChanged),this.context.pageContext.getService("IVssContributionService").unsubscribe(this._onDataProviderQueryEnd,"dpqCompleted")}render(){const e=!l.equals(this.props.wizardState.sourceProvider,a.RepositoryTypes.Bitbucket,!0)||f.isFeatureFlagEnabled(this.context.pageContext,"Build2.BitbucketEditYamlPullRequest",!1);return c.createElement("div",{className:"ci-yaml-wizard-view flex-column flex-grow"},this._renderHeader(),this.state.errorMessage&&""!==this.state.errorMessage&&c.createElement(_.MessageCard,{className:"ci-editor-error",severity:"Error"},this.state.errorMessage),c.createElement(x.Card,{className:"ci-editor-content flex-grow",titleProps:{text:this._trimPath(this.props.path),size:1},contentProps:{contentPadding:!1}},c.createElement("div",{className:"relative full-size"},c.createElement(ae.YamlEditor,{errorMessage:"",content:this.state.content,isReadOnly:!1,elementToFocusOnEscape:"."+te.EditorConstants.ElementToFocusOnEscape,onEditorContentUpdated:this._onEditorContentUpdated,onEditorCreated:this._onEditorCreated,sidePanelIsOpen:!1}))),c.createElement(oe.SavePanel,{errorMessage:this.state.saveErrorMessage,fileName:this.props.path,defaultBranch:this.props.wizardState.branch||ee.DefaultBranch,isOpen:this.state.savePanelIsOpen,isSaving:this.state.isSaving,isRunning:this.state.isRunning,saveAndRun:!0,canCreatePr:e,onSave:this._saveAndRun,onDismiss:this._dismissSavePanel,filesAdded:this.props.additionalFiles&&[{name:this.props.path,description:ee.YamlFileDescription,type:ie.FileType.Yaml},...this._mapToFileListItems(this.props.additionalFiles)]}))}_switchHistoryChangeHandler(e,t){const s=this.context.pageContext.getService("IVssHistoryService");s.unsubscribe(e),s.subscribe(t)}_isDirty(){return!!this._editor&&this._editor.getValue()!==this._lastSavedContent}_trimPath(e){return e&&(e=(e=e.startsWith("./")?e.slice(2):e).startsWith("/")?e.slice(1):e),e}_isExistingConfigFile(){return!!this.props.contentSha}_ensureEditorIsReadOnly(e){this._editor&&this._editorIsReadOnly!==e&&(this._editorIsReadOnly=e,this._editor.updateOptions({readOnly:e}))}}}(),function(e){t.Wizard={},Object.defineProperty(t,"__esModule",{value:!0});class i extends S.VssComponent{constructor(e,t){super(e,t),this._ttiMarked=!1,this._mapToWizardListItems=(e=>e.map(e=>{const t=[];return e.supportsYaml&&t.push(ee.Yaml),{name:e.name,description:e.description,iconUrl:e.iconAsset?L.getAssetLocation(this.context.pageContext,e.iconAsset):void 0,iconName:e.iconName,labels:t}})),this._onHistoryChanged=(e=>{this.setState(this._readStateFromHistory(e.newState.state))}),this._onSourceProviderClick=(e=>{if(e.isClassic){const t=this._getClassicEditorLink(e.key),s="new-pipeline-wizard.old-designer",i={telemetrySession:this.state.wizardState.telemetrySession,sourceProvider:e.key};n.onClickFPS(this.context.pageContext,t,!0,void 0,{telemetrySource:s,telemetryProperties:i})}else{const t=this.context.pageContext.getService("IVssHistoryService"),s=t.generateUrl({sourceProvider:e.key,telemetrySession:this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession()},2);t.pushState(void 0,s),this.setState({sourceProviderKey:e.key,repositorySubheader:"",templateSubheader:"",stepNumber:2,wizardState:t.getState()},()=>this._recordTelemetryInfo())}}),this._onSourceProviderComplete=((e,t)=>{e||(e={}),e.sourceProviderComplete="true",e.telemetrySession=this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession();const s=this.context.pageContext.getService("IVssHistoryService"),i=s.generateUrl(e,2);s.pushState(void 0,i),t||(t={}),this.setState({stepNumber:3,repositorySubheader:e.repositoryName||"",repositoryUrl:e.repositoryUrl,templateSubheader:"",wizardState:Object.assign({},this.state.wizardState,e,t)},()=>this._recordTelemetryInfo())}),this._onTemplateSelected=((e,t,s,i,r)=>{if(e||i){const t={branch:i||this.state.wizardState&&this.state.wizardState.branch||"",template:e?e.name:this.state.template?this.state.template.name:"",telemetrySession:this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession()},s=this.context.pageContext.getService("IVssHistoryService"),r=s.generateUrl(t,2);s.pushState(void 0,r)}this._onTemplateSelectionComplete(4,e,t,s,i,r)}),this._getSourceProviderTile=(e=>this._sourceProviders.find(t=>l.equals(t.key,e,!0))),this._recordTelemetryInfo=((e,t)=>{const s=(e,t,s)=>{this.state.wizardState&&this.state.wizardState[t]?e[t]=this.state.wizardState[t]:s&&(e[t]=s)},i=(e,t)=>{this.state.wizardState&&this.state.wizardState[t]&&(e[t]="true"===this.state.wizardState[t].toLowerCase())},r={};if(e)r.action=e;else switch(this.state.stepNumber){case 1:r.action="ChooseConnection";break;case 2:r.action="ChooseRepo";break;case 3:r.action="ChooseTemplate";break;case 4:r.action="EditYaml";break;default:r.action="unknown"}s(r,"externalOwnerId"),s(r,"externalOwnerName"),i(r,"externalOwnerIsAUser"),s(r,"entryPoint"),i(r,"repositoryIsFork"),i(r,"repositoryIsPrivate"),s(r,"telemetrySession",this._createTelemetrySession()),this.state.wizardState&&this.state.wizardState.safeRepository&&(r.repositoryName=this.state.wizardState.safeRepository);const n=this._getSourceProviderTile(this.state.sourceProviderKey||"");if(r.repositoryType=n&&n.name||"",this.state.template&&this.state.template.name&&(r.templateName=this.state.template.name),this.state.repoAnalysis&&this.state.repoAnalysis.recommendTemplate&&(r.recommendedTemplateName=this.state.repoAnalysis.recommendTemplate.name,r.suggestedTemplateNames=this.state.repoAnalysis.suggestedTemplates.map(e=>e.name)),t)for(const e in t)r[e]=t[e];this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","CreatePipeline",r)}),this._markRepositoryTTI=(()=>{this._markTTI(se.PageLoadScenarios.Repository)}),this._markTTI=(e=>{this._ttiMarked||(this._ttiMarked=!0,this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(se.PerformanceConstants.Area,e))}),this._getWizardItems=(e=>[ee.Connect,ee.Select,ee.Configure,ee.Review].map((t,s)=>({title:t,itemState:new r.ObservableValue(e>s+1?"Complete":"None")}))),this._getFallbackLink=(()=>{return this.context.pageContext.getService("IBuildLinkingService").getNewDefinitionEditUrl(this.state.wizardState.pipelinePath)+"&id=0"}),this._getClassicEditorLink=(e=>this._getFallbackLink()+"&repositoryType="+e),this._redirectToPipeline=(e=>{4==this.state.stepNumber&&s.openLinkSecurely(e)}),this._normalizeBranchName=(e=>{return e&&l.startsWith(e,"refs/heads/",!0)?e.substring("refs/heads/".length):e}),this._getAdditionalFilesForTemplate=(e=>{if(e&&e.assets)return e.assets.filter(e=>e&&l.equals(e.type,te.TemplateAssetTypes.File,!0))}),this._configurationPath="./azure-pipelines.yml";const i=this.context.pageContext.getService("IVssHistoryService").getState(),o=this.context.pageContext.getService("IVssContributionService").getContributionsByType("ms.vss-build-web.acquisition-source-provider-tile");this._sourceProviders=Object.keys(o).map(e=>o[e]).sort((e,t)=>e.name.localeCompare(t.name)),this.state=i?this._readStateFromHistory(i):{stepNumber:1,showSaveAndRun:!0,wizardState:{}},this._recordTelemetryInfo()}componentDidMount(){this.context.pageContext.getService("IVssHistoryService").subscribe(this._onHistoryChanged),1==this.state.stepNumber&&this._markTTI(se.PageLoadScenarios.Sources)}componentWillUnmount(){this.context.pageContext.getService("IVssHistoryService").unsubscribe(this._onHistoryChanged)}render(){return c.createElement(D.Surface,{background:4==this.state.stepNumber?1:0},c.createElement(A.Page,{className:"ci-designer-wizard-view flex-grow",orientation:0},c.createElement(M.Wizard,{className:"wizard-view-step-list page-content page-content-top flex-noshrink",items:this._getWizardItems(this.state.stepNumber),selectedIndex:this.state.stepNumber-1}),c.createElement("div",{className:"wizard-view-detail page-content flex-column flex-grow"},this._renderDetail())))}_renderDetail(){switch(this.state.stepNumber){default:case 1:return this._renderSourceProviderSelector();case 2:return this._getSourceProviderWizard();case 3:return c.createElement(ne.TemplateSelector,{wizardState:this.state.wizardState,onTemplateSelected:this._onTemplateSelected});case 4:return this._renderYamlWizardPage()}}_renderSourceProviderSelector(){return c.createElement("div",{className:"source-provider-selector"},c.createElement("div",{className:"header-section"},c.createElement("div",{className:"subheader  body-m secondary-text"},ee.NewPipeline),c.createElement("div",{className:"header title-l"},ee.WhereIsYourCode)),c.createElement(re.WizardList,{wizardListItems:this._mapToWizardListItems(this._sourceProviders),onClick:(e,t)=>{this._onSourceProviderClick(this._sourceProviders[t.index])}}),c.createElement("div",{className:"old-designer-fallback"},c.createElement(F.FormatComponent,{format:ee.OldDesignerFallbackFormat},c.createElement(B.FPSLink,{href:this._getFallbackLink(),telemetrySource:"new-pipeline-wizard.old-designer",telemetryProperties:{telemetrySession:this.state.wizardState.telemetrySession}},ee.OldDesignerLinkText))))}_renderYamlWizardPage(){const e=this.state.configuration?this.state.configuration.path:this.state.wizardState.configPath?this.state.wizardState.configPath:this._configurationPath;return c.createElement(le.YamlWizardPage,{wizardState:this.state.wizardState,content:this.state.template?this.state.template.content:this.state.configuration.content,path:e,url:this.state.configuration?this.state.configuration.webUrl:void 0,onAction:this._recordTelemetryInfo,onHistoryChanged:this._onHistoryChanged,contentSha:this.state.configuration?this.state.configuration.objectId:"",redirectToPipeline:this._redirectToPipeline,additionalFiles:this._getAdditionalFilesForTemplate(this.state.template)})}_readStateFromHistory(e){let t=1,s=void 0,i=void 0,r=void 0;const n=e.sourceProvider;return n&&(s=this._getSourceProviderTile(n))&&(t=2),"true"===e.sourceProviderComplete&&(t=3,i=e.repositoryName,r=e.repositoryUrl),{stepNumber:t,sourceProviderKey:n,repositorySubheader:i,repositoryUrl:r,showSaveAndRun:!0,templateSubheader:"",wizardState:Object.assign({},e,{branch:this._normalizeBranchName(e.branch)})}}_onTemplateSelectionComplete(e,t,s,i,r,n){this.setState({stepNumber:e,template:t,repoAnalysis:s,configuration:i,templateSubheader:t?t.name:ee.ExistingFileFound,showSaveAndRun:!!t,wizardState:Object.assign({},this.state.wizardState,{branch:r||this.state.wizardState.branch,configPath:n||""})},()=>this._recordTelemetryInfo())}_getSourceProviderWizard(){const e=(this.context.pageContext.getService("IVssLayoutManager").getComponentsForRegion("sourceProviderWizard")||[]).find(e=>{const t=e.componentProperties.key;return!!t&&l.equals(t.toString(),this.state.sourceProviderKey,!0)});return e?c.createElement(S.WrappedComponent,Object.assign({wrappedType:e.componentType},e.componentProperties,{wizardState:this.state.wizardState,onComplete:this._onSourceProviderComplete,onUpdate:this._recordTelemetryInfo,onTTI:this._markRepositoryTTI})):c.createElement("div",null,"The source provider key '",this.state.sourceProviderKey,"' was not recognized.")}_createTelemetrySession(){return l.newGuid()}}t.Wizard.DesignerWizardContent=i,S.Components.add("ci-designer-wizard-view",i)}(),function(e){ce=t.EditorAuthLandingPage={},Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){const s=e.getService("IVssContributionService").getContributionsByType("ms.vss-build-web.acquisition-source-provider-tile"),i=Object.keys(s).map(e=>s[e]).filter(e=>e.key===t);return i.length>0?i[0]:void 0}t.EditorAuthLandingPage.EditorAuthLandingPage=class extends S.VssComponent{constructor(e,t){super(e,t),this._createAuthRequest=(()=>{this.props.loginUrl&&s.openLinkSecurely(this.props.loginUrl)}),this._sourceProvider=i(this.context.pageContext,this.props.sourceProvider.getKey())||{};const r=this.context.pageContext.getService("ITfsPageService").getData();this.state={projectId:r.project.id,yamlLink:this.props.yamlFileLink}}componentDidMount(){if(null==this.state.yamlLink){const e={branchName:this.props.repository.defaultBranch,repositoryName:this.props.repository.name};this.props.sourceProvider.fetchLinks([e]).then(e=>{if(e&&e.length>0){const t=e[0];t&&t.repositoryLink&&this.setState({yamlLink:t.repositoryLink})}})}}componentWillUnmount(){}render(){const e=l.format(ee.PipelineHostedOn,this._sourceProvider.name),t=l.format(ee.AuthorizeWithExternalIdentity,this._sourceProvider.name),s=l.format(ee.ViewOnExternalSite,this._sourceProvider.name);return c.createElement("div",{className:"ci-designer-auth-landing-page-body flex-grow flex-column justify-center flex-center"},c.createElement("div",{className:"circle flex flex-center"},c.createElement(k.VssIcon,{className:"source-provider-icon",iconName:this.props.sourceProvider.getRepoIconName()})),c.createElement("div",{className:"primary-text"},e),c.createElement("div",{className:"secondary-text"},t),c.createElement(C.Button,{className:"authorize-button",primary:!0,text:ee.AuthorizeButtonText,onClick:this._createAuthRequest}),c.createElement(F.FormatComponent,{format:ee.OrFormat},c.createElement(B.FPSLink,{href:this.state.yamlLink,telemetrySource:"pipeline-editor.auth-landing-page",telemetryProperties:{clickedOn:"viewOnGitHub"},"aria-label":s},s)))}},t.EditorAuthLandingPage.getSourceProviderTile=i}(),function(e){pe=t.EditorHeader={},Object.defineProperty(t,"__esModule",{value:!0});t.EditorHeader.EditorHeader=class extends S.VssComponent{constructor(){super(...arguments),this._gotoPipelineResults=(e=>{const t=this.buildLinkingService.getDefinitionUrl(this.props.definition&&this.props.definition.id);this._gotoUrl(t,e)}),this._gotoLegacyDesigner=((e,t)=>{const s=this.buildLinkingService.getDefinitionEditUrl(this.props.definition.id,e);this._gotoUrl(s,t)})}render(){return c.createElement(c.Fragment,null,c.createElement(z.Header,{className:"ci-editor-header",title:this._getTitle(),titleSize:1,backButtonProps:{onClick:this._gotoPipelineResults},commandBarItems:this._getCommandBarItems()}),this._getMessages())}_getTitle(){const e=this.props.definition&&this.props.definition.queueStatus||0;let t="";return 2===e?t=ee.PipelineStatusDisabled:1===e?t=ee.PipelineStatusPaused:this.props.definition&&!this._isCIEnabled()&&(t=ee.PipelineStatusCIDisabled),c.createElement(c.Fragment,null,c.createElement("span",null,this.props.title),t&&c.createElement("span",{className:"pipeline-status"},t))}_getCommandBarItems(){const e=[],t=f.isFeatureEnabled(this.context.pageContext,"ms.vss-build-web.ci-new-landing-pages",!1),s=f.isFeatureFlagEnabled(this.context.pageContext,"Build2.NewQueuePanel",!1),i=t||s,r={id:"runsave",className:te.EditorConstants.ElementToFocusOnEscape,text:this.props.actionButtonLabel,important:!0,disabled:this.props.actionDisabled,isPrimary:!0,onActivate:this.props.onActionClick};if(e.push(r),!i){const t={id:"runWithParameters",text:ee.CommandRunWithParameters,iconProps:{iconName:"BuildQueueNew"},important:!1,disabled:!this.props.definition||this.props.isYamlDirty||this.props.actionDisabled,onActivate:this.props.onRunWithParameters};e.push(t)}const n={id:"settings",text:ee.CommandSettings,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Settings"},onActivate:this.props.onSettingsOpen};e.push(n),e.push({id:"sep1",itemType:1,important:!1});const o={id:"triggers",text:ee.CommandTriggers,important:!1,disabled:!this.props.definition,iconProps:{iconName:"LightningBolt"},onActivate:(e,t)=>this._gotoLegacyDesigner(te.LegacyDesignerTabKeys.Triggers,t)};e.push(o);const a={id:"variables",text:ee.CommandVariables,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Variable"},onActivate:(e,t)=>this._gotoLegacyDesigner(te.LegacyDesignerTabKeys.Variables,t)};return e.push(a),e}_gotoUrl(e,t){t&&(t.ctrlKey||t.shiftKey)?s.openLinkSecurely(e,!0):n.onClickFPS(this.context.pageContext,e,!0)}_getMessages(){const e=this._getErrorBar(),t=this._getBuildMessageBar();if(e||t)return c.createElement("div",{className:"page-content flex-row flex-noshrink"},e,t)}_getErrorBar(){if(this.props.errorMessage)return c.createElement(_.MessageCard,{className:"flex-grow",severity:"Error",buttonProps:this.props.errorActions,onDismiss:this.props.onErrorMessageDismissed},this.props.errorMessage)}_getBuildMessageBar(){if(this.props.buildMessageInfo){const e=this.props.buildMessageInfo,t=e.id>0?this.buildLinkingService.getBuildUrl(e.id):"";return c.createElement(_.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this.props.onBuildMessageDismissed},e.isQueuing?ee.BuildQueuingMessage:c.createElement(F.FormatComponent,{format:ee.BuildQueuedMessage},c.createElement(B.FPSLink,{href:t},l.format(ee.BuildNumberFormat,e.number))))}}_isCIEnabled(){const e=this.props.definition.triggers;return!(!e||!e.find(e=>2===e.triggerType))}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}};t.EditorHeader.EditorSubheader=class extends S.VssComponent{render(){const e=this.props.sidePanelIsOpen;return c.createElement("div",{className:"ci-editor-subheader flex-row absolute-fill"},this.props.fileName&&c.createElement(c.Fragment,null,this._getBranchPicker(),c.createElement("div",{className:"subheader-items flex-row flex-grow h-scroll-hidden"},this._getRepository(),this._getFilePath()),!e&&c.createElement(V.HeaderCommandBar,{items:[{id:"show-hide-tasks",className:S.css("show-yaml-side-panel-button",te.EditorConstants.YamlAssistantToggleElement),text:e?"":ee.SidePanelOpen,onActivate:this.props.onSidePanelButtonClick,important:!0,iconProps:{iconName:e?"ClosePane":"OpenPane"},subtle:!0}]})))}_getBranchPicker(){const e=this.props.definition.repository;return c.createElement(O.BranchDropdown,{className:"branch-picker",ariaLabel:ee.Branch,repositoryType:e.type,repositoryId:e.id,defaultBranch:this.props.branchName,connectionId:e.properties&&e.properties.connectedServiceId,isDrodownFullWidth:!1,comboBoxMinWidth:120,comboBoxMaxWidth:350,onBranchSelected:this.props.onBranchSelected,onError:this.props.onBranchPickerError})}_getRepository(){return c.createElement(c.Fragment,null,c.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},this.props.repositoryIconName&&c.createElement(k.VssIcon,{iconName:this.props.repositoryIconName}),c.createElement(U.Tooltip,{text:this.props.repositoryName,overflowOnly:!0},this.props.repositoryUrl?c.createElement(B.FPSLink,{className:"repository-name text-ellipsis",supportsFPS:this.props.supportFPS,href:this.props.repositoryUrl},this.props.repositoryName):c.createElement("span",{className:"repository-name text-ellipsis"},this.props.repositoryName))),c.createElement("div",{className:"flex-row flex-center"},c.createElement("span",{className:"separator"},"/")))}_getFilePath(){let e=this.props.fileName;const t=(e=(e=(e=e.replace("\\","/")).startsWith("./")?e.substr(2):e).startsWith("/")?e.substr(1):e).lastIndexOf("/"),s=t>0?e.substr(0,t):"",i=t>0?e.substr(t+1):e;return c.createElement(c.Fragment,null,s&&c.createElement(c.Fragment,null,c.createElement("div",{className:"file-path flex-row flex-center"},c.createElement(U.Tooltip,{text:e,overflowOnly:!0},c.createElement("span",{className:"text-ellipsis"},s))),c.createElement("div",{className:"flex-row flex-center"},"/")),c.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},c.createElement(U.Tooltip,{text:e,overflowOnly:!0},this.props.fileUrl?c.createElement(B.FPSLink,{className:"file-name text-ellipsis",supportsFPS:this.props.supportFPS,href:this.props.fileUrl},i):c.createElement("span",{className:"file-name text-ellipsis"},i))))}}}(),function(e){function s(e,t){return c.createElement(Y.Dialog,{titleProps:{text:ee.ConfirmLosingUnsavedChangeTitle},onDismiss:t,footerButtonProps:[{primary:!0,onClick:e,text:ee.Leave},{onClick:t,text:ee.Stay}],lightDismiss:!1},ee.ConfirmLosingUnsavedChange)}de=t.LoseChangesDialog={},Object.defineProperty(t,"__esModule",{value:!0}),t.LoseChangesDialog.addNavigateAwayListener=function(e){document.body.addEventListener("fpsStarting",e),window.addEventListener("beforeunload",e)},t.LoseChangesDialog.removeNavigateAwayListener=function(e){document.body.removeEventListener("fpsStarting",e),window.removeEventListener("beforeunload",e)},t.LoseChangesDialog.showLoseChangesDialog=function(e,t){const i=t.detail;if(i&&i.href){if(i.data&&i.data.isPageSwitchConfirmed)return;t.preventDefault(),e.getService("IVssLayoutManager").renderCallout(e=>s(()=>{e(),i.data=i.data||{},i.data.isPageSwitchConfirmed=!0,n.FastPageSwitch(i.pageContext,i.href,i.recordHistoryEntry,i.data)},()=>{e()}))}else t.returnValue=ee.ConfirmLosingUnsavedChange},t.LoseChangesDialog.getLoseChangesDialog=s}(),function(e){he=t.YamlSidePanel={},Object.defineProperty(t,"__esModule",{value:!0});t.YamlSidePanel.YamlSidePanel=class extends S.VssComponent{constructor(){super(...arguments),this._onYamlGenerated=(e=>{let t="";switch(e.eventType){case 0:default:t=ee.AddedSnippet}this._insertText(e.yamlString,t)}),this._insertText=((e,t)=>{e.lastIndexOf("\r\n")===e.length-2&&(e=e.substr(0,e.length-2));const s=e.split("\r\n"),i=this.props.editor.getSelection(),r=s.length,n=s[r-1].length+1;if(i.startColumn===i.endColumn&&i.startLineNumber===i.endLineNumber){const o=this.props.editor.getModel().getLineContent(i.startLineNumber);/\S/.test(o)?this._moveCursorToEndOfLineAndInsert(e,t,i,r,n):this._insertWhilePreservingTabDepth(e,s,t,o,i,r,n)}else this._replaceCurrentlySelectedText(e,t,i,r,n)})}render(){return this.props.isOpen&&this.props.editor?c.createElement("div",{className:N.css("flex-noshrink flex-column yaml-side-panel",!this.props.isOpen&&"hidden")},c.createElement(S.WrappedComponent,{dependencies:["ms.vss-build-web.designer-extensions.yaml-assistant","ms.vss-build-web.yaml-assistant-data-provider"],wrappedType:"yaml-assistant-view",wrappedProps:{onYamlGenerated:this._onYamlGenerated,onDismiss:this.props.onDismiss}})):null}_moveCursorToEndOfLineAndInsert(e,t,s,i,r){const n=this.props.editor.getModel().getLineMaxColumn(s.startLineNumber);e="\r\n"+e;const o=this._createRange(s.startLineNumber,n,s.startLineNumber,n),a=this._createSelection(s.startLineNumber+1,0,s.startLineNumber+i,r);this._insertTextToMonaco(e,t,o,a)}_insertWhilePreservingTabDepth(e,t,s,i,r,n,o){const a=this.props.editor.getModel().getLineMaxColumn(r.startLineNumber),l=i.substr(0,r.startColumn);e=t.join("\r\n"+l);const c=this._createRange(r.startLineNumber,r.startColumn,r.endLineNumber,a),p=this._createSelection(r.startLineNumber,0,r.startLineNumber+n-1,o+l.length);this._insertTextToMonaco(e,s,c,p)}_replaceCurrentlySelectedText(e,t,s,i,r){const n=this._createRange(s.startLineNumber,s.startColumn,s.endLineNumber,s.endColumn),o=this._createSelection(s.startLineNumber,s.startColumn,s.startLineNumber+i-1,r);this._insertTextToMonaco(e,t,n,o)}_insertTextToMonaco(e,t,s,i){const r={identifier:{major:1,minor:1},range:s,text:e,forceMoveMarkers:!0};this.props.editor.executeEdits(t,[r],[i]),this.props.editor.focus(),this._sendToast(t)}_sendToast(e){const t=this.context&&this.context.pageContext.getService("IGlobalMessagesService");t&&t.addToast({message:e,duration:2e3})}_createRange(e,t,s,i){return new monaco.Range(e,t,s,i)}_createSelection(e,t,s,i){return new monaco.Selection(e,t,s,i)}}}(),function(e){t.Editor={},Object.defineProperty(t,"__esModule",{value:!0});const i="pipeline-editor-view bolt-page-grey flex flex-column flex-grow";class r extends S.VssComponent{constructor(){super(...arguments),this._onEditorContentUpdated=(e=>{if(e&&this.props.onContentUpdated){const t=e.getValue()||"";this.props.onContentUpdated(t)}})}render(){return c.createElement("div",{className:"ci-yaml-editor-tab"},c.createElement("div",{className:"flex-row absolute-fill"},c.createElement("div",{className:"flex-column flex-grow relative"},c.createElement("div",{className:"ci-yaml-subheader relative"},this._getSubHeader()),c.createElement("div",{className:"relative flex-grow"},c.createElement("div",{className:"absolute-fill"},c.createElement(ae.YamlEditor,{content:this.props.content,spinnerMessage:this.props.spinnerMessage,errorMessage:"",isReadOnly:!1,elementToFocusOnEscape:"."+te.EditorConstants.ElementToFocusOnEscape,onEditorContentUpdated:this._onEditorContentUpdated,onEditorCreated:this.props.onEditorCreated,onEditorDisposing:this.props.onEditorDisposing,sidePanelIsOpen:this.props.sidePanelIsOpen})))),c.createElement(he.YamlSidePanel,{editor:this.props.editor,isOpen:this.props.sidePanelIsOpen,onDismiss:this.props.onSidePanelButtonClick})))}_getSubHeader(){const e=this.props.isYamlDirty?" *":"";return c.createElement(pe.EditorSubheader,{branchName:this.props.branchName,definition:this.props.definition,fileName:this.props.fileName+e,fileUrl:this.props.fileUrl,repositoryIconName:this.props.repositoryIconName,repositoryName:this.props.repositoryName,repositoryUrl:this.props.repositoryUrl,supportFPS:this.props.supportFPS,sidePanelIsOpen:this.props.sidePanelIsOpen,onBranchSelected:this.props.onBranchSelected,onBranchPickerError:this.props.onBranchPickerError,onSidePanelButtonClick:this.props.onSidePanelButtonClick})}}S.Components.add("ci-designer-editor-view",class extends S.VssComponent{constructor(e,t){super(e,t),this._ttiRecorded=!1,this._lastCleanContent="",this._authorizeAfterSave=!1,this._onNavigateAway=(e=>{(this.state.isYamlDirty||this.state.settingsIsSaving)&&de.showLoseChangesDialog(this.context.pageContext,e)}),this._clearBuildMessage=(()=>{this.state.buildMessageInfo&&this.setState({buildMessageInfo:void 0},this._resizeEditor)}),this._clearErrorMessage=(()=>{this.state.errorMessage&&this.setState({errorMessage:"",errorActions:void 0},this._resizeEditor)}),this._closeConnectionCard=(()=>{this.setState({useAppConnectionAction:void 0},this._resizeEditor)}),this._switchToAppConnection=(async e=>{const t=this.state.definition;t.repository.properties=t.repository.properties||[],t.repository.properties.connectedServiceId=e,this._closeConnectionCard(),this.setState({settingsIsSaving:!0,settingsErrorMessage:""});try{await this.pipelineService.savePipeline(t);const e=this.context.pageContext.getService("IVssContributionService");await e.getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{complete:!0},!0),this.setState({definition:t,settingsIsSaving:!1},this._closeConnectionCard),this.state.connection.autoUpgradeToAppConnection||this.context.pageContext.getService("IGlobalMessagesService").addToast({message:ee.ConnectionChanged,duration:5e3})}catch(e){const t=e&&e.message||o.SavePipelineErrorMessage;this._handleSettingsError(t)}}),this._installApp=(async(e,t,s,i)=>{this.context.pageContext.getService("IInstallAppService").installAppForEdit(e,t,s,i)}),this._onEditorCreated=(e=>{e&&(this._editor=e,e.focus(),this.setState({isEditorReady:!0}),this._markTimeToInteractive())}),this._onEditorDisposing=(e=>{let t="";e&&(t=e.getValue()||""),this._editor=null,this.setState({yamlContent:t,isEditorReady:!1})}),this._resizeEditor=(()=>{this._editor&&this._editor.layout()}),this._onYamlContentUpdated=(e=>{this.state.yamlContent!==e&&this.setState({yamlContent:e,isYamlDirty:e!==this._lastCleanContent})}),this._showSavePanel=(()=>{const e=this._editor&&this._editor.getValue()||this.state.yamlContent||"";this.setState({yamlContent:e,savePanelIsOpen:!0,isYamlSaving:!1})}),this._onYamlSave=(e=>{if(this.state.definition){this.setState({isYamlSaving:!0,saveErrorMessage:""});const t=this.state.definition,s={connectionId:this.state.connection.connectionId,id:t.repository.id,sourceProviderType:t.repository.type};this.yamlFileService.commitFile(s,this.state.yamlBranch,t.process.yamlFilename,this.state.yamlContent,e,this.state.yamlFileObjectId).then(e=>{this._lastCleanContent=this.state.yamlContent;const t=this._authorizeAfterSave?this._authorizeAndRun:void 0;this.setState({isYamlDirty:!1,isYamlSaving:!1,yamlBranch:e.branch,yamlFileObjectId:e.objectId},()=>{this._dismissSavePanel(),this._updateUrl(),t&&t()})},e=>{this._handleYamlSaveError(e.message)})}}),this._dismissSavePanel=(()=>{this.state.isYamlSaving||(this._authorizeAfterSave=!1,this.setState({saveErrorMessage:"",savePanelIsOpen:!1}))}),this._showRunPanel=(()=>{this.setState({runPanelIsOpen:!0})}),this._runBuild=(()=>{this.state.definition&&(this._onRunBuild(),this._onBuildQueuing(),this.pipelineService.runPipeline(this.state.definition,this.state.yamlBranch).then(this._onBuildQueued,e=>{this._handleRunBuildError(e)}))}),this._runBuildWithParameters=(()=>{if(!this.state.definition)return;this._onRunBuild();const e=this.state.definition;this.layoutManager.renderCallout(t=>{this._onQueueDialogDismiss=t;const s={definition:e,repository:e.repository,processType:e.process.type,pageContext:this.context.pageContext,project:e.project.id,source:"yamlEditor",onSuccess:this._onBuildQueued,onClosed:this._onQueueBuildDialogClosed,variables:e.variables,queue:e.queue,defaultSourceBranch:this.state.yamlBranch,onDismiss:t};return c.createElement(W.CommandComponent,Object.assign({commandType:"ciQueueBuildComponent"},s),null)})}),this._onBuildQueued=(e=>{if(e){const t={id:e.id,number:e.buildNumber};this.setState({buildMessageInfo:t,isBuildRunning:!1},this._resizeEditor)}else this._handleRunBuildError()}),this._onQueueBuildDialogClosed=(()=>{if(this._onQueueDialogDismiss){const e=this._onQueueDialogDismiss;this._onQueueDialogDismiss=void 0,e()}this.state.isBuildRunning&&this.setState({isBuildRunning:!1})}),this._onRunPanelClosed=(()=>{this.setState({runPanelIsOpen:!1})}),this._autoAuthorizeResources=(()=>this.context.pageContext.getService("IPipelineResourcesService").autoAuthorizeResources(this.state.definition.id,this.state.yamlBranch).then(e=>{},e=>{console.warn("YAML editor: Error while auto-authorizing resources: "+e&&e.message)})),this._authorizeAndRun=(()=>{this._clearErrorMessage(),this.state.isYamlDirty?(this._authorizeAfterSave=!0,this._showSavePanel()):this._autoAuthorizeResources().then(()=>this._runBuild())}),this._showPipelineSettingsPanel=(()=>{this.setState({settingsPanelIsOpen:!0})}),this._onSavePipelineSettings=(e=>{if(!e||!Object.keys(e).length)return;let t=!1;const s=[],i=Object.assign({},this.state.definition);if(this.setState({settingsIsSaving:!0,settingsErrorMessage:""}),void 0!==e.status)switch(i.queueStatus=e.status,e.status){case 2:s.push(o.SavePipelineCommentDisable);break;case 0:s.push(o.SavePipelineCommentEnable);break;case 1:s.push(o.SavePipelineCommentPause);break;default:s.push(o.SavePipelineCommentUnknownStatus)}if(void 0!==e.yamlFilePath){t=!0;const r=Object.assign({},i.process);r.yamlFilename=e.yamlFilePath,i.process=r,s.push(l.format(o.SavePipelineCommentYamlFile,e.yamlFilePath))}i.comment=s.join(". "),this.pipelineService.savePipeline(i).then(e=>{t?this.setState({isYamlDirty:!1},()=>n.FastPageSwitch(this.context.pageContext,window.location.href,!1)):this.setState({definition:e,settingsIsSaving:!1},this._dismissPipelineSettingsPanel)},e=>{const t=e&&e.message||o.SavePipelineErrorMessage;this._handleSettingsError(t)})}),this._dismissPipelineSettingsPanel=(()=>{this.state.settingsIsSaving||this.setState({settingsPanelIsOpen:!1,settingsErrorMessage:"",settingsIsSaving:!1})}),this._handleSettingsError=(e=>{this.setState({settingsErrorMessage:e,settingsIsSaving:!1,settingsPanelIsOpen:!0})}),this._handleRunBuildError=(e=>{this.setState({isBuildRunning:!1});let t,s=e&&e.message||ee.RunBuildErrorMessage;const i=e;if(i&&i.serverError&&i.serverError.customProperties){const e=i.serverError.customProperties.ValidationResults;if(e&&e.length>0){const i="https://aka.ms/yamlauthz";(s+="\n"+e.map(e=>e.message).join("\n")).indexOf(i)>0&&(t=[{primary:!0,text:ee.AuthorizeAndRunButtonText,onClick:this._authorizeAndRun}])}}this._handleError(s,!0,t)}),this._handleError=((e,t,s)=>{this._clearBuildMessage(),this.setState({errorMessage:e,isErrorMessageDismissable:t,errorActions:s},this._resizeEditor)}),this._handleYamlSaveError=(e=>{this.setState({saveErrorMessage:e,isYamlSaving:!1,savePanelIsOpen:!0})}),this._markTimeToInteractive=(()=>{this._ttiRecorded||(this._ttiRecorded=!0,this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(se.PerformanceConstants.Area,se.PageLoadScenarios.YamlEditor))}),this._onChangeVariables=((e,t)=>{this.setState({isVariablesDirty:this._yamlResourceService.isVariablesChanged()})}),this._onBranchSelected=(e=>{e!==this.state.yamlBranch&&(this.state.isYamlDirty?this.layoutManager.renderCallout(t=>de.getLoseChangesDialog(()=>{t(),this._switchBranch(e)},()=>{t()})):this._switchBranch(e))}),this._switchBranch=(e=>{this.setState({yamlContent:"",yamlFileObjectId:"",yamlBranch:e}),this._clearErrorMessage();const t=this.historyService,s=t.generateUrl({branch:e});t.pushState(void 0,s);const i=this.state.definition,r=i.process.yamlFilename,n=i.repository,o={connectionId:n.properties&&n.properties.connectedServiceId,id:n.id,name:n.name,sourceProviderType:n.type};this.yamlFileService.getFileContentData(o,e,r).then(e=>{this._updateFileInfo(e)},t=>{this._updateFileInfo({content:"",branch:e,path:r,objectId:"",url:""}),this._handleError(t.message,!1)})}),this._onSidePanelButtonClick=(()=>{this.setState(e=>({sidePanelIsOpen:!e.sidePanelIsOpen}),()=>{const e=document.querySelector("."+te.EditorConstants.YamlAssistantToggleElement);e&&e.focus&&!e.hasAttribute("disabled")&&!e.classList.contains("disabled")&&"hidden"!==e.style.visibility&&"none"!==e.style.display&&e.focus()})});const s={isEditorReady:!1,connection:{},savePanelIsOpen:!1,runPanelIsOpen:!1,isYamlSaving:!1,yamlContent:"",yamlFileUrl:"",yamlBranch:"",yamlFileObjectId:"",isYamlDirty:!1,errorMessage:"",isErrorMessageDismissable:!1,settingsPanelIsOpen:!1,settingsIsSaving:!1,isBuildRunning:!1,sidePanelIsOpen:!0,useAppConnectionAction:void 0,authentication:{isLoginRequired:!1,shouldShowLandingPage:!1}},i=this.context.pageContext.getService("IVssContributionService"),r=i.getData("ms.vss-build-web.pipeline-editor-data-provider");if(r){if(this._lastCleanContent=r.content||"",s.definition=r.definition,s.yamlBranch=r.branch||(r.definition.repository.defaultBranch||"").replace("refs/heads/",""),s.yamlContent=r.content,s.yamlFileUrl=r.yamlFileUrl,s.yamlFileObjectId=r.objectId,s.errorMessage=r.fileErrorMessage,s.errorMessage){const e=s.definition.repository;l.equals(e.type,a.RepositoryTypes.TfsGit,!0)&&e.id&&e.name&&(s.errorMessage=s.errorMessage.replace(e.id,e.name))}if(s.authentication=r.authenticationRequirements,s.connection=r.serviceConnection||{},s.authentication.isLoginRequired){if(s.yamlBranch="",s.authentication.shouldShowLandingPage)s.errorMessage="";else{const e=ce.getSourceProviderTile(this.context.pageContext,s.definition.repository.type.toLowerCase());this._sourceProviderName=e?e.name:""}s.authentication.loginUrl||(s.errorMessage=ee.LoginUrlNotSpecified)}}else{const e=i.getDataProviderExceptions()["ms.vss-build-web.pipeline-editor-data-provider"];this._handleEditorDataProviderError(e,s)}this._yamlResourceService=t.pageContext.getService("IYamlResourcesService"),this.state=s,s.yamlBranch&&s.yamlBranch!==this.historyService.getState().branch&&this._updateUrl(),this._sidePanelEnabled=f.isFeatureFlagEnabled(this.context.pageContext,"Build2.YamlCommandBar",!1)}componentDidMount(){super.componentDidMount(),W.prefetch(this.context.pageContext),this.navigationService.setPageTitle(this._getTitle()),this.breadcrumbService.setPipeline(this.state.definition),this.state.authentication.isLoginRequired&&!this.state.authentication.shouldShowLandingPage&&this.state.authentication.loginUrl?s.openLinkSecurely(this.state.authentication.loginUrl):(this._yamlResourceService.subscribe(this._onChangeVariables),de.addNavigateAwayListener(this._onNavigateAway),this._checkForAppConnectionUpgrade())}componentWillUnmount(){super.componentWillUnmount(),this._yamlResourceService.unsubscribe(this._onChangeVariables),this.breadcrumbService.clearPipeline(),de.removeNavigateAwayListener(this._onNavigateAway),H.clearTreeStateOnUnmount(this.context.pageContext)}render(){return this.state.definition?this._shouldShowLandingPage()?this._getAuthLandingPage():this._getEditorPage():this._getEmptyPage()}_shouldShowLandingPage(){return this.state.authentication.isLoginRequired&&this.state.authentication.shouldShowLandingPage}_getEmptyPage(){return c.createElement(A.Page,{className:i},this._getHeader())}_getAuthLandingPage(){const e=this.state.definition;return c.createElement(A.Page,{className:i},this._getHeader(),c.createElement(ce.EditorAuthLandingPage,{loginUrl:this.state.authentication.loginUrl,yamlFileLink:this.state.yamlFileUrl,repository:e.repository,sourceProvider:this._getSourceProvider()}))}_getEditorPage(){const e=this.state.definition,t=e.process.yamlFilename,s=this._getFileName(t),n=s?l.format(ee.SavePanelCommitMessageForEdit,s):"",o=this._getSourceProvider(),p=!l.equals(e.repository.type,a.RepositoryTypes.Bitbucket,!0)||f.isFeatureFlagEnabled(this.context.pageContext,"Build2.BitbucketEditYamlPullRequest",!1);let d="";return this.state.authentication.isLoginRequired&&(d=this._sourceProviderName?l.format(ee.AuthorizingWithProviderMessage,this._sourceProviderName):ee.AuthorizingMessage),c.createElement(A.Page,{className:i},this._getHeader(),c.createElement(r,{content:this.state.yamlContent,editor:this._editor,spinnerMessage:d,onContentUpdated:this._onYamlContentUpdated,onEditorCreated:this._onEditorCreated,onEditorDisposing:this._onEditorDisposing,sidePanelIsOpen:this._sidePanelEnabled&&this.state.sidePanelIsOpen,onSidePanelButtonClick:this._onSidePanelButtonClick,repositoryName:e.repository.name,repositoryIconName:o.getRepoIconName(),repositoryUrl:e.repository.properties&&e.repository.properties.manageUrl,branchName:this.state.yamlBranch,fileName:t,fileUrl:this.state.yamlFileUrl,supportFPS:l.equals(e.repository.type,a.RepositoryTypes.TfsGit,!0),isYamlDirty:this.state.isYamlDirty,definition:e,onBranchSelected:this._onBranchSelected}),c.createElement(oe.SavePanel,{errorMessage:this.state.saveErrorMessage,fileName:t,commitMessage:n,defaultBranch:this.state.yamlBranch,isOpen:this.state.savePanelIsOpen,isSaving:this.state.isYamlSaving,saveAndRun:!1,canCreatePr:p,onSave:this._onYamlSave,onDismiss:this._dismissSavePanel,showCancelButton:!0}),this.state.runPanelIsOpen&&c.createElement(q.QueuePanel,{showPanel:this.state.runPanelIsOpen,pageContext:this.context.pageContext,projectId:e.project.id,definitionId:e.id,buildRepository:e.repository,sourceBranch:this.state.yamlBranch||"",runtimeVariables:this._getOverridableVariables(e.variables),onDismiss:this._onRunPanelClosed}),c.createElement(j.PipelineSettingsPanel,{key:e.revision,definition:e,branch:this.state.yamlBranch,isYamlDirty:this.state.isYamlDirty,errorMessage:this.state.settingsErrorMessage,isOpen:this.state.settingsPanelIsOpen,isSaving:this.state.settingsIsSaving,onSave:this._onSavePipelineSettings,onDismiss:this._dismissPipelineSettingsPanel,onError:e=>this.setState({settingsErrorMessage:e})}))}_getOverridableVariables(e){return Object.keys(e||{}).filter(t=>e[t].allowOverride).map(t=>({name:t,variable:Object.assign({},e[t])}))}_getFileName(e){let t=e||"";const s=t.lastIndexOf("/")+1;return s>0&&t.length>s&&(t=t.substr(s)),t}_getHeader(){const e=f.isFeatureEnabled(this.context.pageContext,"ms.vss-build-web.ci-new-landing-pages",!1),t=f.isFeatureFlagEnabled(this.context.pageContext,"Build2.NewQueuePanel",!1),s=e||t;return c.createElement(c.Fragment,null,c.createElement(pe.EditorHeader,{definition:this.state.definition,isYamlDirty:this.state.isYamlDirty,actionButtonLabel:this.state.isYamlDirty?ee.SaveButtonLabel:ee.RunButtonLabel,actionDisabled:!!this.state.errorMessage||this.state.isBuildRunning||this.state.settingsIsSaving,onActionClick:this.state.isYamlDirty?this._showSavePanel:s?this._showRunPanel:this._runBuild,onRunWithParameters:this._runBuildWithParameters,onSettingsOpen:this._showPipelineSettingsPanel,buildMessageInfo:this.state.buildMessageInfo,onBuildMessageDismissed:this._clearBuildMessage,errorMessage:this.state.errorMessage,errorActions:this.state.errorActions,onErrorMessageDismissed:this.state.isErrorMessageDismissable?this._clearErrorMessage:void 0,title:this._getTitle()}),this._getAppUpgradeHeader())}_getAppUpgradeHeader(){return f.isFeatureFlagEnabled(this.context.pageContext,"Build2.SwitchToAppConnection",!1)&&this.state.useAppConnectionAction?c.createElement("div",{className:"page-content flex-row flex-noshrink"},c.createElement(_.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this._closeConnectionCard,buttonProps:[this.state.useAppConnectionAction]},c.createElement(F.FormatComponent,{format:this.state.useAppConnectionDescription},c.createElement(B.FPSLink,{href:this.state.connection.appHelpLink},this.state.connection.appName)))):c.createElement(c.Fragment,null)}async _checkForAppConnectionUpgrade(){if(f.isFeatureFlagEnabled(this.context.pageContext,"Build2.SwitchToAppConnection",!1)&&!this._shouldShowLandingPage()&&!this.state.connection.isAppConnection&&this.state.connection.appName)try{const e=this.state.definition,t=this.state.connection.nonce,s=await this._getRecommendedServiceConnection(e,t),i=s.commonConnectionId;if(i)if(this.state.connection.autoUpgradeToAppConnection)this._switchToAppConnection(i);else{const e={text:ee.ChangeToAppConnection,onClick:()=>this._switchToAppConnection(i)};this.setState({useAppConnectionAction:e,useAppConnectionDescription:ee.PreferAppConnectionChange})}else if(!s.appInstalledForRepository&&s.userCanInstall){const i={text:ee.InstallApp,onClick:()=>this._installApp(e.id,t,s.installAppUrlRoot,e.repository)};this.setState({useAppConnectionAction:i,useAppConnectionDescription:ee.PreferAppConnectionInstall})}}catch(e){this._handleError(e&&e.message,!1)}}_getRecommendedServiceConnection(e,t){const s=this.context.pageContext.getService("IVssContributionService"),i="ms.vss-build-web.app-serviceconnections-recommendation-data-provider",r={sourceProvider:this._getSourceProvider().getKey(),repositoryId:e.repository.id,repositoryName:e.repository.name,connectionId:this.state.connection.connectionId,strongBoxKey:"useWellKnownStrongBoxLocation",createOAuthConnectionIfNeeded:!1,login:this.state.connection.login};return s.getDataAsync(i,r,!0).then(e=>{if(!e){const e=s.getDataProviderExceptions()[i];throw new Error(e&&e.message)}return e})}_getSourceProvider(){const e=this.context.pageContext.getService("ISourceProviderService");return this.state.definition&&e.getSourceProvider(this.state.definition.repository.type)}_getTitle(){return this.state.definition&&this.state.definition.name||ee.EditorDefaultTitle}_updateUrl(){const e=this.historyService,t=e.generateUrl({branch:this.state.yamlBranch});e.replaceState(void 0,t)}_onRunBuild(){this.setState({isBuildRunning:!0}),this._clearErrorMessage(),this._clearBuildMessage()}_onBuildQueuing(){this.setState({buildMessageInfo:{id:-1,number:"",isQueuing:!0}},this._resizeEditor)}_handleEditorDataProviderError(e,t){let s,i=l.format(ee.EditorPipelineFetchError,e&&e.message||"");if(e&&"ServiceEndpointNotFoundException"===e.exceptionType){const t=Number(this.historyService.getState().pipelineId);if(t>0){i=l.format(ee.EditorServiceConnectionError,e.message);const r=this.buildLinkingService.getDefinitionEditUrl(t,te.LegacyDesignerTabKeys.Yaml);s=[{text:ee.EditInOldDesigner,href:r}]}}t.errorMessage=i,t.errorActions=s}_updateFileInfo(e){this._lastCleanContent=e.content,this.setState({isYamlDirty:!1,isYamlSaving:!1,yamlBranch:e.branch,yamlFileObjectId:e.objectId,yamlContent:e.content,yamlFileUrl:e.url})}get breadcrumbService(){return this.context.pageContext.getService("pipeline-editor-breadcrumb-service")}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}get historyService(){return this.context.pageContext.getService("IVssHistoryService")}get layoutManager(){return this.context.pageContext.getService("IVssLayoutManager")}get navigationService(){return this.context.pageContext.getService("ITfsNavigationService")}get pipelineService(){return this.context.pageContext.getService("IPipelineService")}get yamlFileService(){return this.context.pageContext.getService("IYamlFileService")}})}(),function(e){t.RepositorySelector={},Object.defineProperty(t,"__esModule",{value:!0});function s(e){const t=t=>e&&e[t];return{isFork:t("isFork"),isPrivate:t("isPrivate"),externalOwnerId:t("ownerId"),externalOwnerName:t("orgName"),externalOwnerIsAUser:t("ownerIsAUser"),repositoryUrl:t("manageUrl"),safeRepository:t("safeRepository"),hasAdminPermissions:t("hasAdminPermissions")}}function i(e,t){const s=e&&e.properties&&e.properties[t];return!(!s||"true"!==s.toLowerCase())}t.RepositorySelector.RepositorySelector=class extends S.VssComponent{constructor(e,t){super(e,t),this._filterBarRef=c.createRef(),this._ttiMarked=!1,this.getDescriptionMessage=(()=>this.state&&this.state.repositoryList&&this.state.repositoryList.continuationToken?ee.RepositorySelectorFetchingRepositories:""),this.renderProgressIndicator=(()=>c.createElement(c.Fragment,null,c.createElement(y.ProgressIndicator,{className:"progress",progressHidden:!this.state.repositoryList,percentComplete:this._getPercentageOfRepositoriesLoaded()}),c.createElement("div",{className:"subheader"},this.getDescriptionMessage()))),this.renderRepositoryList=(()=>{const e=this._getFilteredRepositories();return c.createElement(re.WizardList,{wizardListItems:this._mapToWizardListItems(e),onClick:(t,i)=>{const r=e[i.index];this._onRepoSelected(r,s(r.properties))}})}),this._mapToWizardListItems=(e=>(e||[]).map(e=>{const t=[];i(e,"isFork")&&t.push(ee.RepositorySelectorTagFork),i(e,"isPrivate")&&t.push(ee.RepositorySelectorTagPrivate);const s=e.properties&&e.properties.lastUpdated&&new Date(e.properties.lastUpdated);return{name:e.fullName,iconUrl:this.getRepositoryIconUrl(e),iconName:this.getRepositoryIconName(),iconClass:S.css("rounded-corners",this.getRepositoryIconClass()),labels:t,isFavorite:i(e,"isFavorite"),renderDescription:()=>s?c.createElement(Q.Ago,{className:"body-s secondary-text",date:s,format:0}):c.createElement(c.Fragment,null)}})),this._onFilterChanged=((e,t)=>{if(e.hasOwnProperty("filterText")){const t=e.filterText&&e.filterText.value||"",s=this._filterNoReposFound(this.state.repositories||[],t);this.setState({filterText:t,filterNoReposFound:s,footerText:this.getFooter(s,!(!this.state.repositoryList||!this.state.repositoryList.continuationToken))},()=>this.props.onRepositoryListUpdate("ReposFilter",{repoCount:this._getFilteredRepositories().length,filterText:t}))}if(e.hasOwnProperty("filterType")&&e.filterType&&e.filterType.value){const t=e.filterType&&e.filterType.value&&e.filterType.value[0];t&&t.key!==this.state.resultSet&&this.setState({resultSet:t.key,footerText:void 0},()=>{this._fetchRepositories()})}}),this._getFilterItems=(()=>this.state.filterTypes||this.getFilterItems()),this._getFilterItem=(e=>({name:e.displayName,key:e.key})),this._onRepositoryListReceived=((e,t)=>{if(this._mounted&&t===this.state.resultSet&&e){if(e.repositories&&this.props.autoSelectRepositoryId){const t=e.repositories.find(e=>e.id===this.props.autoSelectRepositoryId);if(t)return this.props.onSelectRepository(t,s(t.properties)),void this._markTTI()}const i={};let r=(this.state.repositories||[]).concat(e.repositories),n=void 0;if(e.continuationToken)this.listRepositories(this.state.projectId,this.props.sourceProvider,this.props.connectionId,this.state.resultSet,!0,e.continuationToken).then(e=>this._onRepositoryListReceived(e,t));else{this._updateFilterDropdown(t)&&(i.filterTypes=e.resultSets||this.getFilterItems(),i.filterTypes&&i.filterTypes.length>0&&(n=(()=>{const t=e.currentResults&&e.currentResults.key,s=i.filterTypes.find(e=>e.key===t)||this.state.resultSet,r={value:s&&[s]};this._filter.setDefaultState({filterType:r}),this._filter.setFilterItemState("filterType",r)}))),r=r.sort(this.compareRepositories);const s=this._filterNoReposFound(r,this.state.filterText||"");i.filterNoReposFound=s,i.footerText=this.getFooter(s,!1),this.props.onRepositoryListUpdate("ReposLoaded",{resultSet:t&&t.toString(),repoCount:r.length,duration:this._timer?(new Date).getTime()-this._timer.getTime():-1})}i.repositoryList=e,i.repositories=r,i.countRequests=this.state.countRequests+1,this.setState(i,n),this._markTTI()}}),this._onRepoSelected=((e,t)=>{this.props.onSelectRepository(e,t)}),this._getPercentageOfRepositoriesLoaded=(()=>{if(this.state&&this.state.repositoryList)return this.state.countRequests/this.state.repositoryList.totalPageCount}),this._getFilteredRepositories=(()=>this.state&&this.state.repositories?this.state.filterText?this._filterRepositories(this.state.repositories,this.state.filterText):this.state.repositories:[]),this._markTTI=(()=>{this.props.onTTI&&!this._ttiMarked&&(this._ttiMarked=!0,this.props.onTTI())}),this._client=this.context.pageContext.getRestClient("IBuildRestClient");const r=this.context.pageContext.getService("ITfsPageService").getData();this.state={projectId:r.project.id,projectName:r.project.name,countRequests:0,filterText:void 0,footerText:void 0,filterNoReposFound:!1,repositories:void 0,repositoryList:void 0,resultSet:1};const n=this.getFilterItems()[0];this._filter=new $.Filter({defaultState:{filterType:{value:n?[n]:void 0}}}),this._filter.subscribe(this._onFilterChanged,$.FILTER_CHANGE_EVENT)}render(){return c.createElement("div",{className:this.getClassName("repository-selection")},c.createElement("div",{className:"header-section"},c.createElement("div",{className:"subheader body-m secondary-text"},ee.NewPipeline),c.createElement("div",{className:"header title-l"},ee.RepositorySelectorTitle)),c.createElement(J.FilterBar,{filter:this._filter,ref:this._filterBarRef},c.createElement(X.KeywordFilterBarItem,{filterItemKey:"filterText",placeholder:ee.RepositorySelectorFilterPlaceholder,throttleWait:400}),this._showFilterDropdown()&&c.createElement(Z.PickListFilterBarItem,{filterItemKey:"filterType",getListItem:this._getFilterItem,getPickListItems:this._getFilterItems,selectionMode:K.SelectionMode.single})),this.state&&!this.state.repositoryList||this.state&&this.state.repositoryList&&this.state.repositoryList.continuationToken?this.renderProgressIndicator():this.renderRepositoryList(),this.state.footerText&&c.createElement("div",{className:"repository-picker-footer flex-row flex-start"},c.createElement("div",{className:"flex-self-start"},c.createElement(p.Icon,{iconName:"Error",className:"repository-picker-footer-icon"})),c.createElement("div",{className:"repository-picker-footer-text flex-grow scroll-hidden"},this.state.footerText)))}componentDidMount(){this._mounted=!0,this._fetchRepositories()}componentWillUnmount(){this._mounted=!1}getClassName(e){return e}getFilterItems(){return[]}getFooter(e,t){if(e){const e=this.getFooterLink();return c.createElement(c.Fragment,null,c.createElement("span",null,ee.RepositorySelectorNoneFoundDescription," "),e&&c.createElement(F.FormatComponent,{format:ee.RepositorySelectorProvideAccessDescription},c.createElement(G.Link,{href:e},ee.RepositorySelectorProvideAccessDescriptionLink)))}}getFooterLink(){}getRepositoryIconUrl(e){return e&&e.properties&&e.properties.ownerAvatarUrl}getRepositoryIconName(){return"GitLogo"}getRepositoryIconClass(){}compareRepositories(e,t){const s=Date.parse(e.properties.lastUpdated),i=Date.parse(t.properties.lastUpdated)-s;return isNaN(i)?0:i}getRepositories(e,t,s,i,r){throw new Error("getRepositories() not implemented")}checkIsMounted(){return this._mounted}autoSelectConnection(){return!0}_showFilterDropdown(){return this.getFilterItems().length>0||this.state.filterTypes&&this.state.filterTypes.length>0}_updateFilterDropdown(e){return this.autoSelectConnection()&&void 0!==e&&!this.isCustomResultSetFilter(e)}_fetchRepositories(){this._timer=new Date,this.setState({countRequests:0,footerText:void 0,repositories:void 0,resultSet:this.state.resultSet});const e=this.state.resultSet;this.listRepositories(this.state.projectId,this.props.sourceProvider,this.props.connectionId,e,!0).then(t=>{this._onRepositoryListReceived(t,e)},e=>{this.props.onErrorMessage(ee.InvalidServiceConnection),this.setState({footerText:this.getFooter(!0,!1)})})}listRepositories(e,t,s,i,r,n){return this.autoSelectConnection()||void 0!==i&&this.isCustomResultSetFilter(i)?this.getRepositories(s,void 0,i,r,n):this._client.listRepositories(e,t,s,void 0,i,r,n)}isCustomResultSetFilter(e){return"string"==typeof e}_filterRepositories(e,t){if(e){const s=t.trim().toLowerCase();return e.filter(e=>-1!==e.fullName.toLowerCase().indexOf(s))}return e}_filterNoReposFound(e,t){return 0===this._filterRepositories(e,t).length}}}()},["Resources","Constants","InstallAppService","Performance","PipelineEditorBreadcrumbService","PipelineService","YamlFileService","YamlResourcesService","Components/FileList","WizardList","TemplateSelector","SavePanel","YamlEditor","YamlWizardPage","Wizard","EditorAuthLandingPage","EditorHeader","LoseChangesDialog","YamlSidePanel","Editor","RepositorySelector"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.designer"}}));