"use strict";define("Favorites/Picker",["require","exports","react","VSSUI/Utilities/Event","VSSUI/PickList","VSSUI/ItemIndicator","VSS/Platform/FPS","Favorites/Common/Resources"],function(t,e,i,s,o,r,a,n){!function(t){e.ArtifactPickerProvider={},Object.defineProperty(e,"__esModule",{value:!0});class c{constructor(t){this._artifactsById={},this._disposed=!1,this._builtInGroups=[],this._favoritesByArtifactId={},this._favoriteGroupItems={},this._favoriteIndicatorItems={},this._extendedFavoritesLoaded=!1,this.getItems=(()=>{if(!this._artifactsPromise){this._artifactsPromise=this._options.getArtifacts();const t=t=>{this._resolvedArtifacts=this.processResolvedArtifacts(t),this._defaultGroup.isLoading=!1,s.EventGroup.raise(this,o.PICKER_CHANGE_EVENT)};h(this._artifactsPromise)?this._artifactsPromise.then(t):t(this._artifactsPromise)}if(!this._options.favoritesContext)return this._resolvedArtifacts||[];if(this._loadFavoriteExtendedData(),!this._favoritesCollection)return[];const t=this._favoritesCollection.value.filter(t=>!t.artifactIsDeleted);if(this._favoritesByArtifactId={},this._favoriteGroupItems={},!t.length)return this._resolvedArtifacts||[];for(const e of t)this._favoritesByArtifactId[e.artifactId]=e,this._favoriteGroupItems[e.artifactId]=!0;let e=[];if(this._resolvedArtifacts){for(const i of t){let t=this._artifactsById[i.artifactId];!t&&this._options.getArtifactFromFavorite&&(t=this._options.getArtifactFromFavorite(i)),t&&e.push(t)}for(const t of this._resolvedArtifacts){const i=this._options.getArtifactId(t);this._favoritesByArtifactId[i]||e.push(t)}this._options.artifactComparer&&(e=e.sort(this._options.artifactComparer))}else if(this._options.getArtifactFromFavorite){for(const i of t){const t=this._options.getArtifactFromFavorite(i);t&&e.push(t)}this._options.artifactComparer&&(e=e.sort(this._options.artifactComparer))}return e}),this.forgetCachedArtifacts=(()=>{this._artifactsPromise=void 0,this._artifactsById={},this._resolvedArtifacts=void 0}),this.onGroupLoadRequest=((t,e=0)=>{if("favorites"===t||"default"===t)return Promise.resolve([]);const i=this._options.getArtifacts(t),r=i=>{const r=this._resolvedArtifacts&&this._resolvedArtifacts.length;return this._resolvedArtifacts=this.processResolvedArtifacts(i),i.length>e&&this._resolvedArtifacts.length===r&&this.groups.some(e=>e.name===t&&Boolean(e.isLoading))?this.onGroupLoadRequest(t,i.length):(s.EventGroup.raise(this,o.PICKER_CHANGE_EVENT),this._resolvedArtifacts)};return h(i)?i.then(r):Promise.resolve(r(i))}),this.getListItem=(t=>{const{getArtifactName:e,getArtifactId:i,getArtifactListGroupId:s,getArtifactHref:o,getArtifactIcon:r}=this._options,a={artifact:t,name:e(t),key:i(t)};return this._getFavoriteItem(i(t))?a.groupKey="favorites":s&&(a.groupKey=s(t)),a.groupKey||(a.groupKey="default"),r&&(a.iconProps=r(t)),o&&(a.href=o(t)),a}),this.onSelectedItemChanged=(t=>{this.setSelectedItem(t);const{onArtifactClicked:e,getArtifactHref:i}=this._options;return e?e(t):i?a.onClickFPS(this._options.pageContext,i(t),!0,void 0,{telemetrySource:"ArtifactPickerProvider"}):void 0}),this.onHasMoreSearchResults=(t=>t===this._lastSearchResults&&Boolean(this._lastSearchResultsContinuationToken)),this._favoritesErrorDelegate=(t=>{this._options.onFavoriteLoadError&&this._options.onFavoriteLoadError(t)}),this._onFavoritesLoaded=(t=>{if(!this._disposed){if(this._favoritesCollection&&this._favoritesCollection!==this._options.favoritesContext.favorites&&this._favoritesCollection.dispose(),this._favoritesCollection=t,this._favoriteGroup.isLoading=!1,t.subscribe(this._onFavoriteItemChanged),this.selectedItem){const t=this._options.getArtifactId(this.selectedItem);this._updateIndicatorItem(t,!!this._getFavoriteItem(t),!1)}return s.EventGroup.raise(this,o.PICKER_CHANGE_EVENT),t}t.dispose()}),this._onFavoriteItemChanged=((t,e)=>{if(t.addedItems)for(const e of t.addedItems)this._favoritesByArtifactId[e.artifactId]=e,this._updateIndicatorItem(e.artifactId,!0,!1);if(t.removedItems)for(const e of t.removedItems)delete this._favoritesByArtifactId[e.artifactId],this._updateIndicatorItem(e.artifactId,!1,!1)}),t&&this.initialize(t)}initialize(t){this._options=t,this.initializeDefaultGroup(),t.getSearchResults&&(this.onSearch=((e,i,s,o)=>{const r=o&&o===this._lastSearchResults&&this._lastSearchResultsContinuationToken||void 0,a=t.getSearchResults(e,s,r),n=t=>this.getUniqueSearchResults(t,Boolean(r));return h(a)?a.then(n):n(a)}));const e=t.favoritesContext;this._favoritesService=t.favoritesService||t.pageContext.getService("IFavoritesService"),e&&this._favoritesService.canUseFavorites()&&(this.initializeFavoriteGroup(),e.favorites?this._onFavoritesLoaded(e.favorites):this._options.hideFavoriteSelectedItemIndicator||this._loadFavorites(),this._favoriteIndicator={getItemIndicator:e=>{const i=t.getArtifactId(e);if(!i)return null;const s=this._getFavoriteItem(i);return s||this._options.getFavoriteFromArtifact&&this._options.getFavoriteFromArtifact(e)?{title:"",item:this._updateIndicatorItem(i,!!s,!0),onClick:(t,s)=>{let o=!1,r=this._getFavoriteItem(i);if(r)o=!0;else if(!(r=this._options.getFavoriteFromArtifact(e)))return;o?this._favoritesService.removeFavorite(r):this._favoritesService.addFavorite(r)}}:null}})}dispose(){this._favoritesCollection&&(this._options.favoritesContext.favorites===this._favoritesCollection&&this._favoritesCollection.dispose(),this._favoritesCollection=void 0),this._disposed=!0}getTitleTextForItem(t){return this._options.getRootItemText?this._options.getRootItemText(t):t&&this._options.getArtifactName(t)}processResolvedArtifacts(t){for(const e of t)this._artifactsById[this._options.getArtifactId(e)]=e;let e=Object.keys(this._artifactsById).map(t=>this._artifactsById[t]);return this._options.artifactComparer&&(e=e.sort(this._options.artifactComparer)),e}get selectedItem(){return this._handledInitialSelection||(this._handledInitialSelection=!0,this._selectedItem=this._options.selectedArtifact),this._selectedItem}setSelectedItem(t){if(this._selectedItem=t,t){const e=this._options.getArtifactId(t);this._updateIndicatorItem(e,!!this._getFavoriteItem(e),!0)}}get selectedItemIndicators(){return this._favoriteIndicator&&!this._options.hideFavoriteSelectedItemIndicator?this._options.selectedItemIndicators?[...this._options.selectedItemIndicators,this._favoriteIndicator]:[this._favoriteIndicator]:this._options.selectedItemIndicators||[]}get dropdownIndicators(){return this._favoriteIndicator?this._options.dropdownIndicators?[...this._options.dropdownIndicators,this._favoriteIndicator]:[this._favoriteIndicator]:this._options.dropdownIndicators||[]}get groups(){let t;return this._options.groups&&h(this._options.groups)?(this._resolvedGroups||(this._options.groups.then(t=>{this._resolvedGroups=t,s.EventGroup.raise(this,o.PICKER_CHANGE_EVENT)}),this._resolvedGroups=this._getPlaceholderGroups()),t=this._resolvedGroups):t=this._options.groups,[...this._builtInGroups.map(t=>Object.assign({},t)),...t||[]]}_getPlaceholderGroups(){const t=[];if(this.pivots)for(const e of this.pivots)t.push({key:"placeholder",isLoading:!0,loadingMessage:this._options.loadingText,pivotId:e.id});else t.push({key:"placeholder",isLoading:!0,loadingMessage:this._options.loadingText});return t}get pivots(){return this._options.pivots||[]}get limitSearchToPivot(){return this._options.limitSearchToPivot||!1}get onFilterItemByText(){return this._options.onFilterItemByText}get actions(){const{browseAllText:t,onBrowseAllClick:e,otherActions:i}=this._options,s=i?[...i]:[];return e&&s.push({onClick:e,name:t||n.FavoriteItemPickerBrowseAllText,iconProps:{iconName:"Home"}}),s}get isSearchable(){return void 0===this._options.isSearchable||this._options.isSearchable}get searchTextPlaceholder(){return this._options.searchTextPlaceholder}get searchResultsGroupName(){return this._options.searchResultsGroupName}get searchResultsLoadingText(){return this._options.searchResultsLoadingText}get searchNoResultsText(){return this._options.searchNoResultsText}get noItemsText(){if(this._favoritesService&&!this._favoritesCollection)return i.createElement("span",{className:"vss-FavoriteItemPicker--noItemsMessage"},n.FavoriteItemPickerLoadingMessage);{let t=void 0;return"function"==typeof this._options.getNoItemsMessage&&(t=this._options.getNoItemsMessage()),t}}get itemAriaDescription(){return n.FavoriteItemPickerAriaDescription}getUniqueSearchResults(t,e){const i=e?this._lastSearchResults:[];for(const e of t||[]){const t=this._options.getArtifactId(e);this._artifactsById[t]||this._favoritesByArtifactId[t]||i.push(e)}return this._lastSearchResults=i,this._lastSearchResultsContinuationToken=t&&this._options.getSearchResultsContinuationToken&&this._options.getSearchResultsContinuationToken(t),i}initializeDefaultGroup(){const t={key:"default",name:this._options.defaultGroupHeader,isLoading:!0,loadingMessage:this._options.loadingText,pivotId:this._options.defaultGroupPivotId},e=this._tryGetGroupSynchronously("default");e?this._defaultGroup=e:(this._defaultGroup=t,this._builtInGroups.push(t))}initializeFavoriteGroup(){const t={key:"favorites",name:this._options.favoriteGroupHeader,isLoading:!0,loadingMessage:this._options.loadingText,pivotId:this._options.favoriteGroupPivotId},e=this._tryGetGroupSynchronously("favorites");e?this._favoriteGroup=e:(this._favoriteGroup=t,this._builtInGroups.unshift(t))}_tryGetGroupSynchronously(t){const{groups:e}=this._options;if(e&&!h(e))return e.filter(e=>e.key===t)[0]}_getFavoriteItem(t){const e=this._favoritesByArtifactId[t];return e||!this._favoritesCollection||this._artifactsPromise?e:this._favoritesCollection.value.filter(e=>e.artifactId===t)[0]}_updateIndicatorItem(t,e,i){const s=this._favoriteIndicatorItems,o=this._getIndicatorState(e,!!this._favoriteGroupItems[t]);return t in s?s[t].setState(o,i):s[t]=new r.Item({initialState:o}),s[t]}_getIndicatorState(t,e){return{title:"",iconProps:{iconName:t?"FavoriteStarFill":"FavoriteStar",className:"vss-FavoriteItemPicker--starIcon ms-font-l"+(e||t?"":" not-initial-favorite"),title:t?n.FavoriteStarFavoritedTitle:n.FavoriteStarUnfavoritedTitle}}}_loadFavoriteExtendedData(){this._loadFavorites(!0)}_loadFavorites(t=!1){if(this._extendedFavoritesLoaded)return Promise.resolve(void 0);const e=this._options.favoritesContext,i=this._favoritesService.getFavorites(e.artifactType,e.artifactScope.type,e.artifactScope.id,t).then(this._onFavoritesLoaded,this._favoritesErrorDelegate);return this._extendedFavoritesLoaded=t,i}}e.ArtifactPickerProvider.ArtifactPickerProviderBase=c;function h(t){return"function"==typeof t.then}e.ArtifactPickerProvider.ArtifactPickerProvider=class extends c{constructor(t){super(t)}}}()},["ArtifactPickerProvider"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-favorites.favorites-picker"}}));