"use strict";define("TFS/GlobalBanner",["require","exports","react","VSS/Platform/Components/Format","VSS/Platform/Layout","VSSUI/Link","VSS/Features/PlatformUI/FPSLink","VSSUI/Icon","VSSUI/TooltipEx","VSS/Platform/Context","VSS/Platform/Fetch"],function(e,s,t,n,o,a,i,r,l,c,g){var m,p,u,d;m=s.Resources={},Object.defineProperty(s,"__esModule",{value:!0}),s.Resources.Dismiss="Dismiss",s.Resources.LearnMore="Learn more",function(e){p=s.ComponentsGlobalDialog={},Object.defineProperty(s,"__esModule",{value:!0});class i extends o.VssComponent{constructor(e,s){super(e,s),this.onCornerDialogClose=(()=>{this.globalMessageService.closeDialog()}),this.onDialogChanged=(e=>{this.setState({dialog:e})}),this.globalMessageService=s.pageContext.getService("IGlobalMessagesService");const t=this.globalMessageService.getDialog();this.state={dialog:t}}componentDidMount(){this.globalMessageService.subscribe(this.onDialogChanged,"DIALOG_CHANGED")}render(){const{dialog:e}=this.state;if(!e)return null;const s=e.buttonProps||[];return e.closeButtonProps&&s.push(Object.assign({},e.closeButtonProps,{onClick:this.onCornerDialogClose})),e.componentType?t.createElement(o.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onCornerDialogClose},e.contentProperties))):t.createElement(o.WrappedComponent,{wrappedType:"cornerDialog",dependencies:["ms.vss-features.ui-layer-content"],onDismiss:this.onCornerDialogClose,footerButtonProps:s.length>0?s:void 0,titleProps:{text:e.title}},e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?t.createElement(n.FormatComponent,{className:"message",format:e.messageFormat},e.messageLinks.map((e,s)=>t.createElement(a.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:s},e.name))):t.createElement("div",{className:"message"},e.message):null)}componentWillUnmount(){this.globalMessageService.unsubscribe(this.onDialogChanged,"DIALOG_CHANGED"),super.componentWillUnmount()}}i.componentType="globalDialog",s.ComponentsGlobalDialog.GlobalDialogComponent=i,o.VssComponent.register(i.componentType,i)}(),function(e){u=s.ComponentsGlobalMessageBanner={},Object.defineProperty(s,"__esModule",{value:!0});class c extends o.VssComponent{constructor(e,s){super(e,s),this.onKeyDown=(e=>{13!==e.keyCode&&32!==e.keyCode||(this.onMessageBannerClose(),e.preventDefault())}),this.onMessageBannerClose=(()=>{this.globalMessagesService.closeBanner()}),this.onMessageBannerChanged=(e=>{this.setState({messageBanner:e})}),this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.globalMessagesService.subscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED");const t=this.globalMessagesService.getBanner();this.state={messageBanner:t}}render(){const{messageBanner:e}=this.state;if(!e)return null;const{level:s}=e;let c="info-message",g="Info";return 3===s?(c="success-message",g="Completed"):2===s?(c="error-message",g="Error"):1===s&&(c="warning-message",g="Warning"),e.customIcon&&(g=e.customIcon),t.createElement("div",{className:"global-message-banner flex-row flex-grow font-size-m "+c},r.Icon({className:"level-icon",iconName:g}),e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?t.createElement(n.FormatComponent,{className:"message",format:e.messageFormat},e.messageLinks.map((e,s)=>e.supportsFPS?t.createElement(i.FPSLink,{href:e.href},e.name):t.createElement(a.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:s},e.name))):t.createElement("div",{className:"message"},e.message):null,e._links&&e._links.learn?t.createElement(a.Link,{className:"learn-link",href:e._links.learn.href},m.LearnMore):null,e.componentType?t.createElement(o.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onMessageBannerClose},e.contentProperties))):null,!1!==e.dismissable?t.createElement(l.Tooltip,{showOnFocus:!0,text:m.Dismiss},t.createElement("span",{"aria-label":m.Dismiss,className:"inline-flex-row dismiss",onClick:this.onMessageBannerClose,onKeyDown:this.onKeyDown,role:"button",tabIndex:0},r.Icon({iconName:"Cancel"}))):null)}componentWillUnmount(){this.globalMessagesService.unsubscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED"),super.componentWillUnmount()}}c.componentType="globalBanner",s.ComponentsGlobalMessageBanner.GlobalBannerComponent=c,o.VssComponent.register(c.componentType,c);class g extends o.VssComponent{constructor(e,s){if(super(e,s),this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.layoutManager=s.pageContext.getService("IVssLayoutManager"),this.actions=this.globalMessagesService.getActions(),this.actions&&this.actions.length)for(const e of this.actions)this.layoutManager.renderCallout(s=>t.createElement(o.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onClose:s},e.contentProperties))))}render(){return null}}g.componentType="globalActions",o.VssComponent.register(g.componentType,g)}(),function(e){d=s.ComponentsGlobalToast={},Object.defineProperty(s,"__esModule",{value:!0});class n extends o.VssComponent{constructor(e,s){super(e,s),this.toastRef=t.createRef(),this.toastQueue=[],this.toastExpiresTimeoutId=-1,this.keyId=0,this.onNewToast=(e=>{e.forceOverrideExisting?this.fadeOutAndRenderNew(e):this.state.toast?this.toastQueue.push(e):this.updateCurrentToast(e)}),this.onToastExpires=(()=>{const e=this.toastQueue.shift();e?this.fadeOutAndRenderNew(e):this.clearToast()}),this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.state={}}render(){const{toast:e}=this.state;return e?t.createElement(o.WrappedComponent,Object.assign({wrappedType:"toast",dependencies:["ms.vss-features.ui-layer-content"],key:"globalToast"+this.keyId,wrappedRef:this.toastRef},e)):null}componentDidMount(){this.globalMessagesService.subscribe(this.onNewToast,"TOAST_CHANGED")}componentWillUnmount(){this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),clearTimeout(this.toastExpiresTimeoutId),this.globalMessagesService.unsubscribe(this.onNewToast,"TOAST_CHANGED")}fadeOutAndRenderNew(e){this.toastRef.current?(this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then(()=>{this.updateCurrentToast(e)}).catch(e=>{if(!e.isCanceled)throw e})):this.updateCurrentToast(e)}updateCurrentToast(e){this.keyId+=1,clearTimeout(this.toastExpiresTimeoutId),this.setState({toast:e},()=>{this.toastExpiresTimeoutId=setTimeout(this.onToastExpires,e.duration)})}clearToast(){this.toastRef.current&&(this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then(()=>{this.setState({toast:void 0})}).catch(e=>{if(!e.isCanceled)throw e}))}}n.componentType="globalToast",s.ComponentsGlobalToast.GlobalToastComponent=n,o.VssComponent.register(n.componentType,n)}(),function(e){s.ComponentsGlobalMessages={},Object.defineProperty(s,"__esModule",{value:!0});class n extends o.VssComponent{render(){return t.createElement(t.Fragment,null,t.createElement(u.GlobalBannerComponent,null),t.createElement(p.GlobalDialogComponent,null),t.createElement(d.GlobalToastComponent,null))}}n.componentType="globalMessages",o.VssComponent.register(n.componentType,n)}(),function(e){s.GlobalMessagesService={},Object.defineProperty(s,"__esModule",{value:!0});const t="globalDialogData",n="GlobalDialog/Dismissed/",o="globalMessageData",a="GlobalMessage/Dismissed/";c.Services.add("IGlobalMessagesService",{serviceFactory:class extends c.VssObservableService{constructor(){super(...arguments),this.handleEndRequest=(e=>{if(e.response&&e.response.headers){const s=e.response.headers.get("X-VSS-GlobalMessage");if(s)try{const e=JSON.parse(s);this.addBanner(e,!1,!0)}catch(e){console.warn("Failed to deserialize X-VSS-GlobalMessage header: "+e)}}}),this.handleLegacyGlobalMessage=(e=>{this.addBanner(e.detail,!1,!0)})}_serviceStart(e){super._serviceStart(e);const s=this.pageContext.getService("IVssContributionService"),n=s.getSharedData(o);this.currentMessageBanners=n&&n.banners?n.banners:[];const a=s.getSharedData(t);this.currentDialogs=a&&a.dialogs?a.dialogs:[],g.requestListeners.subscribe(this.handleEndRequest,"afterRequest"),document.body.addEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}_serviceEnd(e){g.requestListeners.unsubscribe(this.handleEndRequest,"afterRequest"),document.body.removeEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}addToast(e){this._notify(e,"TOAST_CHANGED")}getDialog(){return this.currentDialogs[0]}addDialog(e,s,t){if(t){const s=this.currentDialogs[0];if(s&&(s.priority||0)>=(e.priority||0))return}s&&this.currentDialogs.shift(),this.currentDialogs.unshift(e),this._notify(e,"DIALOG_CHANGED")}closeDialog(){const e=this.getDialog();if(e&&e.settingId){const s={};s[n+e.settingId]=!0,this.pageContext.getRestClient("ISettingsRestClient").setEntries(s,"me")}this.currentDialogs.shift(),this._notify(this.currentDialogs[0],"DIALOG_CHANGED")}getBanner(){return this.currentMessageBanners[0]}addBanner(e,s,t){if(t){const s=this.currentMessageBanners[0];if(s&&(s.level||0)>=(e.level||0))return}s&&this.currentMessageBanners.shift(),this.currentMessageBanners.unshift(e),this._notify(e,"MESSAGE_CHANGED")}getActions(){const e=this.pageContext.getService("IVssContributionService").getSharedData(o);return e&&e.actions?e.actions:void 0}closeBanner(){const e=this.getBanner();if(e&&e.settingId){const s={};s[a+e.settingId]=!0,this.pageContext.getRestClient("ISettingsRestClient").setEntries(s,"me")}this.currentMessageBanners.shift(),this._notify(this.currentMessageBanners[0],"MESSAGE_CHANGED")}}});c.Services.add("ms.vss-tfs-web.tfs-global-messages-service",{serviceFactory:class extends c.VssService{addBanner(e){this.pageContext.getService("IGlobalMessagesService").addBanner(e)}addToast(e){const s=this.pageContext.getService("IGlobalMessagesService"),t=Object.assign({},e,{onCallToActionClick:()=>{e.onCallToActionClick&&e.onCallToActionClick()}});s.addToast(t)}setGlobalMessageBanner(e){this.addBanner(e)}},options:1})}()},["Resources","Components/GlobalDialog","Components/GlobalMessageBanner","Components/GlobalToast","Components/GlobalMessages","GlobalMessagesService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.global-banner-content"}}));