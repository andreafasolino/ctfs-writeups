"use strict";define("DistributedTask/Common/AadAuthorizer",["require","exports","DistributedTask/Client/RestClient/TaskAgent","VSS/Platform/Feature"],function(e,t,o,i){var n,s;n=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.CancelButtonText="Cancel",t.Resources.CouldNotAuthenticateAAD="Could not authenticate to Azure Active Directory. If a popup blocker is enabled in the browser, disable it and try again.",t.Resources.EnvironmentSecurity="Environment security",t.Resources.NoPermissionsToManageSecurity="You do not have sufficient permissions to manage environment security.",t.Resources.OkButtonText="OK",t.Resources.SpnAuthorizationFailedError="Authorization failed",function(e){function o(e,t,o){return function(){if(void 0===o)return t.apply(e,arguments);{let i=Array.prototype.slice.call(arguments,0);return o instanceof Array?i=i.concat(o):i.push(o),t.apply(e,i)}}}s=t.DelayedFunction={},Object.defineProperty(t,"__esModule",{value:!0}),t.DelayedFunction.delegate=o;t.DelayedFunction.DelayedFunction=class{constructor(e,t,i,n,s){this._invokeOnCooldownComplete=!1,this._interval=t,this._name=i,this._func=o(e,n,s)}start(){let e=this;this._timeoutHandle||(this._timeoutHandle=window.setTimeout(function(){delete e._timeoutHandle;try{e._invoke.call(e)}finally{}},this._interval))}reset(){this.cancel(),this.start()}cancel(e=!1){this._timeoutHandle&&(window.clearTimeout(this._timeoutHandle),delete this._timeoutHandle),e&&this.clearCooldown(),this._invokeOnCooldownComplete=!1}clearCooldown(e=!0){this._cooldownHandle&&(window.clearTimeout(this._cooldownHandle),delete this._cooldownHandle),!e&&this.invokeOnCooldownComplete&&this.invokeNow()}extendCooldown(){this._startCooldown()}invokeNow(){this.cancel(),this._invoke()}setDelay(e){this._interval=e}setMethod(e,t,i){this._func=o(e,t,i)}isPending(){return!!this._timeoutHandle}isCoolingDown(){return!!this._cooldownHandle}invokeOnCooldownComplete(){this._invokeOnCooldownComplete=!0}_invoke(){this._func(),this._startCooldown()}_startCooldown(){this._cooldownHandle&&window.clearTimeout(this._cooldownHandle),this._cooldownHandle=window.setTimeout(()=>{delete this._cooldownHandle,this._invokeOnCooldownComplete&&(this.invokeNow(),this._invokeOnCooldownComplete=!1)},this._interval)}}}(),function(e){t.AadAuthorizer={},Object.defineProperty(t,"__esModule",{value:!0});const a="WebAccess.AutoCreateServicePrincipalCompleteCallbackByAuthcode";t.AadAuthorizer.AadAuthorizer=class{constructor(e){this._pageContext=e,this._distributedTaskClient=o.getTaskAgentClient(e)}getAccessTokenKey(e,t,o,n,s){return new Promise((o,r)=>{if(n)o(n);else if(e){let n=e.id;void 0===typeof window&&r("");let l=window.location.origin+e.url;const u=i.isFeatureFlagEnabled(this._pageContext,a,!0);l+=u?"/_admin/_services/completecallbackbyauthcode":"/_admin/_services/completecallback",null!=s&&(l+="?endpointId="+s+"&projectId="+n),this.authorize(t,l,3,"",u).then(e=>{o(e)},e=>{r(e)})}else r("")})}authorize(e,t,o,n,s,a){return new Promise((r,l)=>{if(this._pageContext.getService("IVssPageService").getData().isDevfabric&&i.isFeatureFlagEnabled(this._pageContext,"VisualStudio.Services.UseProdAzureResourcesOnDevFabric",!1))return r("");this._getAadOAuthLoginUrl(e,t,o,n,s,a).then(e=>{if(e=e.value||e,this.authWindow=window.open(e,"","width = 960, height = 600, location = true, menubar = false, toolbar = false"),""!==n)return r("");this._pollAuthWindow().then(e=>r(e),e=>l(e))},e=>l(e))})}_pollAuthWindow(){return new Promise((e,t)=>{this._monitorAuthProgress=new s.DelayedFunction(this,1e3,"monitorAuthProgress",()=>{try{if(this.authWindow)if(this.authWindow.closed)t(""),this._cleanupAuthWindow();else try{this.authWindow.vstsaadoauthcompleted?(this.authWindow.vstsaadoautherrormessage?t(this.authWindow.vstsaadoautherrormessage):this.authWindow.vstsaadoauthaccesstokenkey?e(this.authWindow.vstsaadoauthaccesstokenkey):t(n.SpnAuthorizationFailedError),this._cleanupAuthWindow()):this._monitorAuthProgress.reset()}catch(e){this._monitorAuthProgress.reset()}else t(n.CouldNotAuthenticateAAD),this._cleanupAuthWindow()}catch(e){t(e),this._cleanupAuthWindow()}}),this._monitorAuthProgress.start()})}_cleanupAuthWindow(){if(this.authWindow)try{this.authWindow.close(),this.authWindow=null}catch(e){}this._monitorAuthProgress&&(this._monitorAuthProgress.cancel(),delete this._monitorAuthProgress)}_getAadOAuthLoginUrl(e,t,o,i="",n=!1,s){return s?Promise.resolve(s):this._distributedTaskClient.createAadOAuthRequest(e,t,o,i,n)}}}()},["Resources","DelayedFunction","AadAuthorizer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.common.aad-authorizer"}}));